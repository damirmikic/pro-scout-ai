<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro Scout AI - Player Analysis</title>
    <!-- FAVICON -->
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cg fill='none' stroke-linecap='round'%3E%3Ccircle cx='45' cy='45' r='30' stroke='%2338bdf8' stroke-width='10'/%3E%3Cline x1='65' y1='65' x2='85' y2='85' stroke='%239ca3af' stroke-width='12'/%3E%3C/g%3E%3Cg fill='%232dd4bf'%3E%3Crect x='30' y='40' width='8' height='20' rx='2'/%3E%3Crect x='41' y='30' width='8' height='30' rx='2'/%3E%3Crect x='52' y='35' width='8' height='25' rx='2'/%3E%3C/g%3E%3C/svg%3E" type="image/svg+xml">
    
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Load Lucide icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Load Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Load PDF generation libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        /* Custom scrollbar for webkit browsers */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1e293b; /* slate-800 */
        }
        ::-webkit-scrollbar-thumb {
            background: #475569; /* slate-600 */
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #64748b; /* slate-500 */
        }

        /* Styling for the PDF preview modal */
        #pdfPreviewModal iframe {
            width: 100%;
            height: 70vh;
            border: 1px solid #475569; /* slate-600 */
        }

        /* Class to hide elements during PDF generation */
        .pdf-hide {
            display: none !important;
        }
        
        /* A4 page styles for the hidden PDF generation element */
        @media print {
            body, html {
                height: auto;
            }
            .a4-page {
                page-break-after: always;
            }
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-300 font-sans antialiased">

    <!-- Main Container -->
    <div class="flex flex-col min-h-screen">

        <!-- Header -->
        <header class="bg-slate-800/50 backdrop-blur-sm shadow-lg sticky top-0 z-50">
            <nav class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <div class="flex items-center">
                        <i data-lucide="shield-check" class="text-sky-400 h-8 w-8 mr-3"></i>
                        <h1 class="text-2xl font-bold text-white">Pro Scout AI</h1>
                    </div>
                    <button id="howToUseBtn" class="flex items-center bg-sky-500 hover:bg-sky-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                        <i data-lucide="help-circle" class_="h-5 w-5 mr-2"></i>
                        <span class="hidden sm:inline">How to Use</span>
                    </button>
                </div>
            </nav>
            <!-- Tab Navigation -->
            <div class="bg-slate-800 border-t border-slate-700">
                <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="flex space-x-2 sm:space-x-4 overflow-x-auto" style="-ms-overflow-style: none; scrollbar-width: none;">
                        <button class="tab-btn" data-tab="singlePlayer">
                            <i data-lucide="user" class="h-4 w-4 mr-2"></i>Single Player
                        </button>
                        <button class="tab-btn" data-tab="comparison">
                            <i data-lucide="users" class="h-4 w-4 mr-2"></i>Comparison
                        </button>
                        <button class="tab-btn" data-tab="opposition">
                            <i data-lucide="shield-off" class="h-4 w-4 mr-2"></i>Opposition
                        </button>
                        <button class="tab-btn" data-tab="search">
                            <i data-lucide="search" class="h-4 w-4 mr-2"></i>Advanced Search
                        </button>
                        <button class="tab-btn" data-tab="chatbot">
                            <i data-lucide="bot" class="h-4 w-4 mr-2"></i>AI Chatbot
                        </button>
                        <button class="tab-btn" data-tab="resources">
                            <i data-lucide="book-open" class="h-4 w-4 mr-2"></i>Resources
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="container mx-auto p-4 sm:p-6 lg:p-8 flex-grow">

            <!-- TAB: Single Player Analysis -->
            <div id="singlePlayerTab" class="tab-content grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Left Column: Inputs -->
                <div class="flex flex-col space-y-6">
                    <!-- Player Info -->
                    <div class="bg-slate-800 p-5 rounded-lg shadow-lg">
                        <h2 class="text-xl font-semibold text-white mb-4">1. Player Information</h2>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <input id="playerName" type="text" placeholder="Player Name (e.g., Arda Güler)" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-sky-500">
                            <input id="playerAge" type="number" placeholder="Age (e.g., 19)" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-sky-500">
                            <input id="playerClub" type="text" placeholder="Club (e.g., Real Madrid)" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-sky-500">
                            <input id="playerLeague" type="text" placeholder="League (e.g., La Liga)" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-sky-500">
                            <input id="playerPositions" type="text" placeholder="Position(s) (e.g., CAM, RW)" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-sky-500">
                            <input id="matchContext" type="text" placeholder="Match Context (e.g., vs. Barcelona)" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-sky-500">
                        </div>
                    </div>
                    
                    <!-- Report Type -->
                    <div class="bg-slate-800 p-5 rounded-lg shadow-lg">
                        <h2 class="text-xl font-semibold text-white mb-4">2. Report Type</h2>
                        <select id="reportType" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-sky-500">
                            <option value="quick">Quick Report (7-Point Analysis)</option>
                            <option value="pro">Pro Scout Report (Professional Template)</option>
                        </select>
                    </div>

                    <!-- Image Upload -->
                    <div class="bg-slate-800 p-5 rounded-lg shadow-lg">
                        <h2 class="text-xl font-semibold text-white mb-4">3. Upload Heatmap & Stats Images</h2>
                        <div id="dropZoneSingle" class="flex flex-col items-center justify-center w-full h-48 border-2 border-slate-600 border-dashed rounded-lg cursor-pointer bg-slate-700/50 hover:bg-slate-700 transition">
                            <div class="flex flex-col items-center justify-center pt-5 pb-6">
                                <i data-lucide="upload-cloud" class="w-10 h-10 mb-3 text-slate-400"></i>
                                <p class="mb-2 text-sm text-slate-400"><span class="font-semibold">Click to upload,</span> drag & drop, or paste</p>
                                <p class="text-xs text-slate-500">PNG, JPG, or WEBP (Multi-paste enabled)</p>
                            </div>
                            <input id="fileUploadSingle" type="file" class="hidden" multiple accept="image/png, image/jpeg, image/webp">
                        </div>
                        <div id="imagePreviewSingle" class="mt-4 grid grid-cols-2 sm:grid-cols-3 gap-4"></div>
                        <button id="scanStatsBtn" class="mt-4 w-full flex items-center justify-center bg-teal-500 hover:bg-teal-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                            <i data-lucide="scan-eye" class="h-5 w-5 mr-2"></i>
                            Scan Images for Stats
                        </button>
                    </div>

                    <!-- Text Stats -->
                    <div class="bg-slate-800 p-5 rounded-lg shadow-lg">
                        <h2 class="text-xl font-semibold text-white mb-4">4. Paste Additional Stats</h2>
                        <textarea id="textStatsSingle" rows="6" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-sky-500" placeholder="Paste stats here (e.g., Goals: 1, Tackles: 3/4, Pass Accuracy: 88%)..."></textarea>
                        <button id="visualizeStatsBtn" class="mt-4 w-full flex items-center justify-center bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 disabled:opacity-50" disabled>
                            <i data-lucide="bar-chart-3" class="h-5 w-5 mr-2"></i>
                            Visualize Text Stats
                        </button>
                        <div class="mt-4">
                            <canvas id="statsChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Right Column: Output -->
                <div class="flex flex-col space-y-6">
                    <div class="bg-slate-800 p-5 rounded-lg shadow-lg sticky top-[128px]"> <!-- 128px = header + tabs height -->
                        <h2 class="text-xl font-semibold text-white mb-4">Scouting Report</h2>
                        <div class="flex items-center space-x-2 mb-4">
                            <button id="analyzeBtn" class="flex-1 flex items-center justify-center bg-sky-500 hover:bg-sky-600 text-white font-bold py-3 px-6 rounded-lg transition duration-200">
                                <i data-lucide="sparkles" class="h-5 w-5 mr-2"></i>
                                Analyze Player
                            </button>
                            <button id="clearBtn" class="flex-1 flex items-center justify-center bg-red-500 hover:bg-red-600 text-white font-semibold py-3 px-6 rounded-lg transition duration-200">
                                <i data-lucide="trash-2" class="h-5 w-5 mr-2"></i>
                                Clear All
                            </button>
                        </div>
                        
                        <!-- API Key Input -->
                        <div id="apiKeySection" class="mb-4">
                            <label for="apiKey" class="block text-sm font-medium text-slate-300 mb-1">Optional API Key</label>
                            <div class="flex space-x-2">
                                <input type="password" id="apiKey" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-2 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-sky-500" placeholder="Enter your Gemini API key">
                                <button id="saveApiKeyBtn" class="bg-teal-500 hover:bg-teal-600 text-white px-3 py-2 rounded-lg" title="Save Key">
                                    <i data-lucide="save" class="h-5 w-5"></i>
                                </button>
                            </div>
                            <div id="apiKeyMessage" class="text-sm text-teal-400 mt-2 hidden"></div>
                        </div>

                        <!-- Export Buttons -->
                        <div id="exportButtons" class="hidden flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2 mb-4">
                            <button id="copyBtn" class="flex-1 flex items-center justify-center bg-slate-600 hover:bg-slate-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                                <i data-lucide="clipboard" class="h-5 w-5 mr-2"></i>Copy
                            </button>
                            <button id="pdfBtn" class="flex-1 flex items-center justify-center bg-slate-600 hover:bg-slate-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                                <i data-lucide="file-text" class="h-5 w-5 mr-2"></i>Preview PDF
                            </button>
                            <button id="videoBtn" class="flex-1 flex items-center justify-center bg-slate-600 hover:bg-slate-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                                <i data-lucide="youtube" class="h-5 w-5 mr-2"></i>Find Videos
                            </button>
                        </div>

                        <!-- Analysis Output -->
                        <div id="analysisOutput" class="w-full h-[60vh] overflow-y-auto bg-slate-900 border border-slate-700 rounded-lg p-4 prose prose-invert prose-slate max-w-none prose-h3:text-sky-300 prose-strong:text-white">
                            <p class="text-slate-400">Your analysis will appear here. Start by filling out the fields on the left and click "Analyze Player".</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB: Player Comparison -->
            <div id="comparisonTab" class="tab-content hidden">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Player 1 Column -->
                    <div class="flex flex-col space-y-6">
                        <div class="bg-slate-800 p-5 rounded-lg shadow-lg">
                            <h2 class="text-xl font-semibold text-white mb-4">Player 1</h2>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                                <input id="p1Name" type="text" placeholder="Player 1 Name" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-sky-500">
                                <input id="p1Age" type="number" placeholder="Age" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-sky-500">
                                <input id="p1Club" type="text" placeholder="Club" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-sky-500">
                                <input id="p1League" type="text" placeholder="League" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-sky-500">
                            </div>
                            <div id="dropZoneCompare1" class="flex flex-col items-center justify-center w-full h-40 border-2 border-slate-600 border-dashed rounded-lg cursor-pointer bg-slate-700/50 hover:bg-slate-700 transition">
                                <p class="text-slate-400">Upload P1 Images (Paste, Drag, Click)</p>
                            </div>
                            <input id="fileUploadCompare1" type="file" class="hidden" multiple accept="image/png, image/jpeg, image/webp">
                            <div id="imagePreviewCompare1" class="mt-4 grid grid-cols-3 gap-2"></div>
                            <textarea id="textStatsCompare1" rows="4" class="mt-4 w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-sky-500" placeholder="Paste Player 1's stats..."></textarea>
                        </div>
                    </div>
                    <!-- Player 2 Column -->
                    <div class="flex flex-col space-y-6">
                        <div class="bg-slate-800 p-5 rounded-lg shadow-lg">
                            <h2 class="text-xl font-semibold text-white mb-4">Player 2</h2>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                                <input id="p2Name" type="text" placeholder="Player 2 Name" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-sky-500">
                                <input id="p2Age" type="number" placeholder="Age" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-sky-500">
                                <input id="p2Club" type="text" placeholder="Club" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-sky-500">
                                <input id="p2League" type="text" placeholder="League" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-sky-500">
                            </div>
                            <div id="dropZoneCompare2" class="flex flex-col items-center justify-center w-full h-40 border-2 border-slate-600 border-dashed rounded-lg cursor-pointer bg-slate-700/50 hover:bg-slate-700 transition">
                                <p class="text-slate-400">Upload P2 Images (Paste, Drag, Click)</p>
                            </div>
                            <input id="fileUploadCompare2" type="file" class="hidden" multiple accept="image/png, image/jpeg, image/webp">
                            <div id="imagePreviewCompare2" class="mt-4 grid grid-cols-3 gap-2"></div>
                            <textarea id="textStatsCompare2" rows="4" class="mt-4 w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-sky-500" placeholder="Paste Player 2's stats..."></textarea>
                        </div>
                    </div>
                </div>
                <!-- Comparison Output -->
                <div class="mt-6 bg-slate-800 p-5 rounded-lg shadow-lg">
                    <h2 class="text-xl font-semibold text-white mb-4">Head-to-Head Analysis</h2>
                    <div id="analysisOutputCompare" class="w-full h-[60vh] overflow-y-auto bg-slate-900 border border-slate-700 rounded-lg p-4 prose prose-invert prose-slate max-w-none prose-h3:text-sky-300">
                        <p class="text-slate-400">Your comparison will appear here. Add data for both players and click "Analyze Player" (on the right).</p>
                    </div>
                </div>
            </div>

            <!-- TAB: Opposition Analysis -->
            <div id="oppositionTab" class="tab-content hidden">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Inputs -->
                    <div class="flex flex-col space-y-6">
                        <div class="bg-slate-800 p-5 rounded-lg shadow-lg">
                            <h2 class="text-xl font-semibold text-white mb-4">1. Opposition Info</h2>
                            <input id="opponentName" type="text" placeholder="Opponent Team Name (e.g., Manchester City)" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-sky-500">
                        </div>
                        <div class="bg-slate-800 p-5 rounded-lg shadow-lg">
                            <h2 class="text-xl font-semibold text-white mb-4">2. Upload Formation, Heatmaps, etc.</h2>
                            <div id="dropZoneOpponent" class="flex flex-col items-center justify-center w-full h-48 border-2 border-slate-600 border-dashed rounded-lg cursor-pointer bg-slate-700/50 hover:bg-slate-700 transition">
                                <p class="text-slate-400">Upload Images (Paste, Drag, Click)</p>
                            </div>
                            <input id="fileUploadOpponent" type="file" class="hidden" multiple accept="image/png, image/jpeg, image/webp">
                            <div id="imagePreviewOpponent" class="mt-4 grid grid-cols-3 gap-2"></div>
                        </div>
                        <div class="bg-slate-800 p-5 rounded-lg shadow-lg">
                            <h2 class="text-xl font-semibold text-white mb-4">3. Paste Team Stats & Notes</h2>
                            <textarea id="textStatsOpponent" rows="6" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-sky-500" placeholder="Paste team stats, recent form, key players, tactical notes..."></textarea>
                        </div>
                    </div>
                    <!-- Output -->
                    <div class="bg-slate-800 p-5 rounded-lg shadow-lg">
                        <h2 class="text-xl font-semibold text-white mb-4">Tactical Report & Exploitation Plan</h2>
                        <div id="analysisOutputOpponent" class="w-full h-[60vh] overflow-y-auto bg-slate-900 border border-slate-700 rounded-lg p-4 prose prose-invert prose-slate max-w-none prose-h3:text-sky-300">
                            <p class="text-slate-400">Your opposition analysis will appear here. Add info and click "Analyze Player" (on the main tab).</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB: Advanced Player Search -->
            <div id="searchTab" class="tab-content hidden">
                <div class="bg-slate-800 p-5 rounded-lg shadow-lg">
                    <h2 class="text-xl font-semibold text-white mb-4">Advanced Player Search</h2>
                    <p class="text-slate-400 mb-6">Use Google AI to find players based on your criteria. Not all fields are required.</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <input id="searchPosition" type="text" placeholder="Position (e.g., DM, Striker)" class="bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-sky-500">
                        <input id="searchAge" type="text" placeholder="Age (e.g., 18-22)" class="bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-sky-500">
                        <input id="searchNationality" type="text" placeholder="Nationality / Passport (e.g., EU)" class="bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-sky-500">
                        <input id="searchMarketValue" type="text" placeholder="Market Value (e.g., < €5m)" class="bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-sky-500">
                        <input id="searchContract" type="text" placeholder="Contract Expires (e.g., < 1 year)" class="bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-sky-500">
                        <input id="searchMatches" type="text" placeholder="Matches Played (e.g., > 20)" class="bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-sky-500">
                        <input id="searchLeague" type="text" placeholder="Suitable for League (e.g., Serie A)" class="bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-sky-500">
                        <textarea id="searchStats" rows="3" class="md:col-span-2 lg:col-span-3 bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-sky-500" placeholder="Specific Stats (e.g., > 5 goals, > 80% pass accuracy, high pressing stats)..."></textarea>
                    </div>
                    <button id="searchButton" class="mt-6 w-full flex items-center justify-center bg-sky-500 hover:bg-sky-600 text-white font-bold py-3 px-6 rounded-lg transition duration-200">
                        <i data-lucide="search" class="h-5 w-5 mr-2"></i>
                        Search Players
                    </button>
                </div>
                <!-- Search Results -->
                <div class="mt-6 bg-slate-800 p-5 rounded-lg shadow-lg">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold text-white">Search Results</h2>
                        <button id="downloadCsvBtn" class="hidden bg-teal-500 hover:bg-teal-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                            <i data-lucide="download" class="h-5 w-5 mr-2"></i>Download CSV
                        </button>
                    </div>
                    <div id="searchError" class="hidden text-red-400 p-3 bg-red-900/50 rounded-lg mb-4"></div>
                    <div id="searchResults" class="w-full h-[60vh] overflow-auto bg-slate-900 border border-slate-700 rounded-lg p-4">
                        <p class="text-slate-400">Your search results will appear here.</p>
                    </div>
                </div>
            </div>
            
            <!-- TAB: Scout AI Chatbot -->
            <div id="chatbotTab" class="tab-content hidden">
                <div class="bg-slate-800 p-5 rounded-lg shadow-lg max-w-4xl mx-auto">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold text-white">Scout AI Chatbot</h2>
                        <button id="newChatBtn" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-3 rounded-lg transition duration-200">
                            <i data-lucide="plus" class="h-5 w-5 mr-1"></i>New Chat
                        </button>
                    </div>
                    <p class="text-slate-400 mb-4">Ask real-time, scout-related questions. Powered by Google Search.</p>
                    <div id="chatWindow" class="w-full h-[60vh] overflow-y-auto bg-slate-900 border border-slate-700 rounded-lg p-4 mb-4 space-y-4">
                        <!-- Chat messages will appear here -->
                        <div class="p-3 bg-slate-700 rounded-lg max-w-3/4">
                            <p class="font-semibold text-sky-300 mb-1">Scout AI</p>
                            <p>Hi! Ask me anything, like "What is the tactical style of Brighton?" or "Summarize Lamine Yamal's stats this season."</p>
                        </div>
                    </div>
                    <div class="flex space-x-2">
                        <input id="chatInput" type="text" placeholder="Ask a question..." class="flex-grow bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-sky-500">
                        <button id="chatSendBtn" class="bg-sky-500 hover:bg-sky-600 text-white font-bold p-3 rounded-lg transition duration-200">
                            <i data-lucide="send" class="h-6 w-6"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- TAB: Resources -->
            <div id="resourcesTab" class="tab-content hidden">
                <div class="bg-slate-800 p-6 rounded-lg shadow-lg max-w-4xl mx-auto prose prose-invert prose-slate max-w-none prose-h3:text-sky-300 prose-a:text-teal-400 hover:prose-a:text-teal-300">
                    <h2 class="text-2xl font-semibold text-white mb-4">Scouting Resources</h2>
                    <p>A curated list of public resources to help with data collection and tactical analysis.</p>

                    <h3>Data & Statistics Websites</h3>
                    <ul>
                        <li><a href="https://www.sofascore.com" target="_blank">Sofascore</a> - Great for live stats, player ratings, and heatmaps.</li>
                        <li><a href="https://fbref.com" target="_blank">FBref</a> - The most comprehensive public database for advanced football statistics.</li>
                        <li><a href="https://www.transfermarkt.com" target="_blank">Transfermarkt</a> - Best for market values, contract info, and transfer rumors.</li>
                        <li><a href="https://www.whoscored.com" target="_blank">WhoScored</a> - Good for statistical-based player ratings and team characteristics.</li>
                    </ul>

                    <h3>Tactical Analysis & Long-Form</h3>
                    <ul>
                        <li><a href="https://www.thecoachesvoice.com" target="_blank">The Coaches' Voice</a> - High-level analysis from professional coaches.</li>
                        <li><a href="https://breakingthelines.com" target="_blank">Breaking the Lines</a> - Excellent long-form tactical profiles and analysis.</li>
                        <li><a href="https://totalfootballanalysis.com" target="_blank">Total Football Analysis</a> - In-depth tactical breakdowns and scout reports.</li>
                    </ul>

                    <h3>Public Scouting Guides & Books (PDFs)</h3>
                    <ul>
                        <li><a href="https://www.google.com/search?q=introduction+to+football+scouting+pdf" target="_blank">Introduction to Football Scouting (Search)</a> - Search for introductory guides on the principles of scouting.</li>
                        <li><a href="https://www.google.com/search?q=talent+identification+in+football+pdf" target="_blank">Talent Identification in Football (Search)</a> - Find academic papers and guides on T.I.D. models.</li>
                        <li><a href="https://www.google.com/search?q=pfsa+scouting+resources" target="_blank">PFSA (Professional Football Scouts Association) Resources</a> - Look for free articles and resources from professional scouting organizations.</li>
                    </ul>
                </div>
            </div>

        </main>
    </div>

    <!-- Loading Spinner Overlay -->
    <div id="loadingSpinner" class="hidden fixed inset-0 bg-slate-900/80 backdrop-blur-sm flex items-center justify-center z-[100]">
        <div class="flex flex-col items-center">
            <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-sky-500"></div>
            <p id="loadingText" class="text-white text-xl mt-4">Analyzing...</p>
        </div>
    </div>

    <!-- Error Modal -->
    <div id="errorModal" class="hidden fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-[101] flex items-center justify-center p-4">
        <div class="bg-slate-800 rounded-lg shadow-2xl max-w-md w-full p-6 border border-red-500/50">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-2xl font-bold text-red-400">Analysis Error</h3>
                <button id="closeErrorBtn" class="text-slate-400 hover:text-white">&times;</button>
            </div>
            <div classs="max-h-60 overflow-y-auto">
                <p id="errorMessage" class="text-slate-300">An unknown error occurred.</p>
            </div>
        </div>
    </div>
    
    <!-- "How to Use" Modal -->
    <div id="howToUseModal" class="hidden fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-[100] flex items-center justify-center p-4">
        <div class="bg-slate-800 rounded-lg shadow-2xl max-w-2xl w-full border border-slate-700">
            <div class="flex items-center justify-between p-5 border-b border-slate-700">
                <h3 class="text-2xl font-bold text-white">How to Use Pro Scout AI</h3>
                <button id="closeHowToUseBtn" class="text-slate-400 hover:text-white p-1 rounded-full hover:bg-slate-700">
                    <i data-lucide="x" class="h-6 w-6"></i>
                </button>
            </div>
            <div class="p-6 max-h-[70vh] overflow-y-auto prose prose-invert prose-slate max-w-none prose-h4:text-sky-300">
                <h4>Single Player Analysis</h4>
                <ol>
                    <li>Fill in the <strong>Player Information</strong>.</li>
                    <li>Select a <strong>Report Type</strong> (Quick or Pro).</li>
                    <li>Upload heatmap/stats images (you can drag, click, or paste).</li>
                    <li>Click <strong>"Scan Images for Stats"</strong> to let the AI read stats from your images.</li>
                    <li>(Optional) Add more stats to the <strong>"Paste Additional Stats"</strong> box. Click <strong>"Visualize"</strong> to see a chart.</li>
                    <li>Click <strong>"Analyze Player"</strong>. The AI will generate a report.</li>
                    <li>Once complete, you can <strong>Copy</strong>, <strong>Preview PDF</strong> (with download), or <strong>Find Videos</strong>.</li>
                </ol>
                
                <h4>Player Comparison</h4>
                <ol>
                    <li>Add info, images, and stats for <strong>Player 1</strong> and <strong>Player 2</strong>.</li>
                    <li>Go to the "Single Player" tab and click the <strong>"Analyze Player"</strong> button (it controls all analyses).</li>
                    <li>Your Head-to-Head report will appear.</li>
                </ol>
                
                <h4>Opposition Analysis</h4>
                <ol>
                    <li>Add the opponent's name, tactical images, and team stats.</li>
                    <li>Click the <strong>"Analyze Player"</strong> button.</li>
                    <li>A tactical report and exploitation plan will be generated.</li>
                </ol>

                <h4>Advanced Player Search</h4>
                <ol>
                    <li>Fill in any criteria you want to search for. "Suitable for League" is for potential/style, not their current league.</li>
                    <li>Click <strong>"Search Players"</strong>. The AI will use Google Search to find real players.</li>
                    <li>Results will appear in a table. You can then <strong>Download CSV</strong>.</li>
                </ol>

                <h4>Scout AI Chatbot</h4>
                <ol>
                    <li>Ask any scout-related question (e.g., "What is Man City's tactical style?", "Summarize Arda Güler's season").</li>
                    <li>The AI will use Google Search to give you a real-time, up-to-date answer.</li>
                    <li>Click <strong>"New Chat"</strong> to clear the history.</li>
                </ol>

                <h4>API Key</h4>
                <p>The app will try to use a built-in key. If it fails, you can enter your own Google Gemini API key in the <strong>"Optional API Key"</strong> field. Click "Save Key" to save it to your browser for next time.</p>
            </div>
        </div>
    </div>

    <!-- PDF Preview Modal -->
    <div id="pdfPreviewModal" class="hidden fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-[101] flex items-center justify-center p-4">
        <div class="bg-slate-800 rounded-lg shadow-2xl max-w-4xl w-full p-6 border border-slate-700">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-2xl font-bold text-white">PDF Preview</h3>
                <button id="closePdfPreviewBtn" class="text-slate-400 hover:text-white p-1 rounded-full hover:bg-slate-700">
                    <i data-lucide="x" class="h-6 w-6"></i>
                </button>
            </div>
            <iframe id="pdfPreviewFrame" class="bg-white rounded" title="PDF Preview"></iframe>
            <button id="downloadPdfBtn" class="mt-4 w-full flex items-center justify-center bg-sky-500 hover:bg-sky-600 text-white font-bold py-3 px-6 rounded-lg transition duration-200">
                <i data-lucide="download" class="h-5 w-5 mr-2"></i>Download PDF
            </button>
        </div>
    </div>

    <!-- Hidden element for PDF generation -->
    <div id="pdf-content" class="a4-page" style="position: absolute; left: -9999px; width: 210mm; font-family: 'Times New Roman', serif; color: black; background: white;">
        <!-- This will be populated by JS -->
    </div>


    <script type="module">
        // Initialize Lucide icons
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        } else {
            console.error("Lucide icons script not loaded.");
        }

        // Get global variables from environment (if they exist)
        const APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'default-pro-scout-ai';
        
        // --- DOM Elements ---
        const tabButtons = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const clearBtn = document.getElementById('clearBtn');
        const apiKeyInput = document.getElementById('apiKey');
        const saveApiKeyBtn = document.getElementById('saveApiKeyBtn');
        const apiKeyMessage = document.getElementById('apiKeyMessage');
        const apiKeySection = document.getElementById('apiKeySection');
        
        // Modals
        const howToUseBtn = document.getElementById('howToUseBtn');
        const howToUseModal = document.getElementById('howToUseModal');
        const closeHowToUseBtn = document.getElementById('closeHowToUseBtn');
        const errorModal = document.getElementById('errorModal');
        const closeErrorBtn = document.getElementById('closeErrorBtn');
        const errorMessage = document.getElementById('errorMessage');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const loadingText = document.getElementById('loadingText');

        // PDF Modal
        const pdfBtn = document.getElementById('pdfBtn');
        const pdfPreviewModal = document.getElementById('pdfPreviewModal');
        const closePdfPreviewBtn = document.getElementById('closePdfPreviewBtn');
        const pdfPreviewFrame = document.getElementById('pdfPreviewFrame');
        const downloadPdfBtn = document.getElementById('downloadPdfBtn');
        let generatedPdfBlobUrl = null;

        // Export Buttons
        const exportButtons = document.getElementById('exportButtons');
        const copyBtn = document.getElementById('copyBtn');
        const videoBtn = document.getElementById('videoBtn');
        
        // --- Single Player Tab ---
        const playerName = document.getElementById('playerName');
        const playerAge = document.getElementById('playerAge');
        const playerClub = document.getElementById('playerClub');
        const playerLeague = document.getElementById('playerLeague');
        const playerPositions = document.getElementById('playerPositions');
        const matchContext = document.getElementById('matchContext');
        const reportType = document.getElementById('reportType');
        const dropZoneSingle = document.getElementById('dropZoneSingle');
        const fileUploadSingle = document.getElementById('fileUploadSingle');
        const imagePreviewSingle = document.getElementById('imagePreviewSingle');
        const textStatsSingle = document.getElementById('textStatsSingle');
        const analysisOutput = document.getElementById('analysisOutput');
        const scanStatsBtn = document.getElementById('scanStatsBtn');
        const visualizeStatsBtn = document.getElementById('visualizeStatsBtn');
        const statsChartCanvas = document.getElementById('statsChart');
        let statsChart = null;
        let singlePlayerImages = []; // Store base64 images

        // --- Comparison Tab ---
        const dropZoneCompare1 = document.getElementById('dropZoneCompare1');
        const fileUploadCompare1 = document.getElementById('fileUploadCompare1');
        const imagePreviewCompare1 = document.getElementById('imagePreviewCompare1');
        const textStatsCompare1 = document.getElementById('textStatsCompare1');
        const p1Name = document.getElementById('p1Name');
        const p1Age = document.getElementById('p1Age');
        const p1Club = document.getElementById('p1Club');
        const p1League = document.getElementById('p1League');
        let compare1Images = [];
        
        const dropZoneCompare2 = document.getElementById('dropZoneCompare2');
        const fileUploadCompare2 = document.getElementById('fileUploadCompare2');
        const imagePreviewCompare2 = document.getElementById('imagePreviewCompare2');
        const textStatsCompare2 = document.getElementById('textStatsCompare2');
        const p2Name = document.getElementById('p2Name');
        const p2Age = document.getElementById('p2Age');
        const p2Club = document.getElementById('p2Club');
        const p2League = document.getElementById('p2League');
        let compare2Images = [];
        const analysisOutputCompare = document.getElementById('analysisOutputCompare');
        
        // --- Opposition Tab ---
        const opponentName = document.getElementById('opponentName');
        const dropZoneOpponent = document.getElementById('dropZoneOpponent');
        const fileUploadOpponent = document.getElementById('fileUploadOpponent');
        const imagePreviewOpponent = document.getElementById('imagePreviewOpponent');
        const textStatsOpponent = document.getElementById('textStatsOpponent');
        const analysisOutputOpponent = document.getElementById('analysisOutputOpponent');
        let opponentImages = [];

        // --- Search Tab ---
        const searchButton = document.getElementById('searchButton');
        const searchResults = document.getElementById('searchResults');
        const searchError = document.getElementById('searchError');
        const searchPosition = document.getElementById('searchPosition');
        const searchAge = document.getElementById('searchAge');
        const searchNationality = document.getElementById('searchNationality');
        const searchMarketValue = document.getElementById('searchMarketValue');
        const searchContract = document.getElementById('searchContract');
        const searchMatches = document.getElementById('searchMatches');
        const searchLeague = document.getElementById('searchLeague');
        const searchStats = document.getElementById('searchStats');
        const downloadCsvBtn = document.getElementById('downloadCsvBtn');
        let csvContent = "";
        
        // --- Chatbot Tab ---
        const chatWindow = document.getElementById('chatWindow');
        const chatInput = document.getElementById('chatInput');
        const chatSendBtn = document.getElementById('chatSendBtn');
        const newChatBtn = document.getElementById('newChatBtn');
        let chatHistory = [];

        // --- State ---
        let currentTab = 'singlePlayer';
        let userApiKey = "";

        // --- Utility Functions ---

        function showLoading(text = "Analyzing...") {
            loadingText.textContent = text;
            loadingSpinner.classList.remove('hidden');
        }

        function hideLoading() {
            loadingSpinner.classList.add('hidden');
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorModal.classList.remove('hidden');
            hideLoading();
        }

        function closeError() {
            errorModal.classList.add('hidden');
        }

        function showHowToUse() {
            howToUseModal.classList.remove('hidden');
        }

        function closeHowToUse() {
            howToUseModal.classList.add('hidden');
        }
        
        function showPdfPreview() {
            pdfPreviewModal.classList.remove('hidden');
        }

        function closePdfPreview() {
            pdfPreviewModal.classList.add('hidden');
            if (generatedPdfBlobUrl) {
                URL.revokeObjectURL(generatedPdfBlobUrl);
                generatedPdfBlobUrl = null;
            }
            pdfPreviewFrame.src = 'about:blank';
        }

        function showTab(tabId) {
            // Hide all content
            tabContents.forEach(content => content.classList.add('hidden'));
            
            // Deactivate all buttons
            tabButtons.forEach(button => {
                button.classList.remove('border-sky-400', 'text-white');
                button.classList.add('border-transparent', 'text-slate-400', 'hover:text-white');
            });

            // Show selected content
            const contentToShow = document.getElementById(tabId + 'Tab');
            if (contentToShow) {
                contentToShow.classList.remove('hidden');
            }

            // Activate selected button
            const buttonToActivate = document.querySelector(`.tab-btn[data-tab="${tabId}"]`);
            if (buttonToActivate) {
                buttonToActivate.classList.add('border-sky-400', 'text-white');
                buttonToActivate.classList.remove('border-transparent', 'text-slate-400');
            }
            
            // Toggle visibility of analysis button and API key
            const analysisControlsTabs = ['singlePlayer', 'comparison', 'opposition'];
            const controlsToToggle = [analyzeBtn, clearBtn, apiKeySection];
            
            if (controlsToToggle.every(el => el)) { // Check if elements exist
                if (analysisControlsTabs.includes(tabId)) {
                    controlsToToggle.forEach(el => el.classList.remove('hidden'));
                } else {
                    controlsToToggle.forEach(el => el.classList.add('hidden'));
                }
            }

            currentTab = tabId;
        }

        // --- API Key Management ---
        function loadApiKey() {
            try {
                const savedKey = localStorage.getItem('geminiApiKey');
                if (savedKey) {
                    userApiKey = savedKey;
                    apiKeyInput.value = "******************";
                    apiKeyInput.disabled = true;
                    apiKeyMessage.innerHTML = 'Saved key loaded. <button id="clearApiKeyBtn" class="text-red-400 hover:underline">Clear Key</button>';
                    apiKeyMessage.classList.remove('hidden');
                    
                    document.getElementById('clearApiKeyBtn').addEventListener('click', () => {
                        localStorage.removeItem('geminiApiKey');
                        userApiKey = "";
                        apiKeyInput.value = "";
                        apiKeyInput.disabled = false;
                        apiKeyMessage.classList.add('hidden');
                    });
                }
            } catch (e) {
                console.error("Could not load API key from LocalStorage:", e);
            }
        }

        function saveApiKey() {
            try {
                const key = apiKeyInput.value.trim();
                if (key) {
                    userApiKey = key;
                    localStorage.setItem('geminiApiKey', key);
                    apiKeyInput.value = "******************";
                    apiKeyInput.disabled = true;
                    apiKeyMessage.innerHTML = 'Key saved! <button id="clearApiKeyBtn" class="text-red-400 hover:underline">Clear Key</button>';
                    apiKeyMessage.classList.remove('hidden');
                    
                    document.getElementById('clearApiKeyBtn').addEventListener('click', () => {
                        localStorage.removeItem('geminiApiKey');
                        userApiKey = "";
                        apiKeyInput.value = "";
                        apiKeyInput.disabled = false;
                        apiKeyMessage.classList.add('hidden');
                    });
                }
            } catch (e) {
                console.error("Could not save API key to LocalStorage:", e);
                showError("Could not save API key. Your browser might be blocking LocalStorage.");
            }
        }

        // --- Image Upload Handling ---
        
        function setupUploadListeners(dropZone, fileInput, previewEl, imageArray) {
            if (!dropZone || !fileInput) return;

            // Click to upload
            dropZone.addEventListener('click', () => fileInput.click());
            
            // Drag and Drop
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('border-sky-500', 'bg-slate-700');
            });
            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('border-sky-500', 'bg-slate-700');
            });
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('border-sky-500', 'bg-slate-700');
                handleFiles(e.dataTransfer.files, previewEl, imageArray);
            });
            
            // File input change
            fileInput.addEventListener('change', (e) => {
                handleFiles(e.target.files, previewEl, imageArray);
            });

            // Paste
            dropZone.addEventListener('paste', (e) => {
                handlePaste(e, previewEl, imageArray);
            });
        }
        
        function handlePaste(e, previewEl, imageArray) {
            e.preventDefault(); // Prevent browser from opening pasted image
            const items = (e.clipboardData || e.originalEvent.clipboardData).items;
            if (!items) return;

            for (let i = 0; i < items.length; i++) {
                if (items[i].kind === 'file' && items[i].type.indexOf('image') !== -1) {
                    const blob = items[i].getAsFile();
                    if (blob) {
                        processFile(blob, previewEl, imageArray);
                    }
                }
            }
        }

        function handleFiles(files, previewEl, imageArray) {
            if (!files) return;
            for (const file of files) {
                if (file.type.startsWith('image/')) {
                    processFile(file, previewEl, imageArray);
                }
            }
        }

        function processFile(file, previewEl, imageArray) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const base64 = e.target.result;
                const mimeType = file.type;
                
                // Store base64 string without data prefix for the API
                const apiData = {
                    base64: base64.split(',')[1],
                    mimeType: mimeType
                };
                imageArray.push(apiData);

                // Update preview
                updateImagePreviews(previewEl, imageArray, base64);
            };
            reader.readAsDataURL(file); // Corrected method name
        }

        function updateImagePreviews(previewEl, imageArray, newImageBase64) {
            const div = document.createElement('div');
            div.classList.add('relative', 'group');
            
            const img = document.createElement('img');
            img.src = newImageBase64;
            img.classList.add('w-full', 'h-24', 'object-cover', 'rounded-lg', 'shadow-md');
            div.appendChild(img);
            
            const removeBtn = document.createElement('button');
            removeBtn.innerHTML = '&times;';
            removeBtn.classList.add('absolute', 'top-1', 'right-1', 'bg-red-600', 'text-white', 'rounded-full', 'w-5', 'h-5', 'flex', 'items-center', 'justify-center', 'text-xs', 'font-bold', 'opacity-0', 'group-hover:opacity-100', 'transition-opacity');
            removeBtn.onclick = () => {
                const b64Data = img.src.split(',')[1];
                const dataIndex = imageArray.findIndex(item => item.base64 === b64Data);
                
                if (dataIndex > -1) {
                    imageArray.splice(dataIndex, 1);
                }
                div.remove();
            };
            div.appendChild(removeBtn);
            
            previewEl.appendChild(div);
        }


        // --- Clear All Inputs ---
        function clearAllInputs() {
            // Single Player
            if(playerName) playerName.value = '';
            if(playerAge) playerAge.value = '';
            if(playerClub) playerClub.value = '';
            if(playerLeague) playerLeague.value = '';
            if(playerPositions) playerPositions.value = '';
            if(matchContext) matchContext.value = '';
            if(reportType) reportType.value = 'quick';
            if(imagePreviewSingle) imagePreviewSingle.innerHTML = '';
            singlePlayerImages = [];
            if(textStatsSingle) textStatsSingle.value = '';
            if(analysisOutput) analysisOutput.innerHTML = '<p class="text-slate-400">Analysis cleared.</p>';
            if (statsChart) {
                statsChart.destroy();
                statsChart = null;
            }
            if(visualizeStatsBtn) visualizeStatsBtn.disabled = true;

            // Comparison
            if(p1Name) p1Name.value = '';
            if(p1Age) p1Age.value = '';
            if(p1Club) p1Club.value = '';
            if(p1League) p1League.value = '';
            if(p2Name) p2Name.value = '';
            if(p2Age) p2Age.value = '';
            if(p2Club) p2Club.value = '';
            if(p2League) p2League.value = '';
            if(imagePreviewCompare1) imagePreviewCompare1.innerHTML = '';
            compare1Images = [];
            if(textStatsCompare1) textStatsCompare1.value = '';
            if(imagePreviewCompare2) imagePreviewCompare2.innerHTML = '';
            compare2Images = [];
            if(textStatsCompare2) textStatsCompare2.value = '';
            if(analysisOutputCompare) analysisOutputCompare.innerHTML = '<p class="text-slate-400">Comparison cleared.</p>';

            // Opposition
            if(opponentName) opponentName.value = '';
            if(imagePreviewOpponent) imagePreviewOpponent.innerHTML = '';
            opponentImages = [];
            if(textStatsOpponent) textStatsOpponent.value = '';
            if(analysisOutputOpponent) analysisOutputOpponent.innerHTML = '<p class="text-slate-400">Opposition analysis cleared.</p>';
            
            // Hide export buttons
            if(exportButtons) exportButtons.classList.add('hidden');
        }

        // --- Main Analysis Logic ---
        
        async function handleAnalysis() {
            switch(currentTab) {
                case 'singlePlayer':
                    await analyzeSinglePlayer();
                    break;
                case 'comparison':
                    await analyzeComparison();
                    break;
                case 'opposition':
                    await analyzeOpposition();
                    break;
            }
        }

        /**
         * Calls the Gemini API.
         * @param {Array<Object>} parts - The content parts (text and images).
         * @param {boolean} useGrounding - Whether to enable Google Search.
         * @returns {Promise<string>} - The generated text response.
         */
        async function callGeminiApi(parts, useGrounding = false) {
            const apiKey = userApiKey || (typeof __API_KEY__ !== 'undefined' ? __API_KEY__ : '');
            
            // Use the non-streaming endpoint
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-pro-latest:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{
                    role: "user",
                    parts: parts
                }],
                generationConfig: {
                    temperature: 0.3,
                    topP: 0.9,
                    topK: 10,
                }
            };

            if (useGrounding) {
                payload.tools = [{ "google_search": {} }];
            }

            let attempt = 0;
            const maxAttempts = 5;
            const baseDelay = 1000; // 1 second

            while (attempt < maxAttempts) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 429 || response.status >= 500) {
                            // Rate limit or server error, time to back off
                            throw new Error(`APIError ${response.status}: ${response.statusText}`);
                        }
                        // Other client-side error
                        const errorBody = await response.json();
                        console.error("API Error Body:", errorBody);
                        throw new Error(errorBody.error?.message || "An unknown API error occurred.");
                    }

                    const result = await response.json();
                    
                    if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts) {
                        return result.candidates[0].content.parts[0].text;
                    } else if (result.candidates && result.candidates[0].finishReason === "SAFETY") {
                        throw new Error("Analysis blocked by safety settings. The provided images or text may be sensitive.");
                    } else {
                        console.warn("Unexpected API response structure:", result);
                        throw new Error("Could not parse the AI's response.");
                    }

                } catch (error) {
                    attempt++;
                    if (error.message.startsWith("APIError") && attempt < maxAttempts) {
                        const delay = baseDelay * Math.pow(2, attempt) + Math.random() * 1000;
                        console.warn(`API error, retrying in ${Math.round(delay/1000)}s... (Attempt ${attempt}/${maxAttempts})`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                    } else {
                        // Final attempt failed or it's not a retriable error
                        console.error("Failed to call Gemini API:", error);
                        throw error; // Re-throw the last error
                    }
                }
            }
            // This line should not be reachable, but as a fallback:
            throw new Error("Failed to get a response from the AI after multiple attempts.");
        }
        
        /**
         * Calls the Gemini Vision API to scan stats from images.
         */
        async function scanStatsFromImage() {
            if (singlePlayerImages.length === 0) {
                showError("Please upload at least one image to scan for stats.");
                return;
            }

            showLoading("Scanning images for stats...");

            const parts = [
                { text: "Analyze the provided image(s). Extract any player statistics visible (e.g., Goals, Assists, Tackles, Pass Accuracy, etc.). Format them as a simple key-value list, like 'Goals: 1\nTackles: 3/4\nPass Accuracy: 88%'. Only return the extracted stats." }
            ];

            singlePlayerImages.forEach(img => {
                parts.push({
                    inlineData: {
                        mimeType: img.mimeType,
                        data: img.base64
                    }
                });
            });

            try {
                const extractedStats = await callGeminiApi(parts);
                textStatsSingle.value += (textStatsSingle.value ? '\n' : '') + extractedStats;
                if(visualizeStatsBtn) visualizeStatsBtn.disabled = false; // Enable visualization
            } catch (error) {
                showError(`Failed to scan stats: ${error.message}`);
            } finally {
                hideLoading();
            }
        }


        async function analyzeSinglePlayer() {
            showLoading("Generating single player analysis...");
            if(analysisOutput) analysisOutput.innerHTML = '';
            if(exportButtons) exportButtons.classList.add('hidden');

            const parts = [];
            const info = {
                name: playerName.value.trim(),
                age: playerAge.value.trim(),
                club: playerClub.value.trim(),
                league: playerLeague.value.trim(),
                positions: playerPositions.value.trim(),
                match: matchContext.value.trim(),
            };
            
            // --- Build the Prompt ---
            let prompt = "You are a world-class professional football scout. Analyze the provided data to create a scouting report.\n\n";
            prompt += "--- Player Information ---\n";
            prompt += `Name: ${info.name || 'N/A'}\n`;
            prompt += `Age: ${info.age || 'N/A'}\n`;
            prompt += `Club: ${info.club || 'N/A'}\n`;
            prompt += `League: ${info.league || 'N/A'}\n`;
            prompt += `Stated Position(s): ${info.positions || 'N/A'}\n`;
            prompt += `Match Context: ${info.match || 'N/A'}\n\n`;
            
            prompt += "--- Provided Stats (Text) ---\n";
            prompt += `${textStatsSingle.value.trim() || 'No text stats provided.'}\n\n`;
            
            prompt += "--- INSTRUCTIONS ---\n";
            prompt += "Analyze the heatmap images, stats images, and text data.\n";

            if (reportType.value === 'quick') {
                prompt += "Generate a 'Quick Report' using the following 7-point template. Be detailed and insightful for each section.\n";
                prompt += "# 1. AI-Calculated Performance Rating\n(Provide a rating (e.g., B+, 7.5/10) and 1-2 sentences justifying it based on the data.)\n";
                prompt += "# 2. Likely Position(s) & Role\n(Based on the heatmap and stats, what is their most likely position and tactical role? e.g., 'Deep-Lying Playmaker', 'Inverted Winger')\n";
                prompt += "# 3. Key Duties & Playstyle\n(Describe their main actions and style. e.g., 'Controls tempo, progressive passer, avoids 1v1 duels.')\n";
                prompt += "# 4. Key Strengths (Pros)\n(List 3-4 bullet points based on the data.)\n";
                prompt += "# 5. Key Weaknesses (Cons)\n(List 2-3 bullet points based on the data.)\n";
                prompt += "# 6. Suggested Similar Player\n(Suggest ONE well-known player with a similar playstyle and justify it.)\n";
                prompt += "# 7. Suggested Development Plan\n(Based on the 'Cons', suggest 2-3 actionable development points.)\n";
            } else {
                prompt += "Generate a 'Pro Scout Report' using the following 8-point professional template. Be extremely detailed, analytical, and use scouting terminology.\n\n";
                prompt += "# 1. AI-Calculated Performance Rating\n(Provide a rating (e.g., 'A- ' or '8.0/10') and a 1-2 sentence justification based *only* on the provided match data.)\n\n";
                prompt += "# 2. Summary (Overview)\n(A brief overview of the player's performance, role, key strengths, and areas for improvement.)\n\n";
                prompt += "# 3. Positional Play\n(Analyze positioning in Offensive, Defensive, and Transition phases based on the heatmap and stats.)\n\n";
                prompt += "# 4. Key Actions (PMDS Framework)\n(Break down their most critical actions using PMDS: Position, Moment, Direction, Speed. e.g., 'Pressing: Showed good speed to close down, but his direction was poor, opening a passing lane.')\n\n";
                prompt += "# 5. Tactical Awareness (Four Phases)\n(Assess their decision-making. Communication: Did they scan? Decision (What): Pass, dribble, shoot? Decision (How): Type of pass/dribble? Execution: Technical outcome.)\n\n";
                prompt += "# 6. Mentality\n(Infer qualities from the data. Work rate (from heatmap), Composure (from pass % under pressure), Leadership, etc.)\n\n";
                prompt += "# 7. Conclusion & Recommendation\n(Summarize potential, system suitability (e.g., 'Suits a high-press system'), and a final recommendation (e.g., 'Monitor', 'Sign').)\n\n";
                prompt += "# 8. Similar Player Matrix\n(Provide 4 player comparisons:\n- **Top 5 League:** [Player Name] (e.g., Premier League, La Liga)\n- **Mid-Tier League:** [Player Name] (e.g., Eredivisie, MLS, Championship)\n- **Current League:** [Player Name] (A top player in their *current* league)\n- **Historical:** [Player Name] (A retired player))\n";
            }
            
            parts.push({ text: prompt });

            // Add images
            if (singlePlayerImages.length === 0) {
                showError("Please upload at least one image for analysis.");
                hideLoading();
                return;
            }
            singlePlayerImages.forEach(img => {
                parts.push({
                    inlineData: {
                        mimeType: img.mimeType,
                        data: img.base64
                    }
                });
            });

            try {
                const resultText = await callGeminiApi(parts);
                displayResults(resultText, analysisOutput);
                if(exportButtons) exportButtons.classList.remove('hidden');
            } catch (error) {
                showError(`Analysis failed: ${error.message}`);
            } finally {
                hideLoading();
            }
        }
        
        async function analyzeComparison() {
            showLoading("Generating player comparison...");
            if(analysisOutputCompare) analysisOutputCompare.innerHTML = '';

            const parts = [];
            
            const p1Info = `Player 1: ${p1Name.value || 'P1'} (Age: ${p1Age.value || 'N/A'}, Club: ${p1Club.value || 'N/A'}, League: ${p1League.value || 'N/A'})`;
            const p2Info = `Player 2: ${p2Name.value || 'P2'} (Age: ${p2Age.value || 'N/A'}, Club: ${p2Club.value || 'N/A'}, League: ${p2League.value || 'N/A'})`;
            
            let prompt = `You are a professional scout. Create a Head-to-Head analysis of two players.\n\n${p1Info}\n${p2Info}\n\n--- INSTRUCTIONS ---\n`;
            prompt += "Analyze all the provided data for both players. Create a detailed comparison using the following template:\n\n";
            prompt += "# 1. Role & Playstyle Comparison\n(Describe and contrast their tactical roles and style of play.)\n\n";
            prompt += "# 2. Head-to-Head: Key Strengths\n(Compare their pros in a side-by-side manner.)\n\n";
            prompt += "# 3. Head-to-Head: Key Weaknesses\n(Compare their cons in a side-by-side manner.)\n\n";
            prompt += "# 4. Statistical Standout\n(Which player has the more impressive statistical profile and why?)\n\n";
            prompt += "# 5. Verdict & Recommendation\n(Conclude with a final summary of who is the better prospect or a better fit for a specific tactical system.)\n\n";
            
            prompt += "--- Player 1 Data ---\n";
            prompt += `Stats: ${textStatsCompare1.value.trim() || 'N/A'}\n\n`;
            prompt += "Player 1 Images (Heatmaps, Stats):\n";
            
            parts.push({ text: prompt });
            if (compare1Images.length === 0) parts.push({ text: "No images provided for Player 1."});
            compare1Images.forEach(img => {
                parts.push({ inlineData: { mimeType: img.mimeType, data: img.base64 } });
            });
            
            prompt = "\n--- Player 2 Data ---\n";
            prompt += `Stats: ${textStatsCompare2.value.trim() || 'N/A'}\n\n`;
            prompt += "Player 2 Images (Heatmaps, Stats):\n";
            
            parts.push({ text: prompt });
            if (compare2Images.length === 0) parts.push({ text: "No images provided for Player 2."});
            compare2Images.forEach(img => {
                parts.push({ inlineData: { mimeType: img.mimeType, data: img.base64 } });
            });

            try {
                const resultText = await callGeminiApi(parts);
                displayResults(resultText, analysisOutputCompare);
            } catch (error) {
                showError(`Comparison failed: ${error.message}`);
            } finally {
                hideLoading();
            }
        }
        
        async function analyzeOpposition() {
            showLoading("Generating opposition analysis...");
            if(analysisOutputOpponent) analysisOutputOpponent.innerHTML = '';
            
            const parts = [];
            let prompt = `You are a professional tactical analyst. Create an opposition scouting report for ${opponentName.value.trim() || 'the opponent'}.\n\n`;
            prompt += "--- Provided Data ---\n";
            prompt += `Stats/Notes: ${textStatsOpponent.value.trim() || 'N/A'}\n\n`;
            prompt += "--- INSTRUCTIONS ---\n";
            prompt += "Analyze the provided images (formations, heatmaps) and text notes. Generate a concise tactical report using this template:\n\n";
            prompt += "# 1. Tactical Setup & Playstyle\n(Describe their likely formation, style in possession, and defensive structure.)\n\n";
            prompt += "# 2. Key Strengths & Threats\n(List 3-4 key tactical strengths or dangerous players.)\n\n";
            prompt += "# 3. Key Weaknesses & Vulnerabilities\n(List 2-3 exploitable weaknesses in their system or personnel.)\n\n";
            prompt += "# 4. Suggested Exploitation Plan\n(Provide actionable advice on how to beat this team. e.g., 'Exploit high press with balls over the top', 'Target their weak left-back in 2v1 situations'.)\n";
            
            parts.push({ text: prompt });
            
            if (opponentImages.length === 0) parts.push({ text: "No images provided."});
            opponentImages.forEach(img => {
                parts.push({ inlineData: { mimeType: img.mimeType, data: img.base64 } });
            });
            
            try {
                const resultText = await callGeminiApi(parts);
                displayResults(resultText, analysisOutputOpponent);
            } catch (error) {
                showError(`Opposition analysis failed: ${error.message}`);
            } finally {
                hideLoading();
            }
        }
        
        async function handleSearch() {
            showLoading("Searching for players...");
            if(searchError) searchError.classList.add('hidden');
            if(searchResults) searchResults.innerHTML = '<p class="text-slate-400">Searching...</p>';
            if(downloadCsvBtn) downloadCsvBtn.classList.add('hidden');
            
            const queryParts = [];
            if (searchPosition.value.trim()) queryParts.push(`Position: ${searchPosition.value.trim()}`);
            if (searchAge.value.trim()) queryParts.push(`Age: ${searchAge.value.trim()}`);
            if (searchNationality.value.trim()) queryParts.push(`Nationality/Passport: ${searchNationality.value.trim()}`);
            if (searchMarketValue.value.trim()) queryParts.push(`Market Value: ${searchMarketValue.value.trim()}`);
            if (searchContract.value.trim()) queryParts.push(`Contract Expires: ${searchContract.value.trim()}`);
            if (searchStats.value.trim()) queryParts.push(`Specific Stats: ${searchStats.value.trim()}`);
            if (searchMatches.value.trim()) queryParts.push(`Matches/Minutes: ${searchMatches.value.trim()}`);
            if (searchLeague.value.trim()) queryParts.push(`Has the potential quality or playstyle suitable for: ${searchLeague.value.trim()} (This is a scout assessment, they don't have to be playing in that league currently).`);
            
            if (queryParts.length === 0) {
                showSearchError("Please enter at least one search criterion.");
                return;
            }
            
            const fullQuery = `
Based on publicly available data and tactical analysis from Google Search, find up to 25 football players who match the following criteria:
- ${queryParts.join('\n- ')}

One key criterion is "Suitable for League." This means you should assess if the player's *potential* and *playstyle* match that league, not just if they *currently* play in it.

For each player, find their latest news headline (e.g., transfer rumors, injury update, recent performance).

Format the result as a simple HTML table (no classes) with columns: 
Name, Age, Club, Nationality, Position, Market Value (Est.), Contract Expires, Latest News (1 Headline)

If a value is unknown, use "N/A".
Do not include any text before or after the HTML table.
`;
            
            if(searchButton) searchButton.disabled = true;
            try {
                const resultHtml = await callGeminiApi([{ text: fullQuery }], true); // Use grounding
                
                // Style the HTML table with Tailwind
                let styledHtml = resultHtml
                    .replace(/<table>/g, '<table class="w-full text-left border-collapse">')
                    .replace(/<thead>/g, '<thead class="bg-slate-700">')
                    .replace(/<th>/g, '<th class="p-3 border-b border-slate-600 text-sm font-semibold text-white">')
                    .replace(/<tbody>/g, '<tbody class="divide-y divide-slate-700">')
                    .replace(/<tr>/g, '<tr class="hover:bg-slate-800">')
                    .replace(/<td>/g, '<td class="p-3 border-b border-slate-700 text-sm">');
                
                if(searchResults) searchResults.innerHTML = styledHtml;
                
                // Prepare CSV content
                csvContent = "Name,Age,Club,Nationality,Position,Market Value (Est.),Contract Expires,Latest News\n";
                const table = new DOMParser().parseFromString(resultHtml, 'text/html').querySelector('table');
                if (table) {
                    table.querySelectorAll('tbody tr').forEach(row => {
                        const rowData = [];
                        row.querySelectorAll('td').forEach(cell => {
                            rowData.push(`"${cell.textContent.trim().replace(/"/g, '""')}"`);
                        });
                        csvContent += rowData.join(',') + '\n';
                    });
                    if(downloadCsvBtn) downloadCsvBtn.classList.remove('hidden');
                }

            } catch (error) {
                showSearchError(`Search failed: ${error.message}`);
            } finally {
                hideLoading();
                if(searchButton) searchButton.disabled = false;
            }
        }
        
        function showSearchError(message) {
            if(searchError) {
                searchError.textContent = message;
                searchError.classList.remove('hidden');
            }
            if(searchResults) searchResults.innerHTML = '<p class="text-slate-400">Search failed. Please try again.</p>';
            hideLoading();
        }
        
        function downloadCSV() {
            if (!csvContent) return;
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'player_search_results.csv';
            link.click();
            URL.revokeObjectURL(link.href);
        }

        async function handleChat() {
            const userText = chatInput.value.trim();
            if (!userText) return;

            // Add user message to UI
            addChatMessage('User', userText);
            chatInput.value = '';
            chatInput.disabled = true;
            chatSendBtn.disabled = true;

            // Add user message to history
            chatHistory.push({ role: 'user', parts: [{ text: userText }] });

            // Add loading indicator
            const loadingEl = addChatMessage('Scout AI', '...');

            try {
                const resultText = await callChatbotApi(userText); // userQuery was undefined, changed to userText
                
                // Add model message to history
                chatHistory.push({ role: 'model', parts: [{ text: resultText }] });

                // Update loading message with real response
                if(loadingEl) loadingEl.querySelector('.chat-content').innerHTML = formatChatText(resultText);

            } catch (error) {
                if(loadingEl) loadingEl.querySelector('.chat-content').innerHTML = `<p class="text-red-400">Error: ${error.message}</p>`;
            } finally {
                chatInput.disabled = false;
                chatSendBtn.disabled = false;
                chatInput.focus();
                chatWindow.scrollTop = chatWindow.scrollHeight;
            }
        }

        async function callChatbotApi(userQuery) {
            const apiKey = userApiKey || (typeof __API_KEY__ !== 'undefined' ? __API_KEY__ : '');
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-pro-latest:generateContent?key=${apiKey}`;

            const payload = {
                contents: chatHistory, // Send the whole history
                tools: [{ "google_search": {} }], // Use grounding
                systemInstruction: {
                    parts: [{ text: "You are a professional football scout and tactical analyst. Answer the user's questions with this persona. Use Google Search to find up-to-date information. Format your answers clearly with headings, lists, and bold text." }]
                }
            };
            
            let response;
            try {
                response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
            } catch (fetchError) {
                console.error("Network error calling Chatbot API:", fetchError);
                throw new Error("Network error. Please check your connection.");
            }

            if (!response.ok) {
                let errorBody;
                try {
                    errorBody = await response.json();
                } catch(e) {
                    throw new Error(`API Error: ${response.status} ${response.statusText}. Could not parse error response.`);
                }
                console.error("Chatbot API Error Body:", errorBody);
                throw new Error(errorBody.error?.message || "An unknown API error occurred.");
            }

            let result;
            try {
                const rawText = await response.text(); // Read as text first
                if (!rawText) {
                    throw new Error("Received empty response from API.");
                }
                result = JSON.parse(rawText); // Then parse
            } catch (e) {
                console.error("Failed to parse Chatbot API response:", e);
                throw new Error("Failed to parse AI response. " + e.message);
            }

            if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts) {
                return result.candidates[0].content.parts[0].text;
            } else if (result.candidates && result.candidates[0].finishReason === "SAFETY") {
                throw new Error("Response blocked by safety settings.");
            } else {
                console.warn("Unexpected API response structure:", result);
                throw new Error("Could not parse the AI's response.");
            }
        }

        function addChatMessage(sender, text) {
            const senderClass = sender === 'User' ? 'bg-slate-800 self-end' : 'bg-slate-700 self-start';
            const senderNameClass = sender === 'User' ? 'text-teal-300' : 'text-sky-300';

            const messageEl = document.createElement('div');
            messageEl.classList.add('p-3', 'rounded-lg', 'max-w-3/4', 'w-fit', senderClass); // Added w-fit
            messageEl.innerHTML = `
                <p class="font-semibold ${senderNameClass} mb-1">${sender}</p>
                <div class="chat-content prose prose-sm prose-invert max-w-none">${formatChatText(text)}</div>
            `;
            if(chatWindow) {
                chatWindow.appendChild(messageEl);
                chatWindow.scrollTop = chatWindow.scrollHeight;
            }
            return messageEl;
        }

        function formatChatText(text) {
             // Basic markdown-to-HTML
            return text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') // Bold
                .replace(/\*(.*?)\*/g, '<em>$1</em>') // Italics
                .replace(/^# (.*)/gm, '<h3 class="text-xl font-semibold text-white mt-3 mb-2">$1</h3>') // H1 -> H3
                .replace(/^## (.*)/gm, '<h4 class="text-lg font-semibold text-white mt-3 mb-2">$1</h4>') // H2 -> H4
                .replace(/^### (.*)/gm, '<h5 class="text-md font-semibold text-white mt-3 mb-2">$1</h5>') // H3 -> H5
                .replace(/^- (.*)/gm, '<li class="ml-4">$1</li>') // List items
                .replace(/(<li>.*<\/li>)/gs, '<ul>$1</ul>') // Wrap lists
                .replace(/\n/g, '<br>'); // Newlines
        }

        function newChat() {
            chatHistory = [];
            if(chatWindow) chatWindow.innerHTML = '';
            addChatMessage('Scout AI', 'Hi! Ask me anything, like "What is the tactical style of Brighton?" or "Summarize Lamine Yamal\'s stats this season."');
        }


        // --- Output Formatting ---
        function displayResults(text, element) {
            if (!element) return;
            let html = text
                .replace(/^# 1. (.*)/gm, '<h3 class="text-xl font-semibold text-sky-300 mt-4 mb-2">$1</h3>')
                .replace(/^# 2. (.*)/gm, '<h3 class="text-xl font-semibold text-sky-300 mt-4 mb-2">$1</h3>')
                .replace(/^# 3. (.*)/gm, '<h3 class="text-xl font-semibold text-sky-300 mt-4 mb-2">$1</h3>')
                .replace(/^# 4. (.*)/gm, '<h3 class="text-xl font-semibold text-sky-300 mt-4 mb-2">$1</h3>')
                .replace(/^# 5. (.*)/gm, '<h3 class="text-xl font-semibold text-sky-300 mt-4 mb-2">$1</h3>')
                .replace(/^# 6. (.*)/gm, '<h3 class="text-xl font-semibold text-sky-300 mt-4 mb-2">$1</h3>')
                .replace(/^# 7. (.*)/gm, '<h3 class="text-xl font-semibold text-sky-300 mt-4 mb-2">$1</h3>')
                .replace(/^# 8. (.*)/gm, '<h3 class="text-xl font-semibold text-sky-300 mt-4 mb-2">$1</h3>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/^- (.*)/gm, '<li class="ml-4">$1</li>')
                .replace(/^(?!<h3|<li)(.*)/gm, '<p>$1</p>') // Wrap non-header/list lines in <p>
                .replace(/<p><\/p>/g, '') // Remove empty paragraphs
                .replace(/<\/li><p>/g, '</li>') // Fix spacing
                .replace(/<\/p><p>/g, '</p><p class="mt-2">');

            element.innerHTML = html;
        }

        function copyToClipboard() {
            if (!analysisOutput) return;
            const reportText = analysisOutput.innerText;
            navigator.clipboard.writeText(reportText).then(() => {
                copyBtn.innerHTML = '<i data-lucide="check" class="h-5 w-5 mr-2"></i>Copied!';
                if (typeof lucide !== 'undefined') lucide.createIcons();
                setTimeout(() => {
                    copyBtn.innerHTML = '<i data-lucide="clipboard" class="h-5 w-5 mr-2"></i>Copy';
                    if (typeof lucide !== 'undefined') lucide.createIcons();
                }, 2000);
            }).catch(err => {
                showError('Failed to copy to clipboard.');
            });
        }
        
        function findVideos() {
            const name = playerName.value.trim();
            if (!name) {
                showError("Please enter a player's name first.");
                return;
            }
            // Switch to chatbot tab
            showTab('chatbot');
            // Auto-fill and send query
            const query = `Find recent match highlights and performance videos for ${name}`;
            chatInput.value = query;
            handleChat();
        }

        // --- Stats Visualization ---
        function visualizeStats() {
            if (!textStatsSingle) return;
            const text = textStatsSingle.value;
            const lines = text.split('\n');
            const data = {
                labels: [],
                values: []
            };

            const regex = /([\w\s\/]+):\s*([\d\.]+)[\/\s]*([\d\.]+)?/;

            lines.forEach(line => {
                const match = line.match(regex);
                if (match) {
                    const label = match[1].trim();
                    const value1 = parseFloat(match[2]);
                    const value2 = parseFloat(match[3]);

                    if (!isNaN(value2)) {
                        // Handle fractional stats like "Tackles: 3/4"
                        data.labels.push(`${label} (Success)`);
                        data.values.push(value1);
                        data.labels.push(`${label} (Failed)`);
                        data.values.push(value2 - value1);
                    } else if (!isNaN(value1)) {
                        // Handle simple stats like "Goals: 1"
                        data.labels.push(label);
                        data.values.push(value1);
                    }
                }
            });

            if (data.labels.length === 0) {
                showError("Could not find any stats to visualize. Make sure they are in 'Stat: Value' format (e.g., 'Goals: 1' or 'Tackles: 3/4').");
                return;
            }

            if (statsChart) {
                statsChart.destroy();
            }

            if (typeof Chart === 'undefined') {
                showError("Chart.js library is not loaded.");
                return;
            }

            statsChart = new Chart(statsChartCanvas, {
                type: 'bar',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: 'Stats',
                        data: data.values,
                        backgroundColor: 'rgba(56, 189, 248, 0.6)', // sky-400
                        borderColor: 'rgba(56, 189, 248, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y', // Horizontal bar chart
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: 'Stats Visualization',
                            color: '#e2e8f0' // slate-200
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#94a3b8' }, // slate-400
                            grid: { color: '#334155' } // slate-700
                        },
                        y: {
                            ticks: { color: '#94a3b8' }, // slate-400
                            grid: { display: false }
                        }
                    }
                }
            });
        }
        
        // --- PDF Generation ---
        
        async function generatePDF() {
            if (typeof jsPDF === 'undefined') {
                showError("jsPDF library is not loaded.");
                return;
            }
            const { jsPDF } = window.jspdf;
            showLoading("Generating PDF preview...");
            
            try {
                const rawReportText = analysisOutput.innerText;
                const reportData = (reportType.value === 'pro') ? 
                                    parseProReport(rawReportText) : 
                                    parseQuickReport(rawReportText);
                
                if (!reportData) {
                    showError("Error generating PDF preview: Could not parse Pro Scout Report. AI response was incomplete. Please try again.");
                    return;
                }

                const doc = new jsPDF({
                    orientation: 'p',
                    unit: 'mm',
                    format: 'a4'
                });

                const margin = 20;
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
                const contentWidth = pageWidth - (margin * 2);
                let y = margin; // Current y position

                // --- Helper Functions ---
                const addPageIfNeeded = (spaceNeeded) => {
                    if (y + spaceNeeded > pageHeight - margin) {
                        doc.addPage();
                        y = margin;
                        return true;
                    }
                    return false;
                };

                const setHeaderStyle = () => {
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(14);
                    doc.setTextColor(30, 41, 59); // slate-800
                };

                const setSubheaderStyle = () => {
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(11);
                    doc.setTextColor(15, 23, 42); // slate-900
                };
                
                const setBodyStyle = (style = 'normal') => {
                    doc.setFont('helvetica', style);
                    doc.setFontSize(10);
                    doc.setTextColor(71, 85, 105); // slate-500
                };
                
                const addSection = (title, content) => {
                    if (!content) return;
                    
                    addPageIfNeeded(20); // Space for header + line + content
                    
                    setHeaderStyle();
                    doc.text(title, margin, y);
                    y += 6;
                    doc.setDrawColor(203, 213, 225); // slate-300
                    doc.line(margin, y, pageWidth - margin, y);
                    y += 8;
                    
                    setBodyStyle();
                    const lines = doc.splitTextToSize(content, contentWidth);
                    addPageIfNeeded(lines.length * 5); // Estimate space
                    doc.text(lines, margin, y);
                    y += (lines.length * 5) + 6; // Add padding after section
                };

                // --- 1. PDF Header ---
                doc.setFillColor(241, 245, 249); // slate-100
                doc.rect(0, 0, pageWidth, 40, 'F');
                
                // Player Photo Placeholder
                doc.setFillColor(203, 213, 225); // slate-300
                doc.rect(margin, 15, 25, 25, 'F');
                doc.setTextColor(100, 116, 139); // slate-400
                doc.setFontSize(8);
                doc.text('Photo', margin + 12.5, 28, { align: 'center' });

                // Player Info
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(18);
                doc.setTextColor(15, 23, 42); // slate-900
                doc.text(playerName.value || 'N/A', margin + 30, 22);
                
                setBodyStyle();
                doc.setFontSize(11);
                doc.setTextColor(71, 85, 105); // slate-500
                doc.text(`Age: ${playerAge.value || 'N/A'} | Club: ${playerClub.value || 'N/A'} | Position(s): ${playerPositions.value || 'N/A'}`, margin + 30, 29);
                doc.text(`Match: ${matchContext.value || 'N/A'} | League: ${playerLeague.value || 'N/A'}`, margin + 30, 35);
                
                y = 50; // Start content below header

                // --- 2. Add Key Visuals (Images & Chart) ---
                addPageIfNeeded(20);
                setHeaderStyle();
                doc.text("Key Visuals", margin, y);
                y += 6;
                doc.setDrawColor(203, 213, 225); // slate-300
                doc.line(margin, y, pageWidth - margin, y);
                y += 8;
                
                let visualX = margin;
                const visualWidth = (contentWidth / 2) - 5;
                const visualHeight = (visualWidth * 9) / 16; // 16:9 aspect ratio

                try {
                    // Add Stats Chart
                    if (statsChart) {
                        addPageIfNeeded(visualHeight + 10);
                        const chartImgData = statsChart.toBase64Image();
                        doc.addImage(chartImgData, 'PNG', visualX, y, visualWidth, visualHeight);
                        setSubheaderStyle();
                        doc.text("Stats Visualization", visualX + visualWidth/2, y + visualHeight + 6, { align: 'center' });
                        visualX += visualWidth + 10;
                    }
                    
                    // Add Heatmap/Stats Images (up to 2)
                    for (let i = 0; i < Math.min(singlePlayerImages.length, 2); i++) {
                        if (visualX > margin + visualWidth) { // New row
                            y += visualHeight + 12;
                            visualX = margin;
                        }
                        addPageIfNeeded(visualHeight + 10);
                        const img = singlePlayerImages[i];
                        const imgData = `data:${img.mimeType};base64,${img.base64}`;
                        doc.addImage(imgData, 'JPEG', visualX, y, visualWidth, visualHeight);
                        setSubheaderStyle();
                        doc.text(`Uploaded Image ${i+1}`, visualX + visualWidth/2, y + visualHeight + 6, { align: 'center' });
                        visualX += visualWidth + 10;
                    }
                    
                    y += visualHeight + 12; // Move y down past the visuals

                } catch (imgError) {
                    console.error("Error adding images to PDF:", imgError);
                    setBodyStyle('italic');
                    doc.setTextColor(239, 68, 68); // red-500
                    doc.text("Could not embed images. Check console for errors.", margin, y);
                    y += 10;
                }

                // --- 3. Add Report Sections ---
                if (reportType.value === 'pro') {
                    addSection("AI Performance Rating", reportData.rating);
                    addSection("Summary", reportData.summary);
                    addSection("Positional Play", reportData.positional);
                    addSection("Key Actions (PMDS)", reportData.actions);
                    addSection("Tactical Awareness (Four Phases)", reportData.tactical);
                    addSection("Mentality", reportData.mentality);
                    addSection("Conclusion & Recommendation", reportData.conclusion);
                    addSection("Similar Player Matrix", reportData.similar);
                } else {
                    addSection("AI Performance Rating", reportData.rating);
                    addSection("Likely Position(s) & Role", reportData.position);
                    addSection("Key Duties & Playstyle", reportData.playstyle);
                    addSection("Key Strengths (Pros)", reportData.pros);
                    addSection("Key Weaknesses (Cons)", reportData.cons);
                    addSection("Suggested Similar Player", reportData.similar);
                    addSection("Suggested Development Plan", reportData.development);
                }

                // --- 4. Generate Blob URL and show in modal ---
                const pdfBlob = doc.output('blob');
                generatedPdfBlobUrl = URL.createObjectURL(pdfBlob);
                pdfPreviewFrame.src = generatedPdfBlobUrl;
                
                showPdfPreview();
            
            } catch (e) {
                console.error("PDF Generation Failed:", e);
                showError(`Error generating PDF: ${e.message}`);
            } finally {
                hideLoading();
            }
        }
        
        function parseProReport(text) {
            try {
                const getSection = (regex) => {
                    const match = text.match(regex);
                    // Use optional chaining and nullish coalescing
                    return match?.[1]?.trim() ?? 'N/A';
                };
        
                // Make regex flexible to ignore text in parentheses
                const report = {
                    rating: getSection(/# 1\. AI-Calculated Performance Rating[\s\S]*?\n([\s\S]*?)(?=\n# 2\.|\n$)/),
                    summary: getSection(/# 2\. Summary[\s\S]*?\n([\s\S]*?)(?=\n# 3\.|\n$)/),
                    positional: getSection(/# 3\. Positional Play[\s\S]*?\n([\s\S]*?)(?=\n# 4\.|\n$)/),
                    actions: getSection(/# 4\. Key Actions[\s\S]*?\n([\s\S]*?)(?=\n# 5\.|\n$)/),
                    tactical: getSection(/# 5\. Tactical Awareness[\s\S]*?\n([\s\S]*?)(?=\n# 6\.|\n$)/),
                    mentality: getSection(/# 6\. Mentality[\s\S]*?\n([\s\S]*?)(?=\n# 7\.|\n$)/),
                    conclusion: getSection(/# 7\. Conclusion & Recommendation[\s\S]*?\n([\s\S]*?)(?=\n# 8\.|\n$)/),
                    similar: getSection(/# 8\. Similar Player Matrix[\s\S]*?\n([\s\S]*?)(?=\n$)/)
                };
                
                // Check if parsing failed
                if (Object.values(report).every(val => val === 'N/A')) {
                    throw new Error("All sections parsed as N/A.");
                }
                
                return report;
            } catch(e) {
                console.error("Failed to parse pro report:", e.message, "\nRaw text:", text);
                return null;
            }
        }
        
        function parseQuickReport(text) {
             try {
                const getSection = (regex) => {
                    const match = text.match(regex);
                    return match?.[1]?.trim() ?? 'N/A';
                };

                const report = {
                    rating: getSection(/# 1\. AI-Calculated Performance Rating[\s\S]*?\n([\s\S]*?)(?=\n# 2\.|\n$)/),
                    position: getSection(/# 2\. Likely Position\(s\) & Role[\s\S]*?\n([\s\S]*?)(?=\n# 3\.|\n$)/),
                    playstyle: getSection(/# 3\. Key Duties & Playstyle[\s\S]*?\n([\s\S]*?)(?=\n# 4\.|\n$)/),
                    pros: getSection(/# 4\. Key Strengths \(Pros\)[\s\S]*?\n([\s\S]*?)(?=\n# 5\.|\n$)/),
                    cons: getSection(/# 5\. Key Weaknesses \(Cons\)[\s\S]*?\n([\s\S]*?)(?=\n# 6\.|\n$)/),
                    similar: getSection(/# 6\. Suggested Similar Player[\s\S]*?\n([\s\S]*?)(?=\n# 7\.|\n$)/),
                    development: getSection(/# 7\. Suggested Development Plan[\s\S]*?\n([\s\S]*?)(?=\n$)/)
                };
                
                if (Object.values(report).every(val => val === 'N/A')) {
                    throw new Error("All sections parsed as N/A.");
                }
                
                return report;
            } catch(e) {
                console.error("Failed to parse quick report:", e.message, "\nRaw text:", text);
                return null;
            }
        }


        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            // Set default tab
            showTab('singlePlayer');

            // Tab navigation
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    showTab(button.dataset.tab);
                });
            });
            
            // API Key management
            if (saveApiKeyBtn) saveApiKeyBtn.addEventListener('click', saveApiKey);
            loadApiKey(); // Load after button listener is attached
            
            // Main controls
            if (analyzeBtn) analyzeBtn.addEventListener('click', handleAnalysis);
            if (clearBtn) clearBtn.addEventListener('click', clearAllInputs);

            // Modals
            if (howToUseBtn) howToUseBtn.addEventListener('click', showHowToUse);
            if (closeHowToUseBtn) closeHowToUseBtn.addEventListener('click', closeHowToUse);
            if (closeErrorBtn) closeErrorBtn.addEventListener('click', closeError);
            if (pdfBtn) pdfBtn.addEventListener('click', generatePDF);
            if (closePdfPreviewBtn) closePdfPreviewBtn.addEventListener('click', closePdfPreview);
            if (downloadPdfBtn) downloadPdfBtn.addEventListener('click', () => {
                if (generatedPdfBlobUrl) {
                    const link = document.createElement('a');
                    link.href = generatedPdfBlobUrl;
                    link.download = `${playerName.value.trim() || 'player'}_scout_report.pdf`;
                    link.click();
                }
            });

            // Export Buttons
            if (copyBtn) copyBtn.addEventListener('click', copyToClipboard);
            if (videoBtn) videoBtn.addEventListener('click', findVideos);
            
            // Single Player Tab
            setupUploadListeners(dropZoneSingle, fileUploadSingle, imagePreviewSingle, singlePlayerImages);
            if (scanStatsBtn) scanStatsBtn.addEventListener('click', scanStatsFromImage);
            if (visualizeStatsBtn) visualizeStatsBtn.addEventListener('click', visualizeStats);
            if (textStatsSingle) textStatsSingle.addEventListener('input', () => {
                visualizeStatsBtn.disabled = textStatsSingle.value.trim().length === 0;
            });
            
            // Comparison Tab
            setupUploadListeners(dropZoneCompare1, fileUploadCompare1, imagePreviewCompare1, compare1Images);
            setupUploadListeners(dropZoneCompare2, fileUploadCompare2, imagePreviewCompare2, compare2Images);
            
            // Opposition Tab
            setupUploadListeners(dropZoneOpponent, fileUploadOpponent, imagePreviewOpponent, opponentImages);
            
            // Search Tab
            if (searchButton) searchButton.addEventListener('click', handleSearch);
            if (downloadCsvBtn) downloadCsvBtn.addEventListener('click', downloadCSV);

            // Chatbot Tab
            if (chatSendBtn) chatSendBtn.addEventListener('click', handleChat);
            if (chatInput) chatInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    handleChat();
                }
            });
            if (newChatBtn) newChatBtn.addEventListener('click', newChat);
            
            // Initialize lucide icons
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        });

    </script>
</body>
</html>

