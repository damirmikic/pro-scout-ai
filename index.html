<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro Scout AI - Player Analysis</title>
    <!-- FAVICON -->
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cg fill='none' stroke-linecap='round'%3E%3Ccircle cx='45' cy='45' r='30' stroke='%2338bdf8' stroke-width='10'/%3E%3Cline x1='65' y1='65' x2='85' y2='85' stroke='%239ca3af' stroke-width='12'/%3E%3C/g%3E%3Cg fill='%232dd4bf'%3E%3Crect x='30' y='40' width='8' height='20' rx='2'/%3E%3Crect x='41' y='30' width='8' height='30' rx='2'/%3E%3Crect x='52' y='35' width='8' height='25' rx='2'/%3E%3C/g%3E%3C/svg%3E" type="image/svg+xml">
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Lucide icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Load Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Use Inter font */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom styles for the file input */
        .file-input-label {
            cursor: pointer;
        }
        /* Simple spinner animation */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-left-color: #ffffff;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
        
        /* Styles for image preview containers */
        .image-preview-container {
            display: flex;
            overflow-x: auto;
            overflow-y: hidden;
            white-space: nowrap;
            padding-bottom: 8px; /* For scrollbar visibility */
            min-height: 100px;
            background: rgba(0,0,0,0.1);
            border-radius: 8px;
        }
        .image-preview-container img {
            max-height: 200px; /* Smaller for comparison view */
            height: auto;
            width: auto;
            object-fit: contain;
            border-radius: 8px;
            margin-right: 12px;
            flex-shrink: 0;
        }
        /* Larger preview for single player tab */
        #imagePreviewContainerSingle img {
            max-height: 300px;
        }

        /* Custom scrollbar */
        .image-preview-container::-webkit-scrollbar { height: 8px; }
        .image-preview-container::-webkit-scrollbar-track { background: #4a5568; border-radius: 4px; }
        .image-preview-container::-webkit-scrollbar-thumb { background: #718096; border-radius: 4px; }
        .image-preview-container::-webkit-scrollbar-thumb:hover { background: #a0aec0; }

        /* Tab styles */
        .tab-button {
            padding: 0.75rem 1rem;
            font-weight: 600;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            color: #9ca3af; /* gray-400 */
        }
        .tab-button.active {
            color: #38bdf8; /* sky-400 */
            border-color: #38bdf8;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }

        /* Modal styles */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.75);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: #1f2937; /* gray-800 */
            color: #d1d5db; /* gray-300 */
            padding: 1.5rem;
            border-radius: 0.75rem;
            max-width: 90%;
            width: 50rem;
            max-height: 80vh;
            overflow-y: auto;
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }
        .modal-overlay.visible .modal-content {
            transform: scale(1);
        }
        .modal-content h2 {
            font-size: 1.5rem;
            font-weight: 700;
            color: #ffffff;
            margin-bottom: 1rem;
        }
        .modal-content h3 {
            font-size: 1.25rem;
            font-weight: 600;
            color: #38bdf8; /* sky-400 */
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
        }
        .modal-content p {
            line-height: 1.6;
            margin-bottom: 1rem;
        }
        .modal-content ul {
            list-style-type: disc;
            padding-left: 1.5rem;
            margin-bottom: 1rem;
        }
        .modal-content li {
            margin-bottom: 0.5rem;
        }

        /* Print styles */
        @media print {
            body {
                background-color: #ffffff;
                color: #000000;
            }
            main > *,
            header,
            #analysisControls,
            #reportActions,
            #guideButton,
            .modal-overlay {
                display: none;
            }
            #resultsSection,
            #resultsSection > * {
                display: block;
            }
            #analysisOutput {
                color: #000000;
                white-space: pre-wrap; /* Ensure content wraps for print */
            }
            #resultsSection {
                margin-top: 0;
                padding: 0;
                background: none;
                border: none;
                box-shadow: none;
            }
            h2 { /* Report title */
                color: #000000;
            }
            h3 { /* Section titles */
                color: #000000;
                font-size: 1.25rem;
                font-weight: 600;
                margin-top: 1rem;
                margin-bottom: 0.5rem;
                /* Re-create styles stripped by markdown replace */
                /* text-blue-300 */
            }
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 flex items-center justify-center min-h-screen p-4">
    
    <div class="w-full max-w-6xl mx-auto p-6 md:p-8 bg-gray-800 rounded-2xl shadow-2xl">
        <header class="text-center mb-4 relative">
            <h1 class="text-3xl md:text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-teal-300">
                Pro Scout AI
            </h1>
            <p class="text-lg text-gray-400 mt-2">Professional-grade player analysis, powered by AI.</p>
            <button id="guideButton" class="absolute top-0 right-0 flex items-center gap-2 px-3 py-1 bg-gray-700 text-gray-300 rounded-md hover:bg-gray-600 transition-colors text-sm">
                <svg data-lucide="help-circle" class="h-4 w-4"></svg>
                How to Use
            </button>
        </header>

        <!-- Tab Navigation -->
        <nav class="flex border-b border-gray-700 mb-6">
            <button id="tabSingle" class="tab-button active">Single Player Analysis</button>
            <button id="tabCompare" class="tab-button">Player Comparison</button>
        </nav>

        <main>
            <!-- ======================= -->
            <!-- SINGLE PLAYER TAB       -->
            <!-- ======================= -->
            <div id="contentSingle" class="tab-content active">
                <!-- Upload Section -->
                <div class="flex flex-col items-center justify-center bg-gray-700 p-6 rounded-lg border-2 border-dashed border-gray-500 min-h-[24rem]">
                    <div id="imagePreviewContainerSingle" class="w-full mb-4 image-preview-container">
                        <!-- Images will be added here dynamically -->
                    </div>
                    <div id="uploadPlaceholderSingle" class="text-center text-gray-400">
                        <svg class="mx-auto h-16 w-16 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.409a2.25 2.25 0 013.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 001.5-1.5V6a1.5 1.5 0 00-1.5-1.5H3.75A1.5 1.5 0 002.25 6v12a1.5 1.5 0 001.5 1.5zm10.5-11.25h.008v.008h-.008V8.25zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z" /></svg>
                        <p class="mt-2 font-semibold">Drag & Drop, Paste, or Select Images</p>
                    </div>
                    <div class="flex gap-4 mt-4">
                        <label class="file-input-label px-4 py-2 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 transition-colors cursor-pointer">
                            <span>Select Image(s)</span>
                            <input type="file" id="imageUploadSingle" accept="image/png, image/jpeg" class="hidden" multiple>
                        </label>
                        <button id="clearButtonSingle" class="hidden px-4 py-2 bg-red-600 text-white rounded-lg shadow-md hover:bg-red-700 transition-colors">
                            Clear All
                        </button>
                    </div>
                </div>

                <!-- Controls and Text Input -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                    <div>
                        <label for="matchContextSingle" class="mb-2 block font-semibold text-gray-300">Optional: Match Context</label>
                        <input type="text" id="matchContextSingle" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-gray-200 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., vs. Liverpool, 90 mins">
                    </div>
                    <div>
                        <label for="textStatsSingle" class="mb-2 block font-semibold text-gray-300">Optional: Paste Additional Stats</label>
                        <textarea id="textStatsSingle" rows="5" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-gray-200 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g.,&#10;Goals: 1&#10;Assists: 0&#10;Tackles: 4/5..."></textarea>
                        <button id="visualizeStatsButton" class="mt-2 w-full flex items-center justify-center gap-2 bg-teal-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-teal-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                            <svg data-lucide="bar-chart-3" class="h-5 w-5"></svg>
                            Visualize Text Stats
                        </button>
                    </div>
                </div>

                <!-- Stats Visualization Canvas -->
                <div id="chartContainer" class="hidden mt-6 bg-gray-700 p-4 rounded-lg">
                    <h3 class="text-lg font-semibold text-gray-200 mb-2">Text Stats Visualization</h3>
                    <canvas id="statsChart"></canvas>
                </div>
            </div>

            <!-- ======================= -->
            <!-- COMPARISON TAB          -->
            <!-- ======================= -->
            <div id="contentCompare" class="tab-content">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Player 1 Column -->
                    <div class="bg-gray-700 p-4 rounded-lg">
                        <h3 class="text-xl font-bold text-center text-blue-300 mb-4">Player 1</h3>
                        <div id="imagePreviewContainer1" class="w-full mb-4 image-preview-container"></div>
                        <div id="uploadPlaceholder1" class="text-center text-gray-400 py-8">
                            <svg class="mx-auto h-12 w-12 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.409a2.25 2.25 0 013.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 001.5-1.5V6a1.5 1.5 0 00-1.5-1.5H3.75A1.5 1.5 0 002.25 6v12a1.5 1.5 0 001.5 1.5zm10.5-11.25h.008v.008h-.008V8.25zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z" /></svg>
                            <p class="mt-1 text-sm font-semibold">Upload/Paste Player 1 Images</p>
                        </div>
                        <div class="flex gap-4 mt-2 justify-center">
                            <label class="file-input-label px-3 py-2 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 transition-colors cursor-pointer text-sm">
                                <span>Select Image(s)</span>
                                <input type="file" id="imageUpload1" accept="image/png, image/jpeg" class="hidden" multiple>
                            </label>
                            <button id="clearButton1" class="hidden px-3 py-2 bg-red-600 text-white rounded-lg shadow-md hover:bg-red-700 transition-colors text-sm">Clear</button>
                        </div>
                        <label for="matchContext1" class="mt-4 mb-2 block font-semibold text-gray-300 text-sm">Context (Optional)</label>
                        <input type="text" id="matchContext1" class="w-full p-2 bg-gray-600 border border-gray-500 rounded-lg text-gray-200 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm" placeholder="e.g., vs. Liverpool">
                        <label for="textStats1" class="mt-4 mb-2 block font-semibold text-gray-300 text-sm">Stats (Optional)</label>
                        <textarea id="textStats1" rows="4" class="w-full p-2 bg-gray-600 border border-gray-500 rounded-lg text-gray-200 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm" placeholder="Paste Player 1 stats..."></textarea>
                    </div>

                    <!-- Player 2 Column -->
                    <div class="bg-gray-700 p-4 rounded-lg">
                        <h3 class="text-xl font-bold text-center text-teal-300 mb-4">Player 2</h3>
                        <div id="imagePreviewContainer2" class="w-full mb-4 image-preview-container"></div>
                        <div id="uploadPlaceholder2" class="text-center text-gray-400 py-8">
                            <svg class="mx-auto h-12 w-12 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.409a2.25 2.25 0 013.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 001.5-1.5V6a1.5 1.5 0 00-1.5-1.5H3.75A1.5 1.5 0 002.25 6v12a1.5 1.5 0 001.5 1.5zm10.5-11.25h.008v.008h-.008V8.25zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z" /></svg>
                            <p class="mt-1 text-sm font-semibold">Upload/Paste Player 2 Images</p>
                        </div>
                        <div class="flex gap-4 mt-2 justify-center">
                            <label class="file-input-label px-3 py-2 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 transition-colors cursor-pointer text-sm">
                                <span>Select Image(s)</span>
                                <input type="file" id="imageUpload2" accept="image/png, image/jpeg" class="hidden" multiple>
                            </label>
                            <button id="clearButton2" class="hidden px-3 py-2 bg-red-600 text-white rounded-lg shadow-md hover:bg-red-700 transition-colors text-sm">Clear</button>
                        </div>
                        <label for="matchContext2" class="mt-4 mb-2 block font-semibold text-gray-300 text-sm">Context (Optional)</label>
                        <input type="text" id="matchContext2" class="w-full p-2 bg-gray-600 border border-gray-500 rounded-lg text-gray-200 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm" placeholder="e.g., vs. Chelsea">
                        <label for="textStats2" class="mt-4 mb-2 block font-semibold text-gray-300 text-sm">Stats (Optional)</label>
                        <textarea id="textStats2" rows="4" class="w-full p-2 bg-gray-600 border border-gray-500 rounded-lg text-gray-200 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm" placeholder="Paste Player 2 stats..."></textarea>
                    </div>
                </div>
            </div>

            <!-- ======================= -->
            <!-- ANALYSIS CONTROLS       -->
            <!-- ======================= -->
            <div id="analysisControls" class="mt-6">
                <!-- API Key Input -->
                <div class="mb-4">
                    <label for="apiKey" class="mb-2 block text-sm font-semibold text-gray-400">Optional: Your Gemini API Key</label>
                    <div class="flex items-center gap-2">
                        <input type="password" id="apiKey" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-gray-200 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Enter your API key (optional)">
                        <button type="button" id="toggleApiVisibility" class="p-3 bg-gray-600 rounded-lg text-gray-300 hover:bg-gray-500">
                            <svg data-lucide="eye" id="eyeIcon" class="h-5 w-5"></svg>
                            <svg data-lucide="eye-off" id="eyeOffIcon" class="h-5 w-5 hidden"></svg>
                        </button>
                    </div>
                </div>

                <button id="analyzeButton" class="w-full flex items-center justify-center gap-2 bg-gradient-to-r from-blue-500 to-teal-500 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:from-blue-600 hover:to-teal-600 transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg id="buttonIcon" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 17.25v1.007a3 3 0 01-.879 2.122L7.5 21M9 17.25v-1.007a3 3 0 00-.879-2.122L7.5 15M9 17.25H15M15 17.25v1.007a3 3 0 00.879 2.122L16.5 21M15 17.25v-1.007a3 3 0 01.879-2.122L16.5 15M15 17.25H9M9 15h6M9 15c-1.036 0-1.875-.84-1.875-1.875v-1.25c0-1.036.84-1.875 1.875-1.875h6c1.036 0 1.875.84 1.875 1.875v1.25c0 1.036-.84 1.875-1.875-1.875M9 15v-1.875c0-1.036.84-1.875 1.875-1.875h6c1.036 0 1.875.84 1.875 1.875V15M9 9.75h6c1.036 0 1.875-.84 1.875-1.875v-1.25c0-1.036-.84-1.875-1.875-1.875h-6c-1.036 0-1.875.84-1.875-1.875v1.25c0 1.036.84 1.875 1.875 1.875z" />
                    </svg>
                    <span id="buttonText">Analyze Player</span>
                    <div id="loadingSpinner" class="spinner hidden"></div>
                </button>
                
                <!-- Error Message Box -->
                <div id="errorMessage" class="hidden mt-4 bg-red-800 border border-red-600 text-red-200 px-4 py-3 rounded-lg" role="alert">
                    <strong class="font-bold">Error:</strong>
                    <span class="block sm:inline" id="errorText"></span>
                </div>
            </div>

            <!-- ======================= -->
            <!-- RESULTS SECTION         -->
            <!-- ======================= -->
            <div id="resultsSection" class="hidden mt-8 bg-gray-700/50 p-6 rounded-lg">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-gray-100">Scouting Report</h2>
                    <div id="reportActions" class="flex gap-2">
                        <button id="copyButton" class="flex items-center gap-2 px-3 py-1 bg-gray-600 text-gray-200 rounded-md hover:bg-gray-500 transition-colors text-sm">
                            <svg data-lucide="copy" class="h-4 w-4"><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><rect x="7" y="5" width="6" height="6" rx="1"></rect></svg>
                            Copy
                        </button>
                        <button id="printButton" class="flex items-center gap-2 px-3 py-1 bg-gray-600 text-gray-200 rounded-md hover:bg-gray-500 transition-colors text-sm">
                            <svg data-lucide="printer" class="h-4 w-4"><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></svg>
                            Print
                        </button>
                    </div>
                </div>
                <div id="analysisOutput" class="text-gray-300 leading-relaxed whitespace-pre-line">
                    <!-- AI analysis will be injected here -->
                </div>
            </div>
        </main>
    </div>

    <!-- ======================= -->
    <!-- "HOW TO USE" MODAL      -->
    <!-- ======================= -->
    <div id="guideModalOverlay" class="modal-overlay">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl">How to Use Pro Scout AI</h2>
                <button id="closeGuideModal" class="text-gray-400 hover:text-white">
                    <svg data-lucide="x" class="h-6 w-6"></svg>
                </button>
            </div>
            
            <p>Welcome! This app helps you create professional scouting reports by analyzing images (like heatmaps and stat graphics) and text data.</p>

            <h3 class="text-xl">Single Player Analysis (Default Tab)</h3>
            <ol class="list-decimal pl-6 mb-4">
                <li><strong>Upload Images:</strong> Click "Select Image(s)" or drag-and-drop heatmap/stats images into the upload box. You can also paste an image from your clipboard (Ctrl+V/Cmd+V).</li>
                <li><strong>Add Context (Optional):</strong> In the "Match Context" box, add info like "vs. Man City, 90 mins" to help the AI.</li>
                <li><strong>Add Text Stats (Optional):</strong> Paste any extra stats (e.g., `Goals: 1`) into the "Additional Stats" box.</li>
                <li><strong>Visualize (Optional):</strong> If you added text stats, click "Visualize Text Stats" to see a simple bar chart of that data.</li>
                <li><strong>Add API Key (Optional):</strong> If you have your own Gemini API key, you can enter it in the "Your Gemini API Key" field. If you leave it blank, the app will use the default.</li>
                <li><strong>Analyze:</strong> Click the "Analyze Player" button.</li>
                <li><strong>Get Report:</strong> The AI will generate a full report with 7 sections: Position, Role, Pros, Cons, Summary, Similar Player, and Development Plan.</li>
                <li><strong>Export:</strong> Use the "Copy" or "Print" (to PDF) buttons to save your report.</li>
            </ol>

            <h3 class="text-xl">Player Comparison Tab</h3>
            <ol class="list-decimal pl-6 mb-4">
                <li><strong>Switch Tab:</strong> Click "Player Comparison" at the top.</li>
                <li><strong>Upload for Player 1:</strong> Use the "Player 1" box to upload images and add optional context/stats for your first player.</li>
                <li><strong>Upload for Player 2:</strong> Use the "Player 2" box to do the same for your second player.</li>
                <li><strong>Analyze:</strong> Click the "Compare Players" button (it's only enabled when both players have at least one image).</li>
                <li><strong>Get Report:</strong> The AI will generate a "Head-to-Head" analysis, comparing their profiles, strengths, weaknesses, and tactical fit.</li>
            </ol>
        </div>
    </div>


    <script>
        // Wait for the DOM to be fully loaded before running the script
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- Global State ---
            let activeTab = 'single'; // 'single' or 'compare'
            // playerData[0] is single player, playerData[1] is player 1, playerData[2] is player 2
            let playerData = [
                { images: [], mimes: [] },
                { images: [], mimes: [] },
                { images: [], mimes: [] }
            ];
            let statsChartInstance = null; // To hold the Chart.js instance

            // --- DOM Elements ---
            const tabSingle = document.getElementById('tabSingle');
            const tabCompare = document.getElementById('tabCompare');
            const contentSingle = document.getElementById('contentSingle');
            const contentCompare = document.getElementById('contentCompare');
            const analyzeButton = document.getElementById('analyzeButton');
            const buttonText = document.getElementById('buttonText');
            const buttonIcon = document.getElementById('buttonIcon');
            const loadingSpinner = document.getElementById('loadingSpinner');
            const resultsSection = document.getElementById('resultsSection');
            const analysisOutput = document.getElementById('analysisOutput');
            const errorMessage = document.getElementById('errorMessage');
            const errorText = document.getElementById('errorText');
            const copyButton = document.getElementById('copyButton');
            const printButton = document.getElementById('printButton');
            const guideButton = document.getElementById('guideButton');
            const guideModalOverlay = document.getElementById('guideModalOverlay');
            const closeGuideModal = document.getElementById('closeGuideModal');
            const apiKeyInput = document.getElementById('apiKey');
            const toggleApiVisibility = document.getElementById('toggleApiVisibility');
            const eyeIcon = document.getElementById('eyeIcon');
            const eyeOffIcon = document.getElementById('eyeOffIcon');

            // --- Single Player Elements ---
            const imageUploadSingle = document.getElementById('imageUploadSingle');
            const imagePreviewContainerSingle = document.getElementById('imagePreviewContainerSingle');
            const uploadPlaceholderSingle = document.getElementById('uploadPlaceholderSingle');
            const clearButtonSingle = document.getElementById('clearButtonSingle');
            const matchContextSingle = document.getElementById('matchContextSingle');
            const textStatsSingle = document.getElementById('textStatsSingle');
            const visualizeStatsButton = document.getElementById('visualizeStatsButton');
            const chartContainer = document.getElementById('chartContainer');
            const statsChartCanvas = document.getElementById('statsChart');

            // --- Player 1 Elements ---
            const imageUpload1 = document.getElementById('imageUpload1');
            const imagePreviewContainer1 = document.getElementById('imagePreviewContainer1');
            const uploadPlaceholder1 = document.getElementById('uploadPlaceholder1');
            const clearButton1 = document.getElementById('clearButton1');
            const matchContext1 = document.getElementById('matchContext1');
            const textStats1 = document.getElementById('textStats1');
            
            // --- Player 2 Elements ---
            const imageUpload2 = document.getElementById('imageUpload2');
            const imagePreviewContainer2 = document.getElementById('imagePreviewContainer2');
            const uploadPlaceholder2 = document.getElementById('uploadPlaceholder2');
            const clearButton2 = document.getElementById('clearButton2');
            const matchContext2 = document.getElementById('matchContext2');
            const textStats2 = document.getElementById('textStats2');

            // --- AI Prompts ---
            const systemPrompt = `You are an expert football (soccer) scout with decades of experience analyzing players at the highest level for a top-tier club. Your task is to analyze the provided image(s) and any optional text data. The images contain a player's heatmap and performance statistics. The text data provides supplementary stats. You must be critical, insightful, and professional. Be mindful that the data might be from a single match, so interpret potential 'cons' with caution (e.g., distinguish between a one-off bad game and a potential persistent flaw if possible).`;

            const singleUserQuery = `Analyze the following image(s) and any provided text statistics for the player.
Based on all available data (heatmap activity, image stats, and text stats), please provide a full professional scouting report.
Note the provided match context: {MATCH_CONTEXT}

Structure your analysis with the following clear sections. Use Markdown formatting for headings.

# 1. Likely Position(s)
Identify the player's most likely position and any secondary positions (e.g., 'Primary: Box-to-Box Midfielder (CM)', 'Secondary: Deep-Lying Playmaker (DLP)'). Justify your choice based on the heatmap(s).

# 2. Key Duties & Tactical Role
Describe their primary responsibilities and tactical role on the pitch based on the data (e.g., 'Covers ground between both boxes, contributes to both defense and attack, looks to progress the ball...').

# 3. Pros
Identify 3-5 key strengths visible from the data. Be specific. (e.g., 'High Defensive Work Rate: Indicated by heavy shading in his own half and high tackle/interception numbers.', 'Passing Range: Evident from the high number of long balls completed.').

# 4. Cons & Areas for Improvement
Identify 3-5 potential weaknesses or areas for improvement. Be critical and constructive. (e.g., 'Final Third Ineffectiveness: Heatmap thins out in the opponent's box, supported by low key passes.', 'Disciplinary Issues: High number of fouls.').

# 5. Full Scouting Summary
Provide a detailed, narrative summary (2-3 paragraphs) of the player's style, impact, and overall profile. Conclude with a final verdict on their potential level (e.g., 'Solid rotational player for a top-division side', 'High-potential prospect needs refinement', 'Top-class Champions League level player').

# 6. Suggested Similar Player
Based on the complete analysis (heatmap, stats, role), suggest ONE well-known professional player with a similar playstyle. Briefly justify your choice (1-2 sentences). (e.g., "Style Comparison: N'Golo Kanté. Both players exhibit exceptional work rate, strong defensive positioning, and primarily focus on ball recovery and simple distribution.")

# 7. Suggested Development Plan
Based on the 'Cons' you identified, suggest 2-3 specific, actionable development points or drills. (e.g., "1. Final Third Decision-Making: Drills focusing on cut-back passes and shooting under pressure.", "2. Weaker Foot Usage: Dedicate 15 minutes post-training to repetitive passing and shooting with weaker foot.").
`;

            const comparisonUserQuery = `Analyze the provided data for TWO players. Player 1's data is provided first, followed by Player 2's data.
- Player 1 Context: {MATCH_CONTEXT_1}
- Player 2 Context: {MATCH_CONTEXT_2}

Provide a professional head-to-head scouting report. Structure your analysis with the following clear sections. Use Markdown formatting for headings.

# 1. Player 1 Profile (Position & Role)
Briefly identify Player 1's likely position and tactical role based on their data.

# 2. Player 2 Profile (Position & Role)
Briefly identify Player 2's likely position and tactical role based on their data.

# 3. Head-to-Head Comparison (Strengths)
Compare the players directly on 3-5 key attributes, stating who has the edge in each. (e.g., 'Work Rate: Player 1 shows superior defensive coverage...', 'Passing: Player 2 appears to be the more creative passer...').

# 4. Head-to-Head Comparison (Weaknesses)
Compare their primary weaknesses or areas for improvement.

# 5. Final Verdict & Tactical Fit
Provide a concluding summary. Which player is more impactful? Who has higher potential? What kind of tactical system would each player thrive in?
`;

            // --- Tab Navigation ---
            tabSingle.addEventListener('click', () => switchTab('single'));
            tabCompare.addEventListener('click', () => switchTab('compare'));

            function switchTab(tabName) {
                activeTab = tabName;
                if (tabName === 'single') {
                    tabSingle.classList.add('active');
                    tabCompare.classList.remove('active');
                    contentSingle.classList.add('active');
                    contentCompare.classList.remove('active');
                    buttonText.textContent = "Analyze Player";
                } else {
                    tabSingle.classList.remove('active');
                    tabCompare.classList.add('active');
                    contentSingle.classList.remove('active');
                    contentCompare.classList.add('active');
                    buttonText.textContent = "Compare Players";
                }
                updateAnalyzeButtonState();
            }

            // --- Event Listeners ---
            
            // Single Player
            imageUploadSingle.addEventListener('change', (e) => handleFiles(e.target.files, 0));
            clearButtonSingle.addEventListener('click', () => clearData(0));
            textStatsSingle.addEventListener('input', () => {
                visualizeStatsButton.disabled = textStatsSingle.value.trim() === '';
            });
            visualizeStatsButton.addEventListener('click', visualizeStats);

            // Player 1
            imageUpload1.addEventListener('change', (e) => handleFiles(e.target.files, 1));
            clearButton1.addEventListener('click', () => clearData(1));
            
            // Player 2
            imageUpload2.addEventListener('change', (e) => handleFiles(e.target.files, 2));
            clearButton2.addEventListener('click', () => clearData(2));

            // Paste event
            window.addEventListener('paste', (event) => {
                if (activeTab === 'single') {
                    handleFiles(event.clipboardData.files, 0);
                }
                // Paste for comparison tabs is ambiguous, so we'll just support single tab for now.
            });

            // Analyze Button
            analyzeButton.addEventListener('click', handleAnalysis);

            // Export Buttons
            copyButton.addEventListener('click', copyReport);
            printButton.addEventListener('click', () => window.print());

            // Guide Modal
            guideButton.addEventListener('click', () => guideModalOverlay.classList.add('visible'));
            closeGuideModal.addEventListener('click', () => guideModalOverlay.classList.remove('visible'));
            guideModalOverlay.addEventListener('click', (e) => {
                if (e.target === guideModalOverlay) {
                    guideModalOverlay.classList.remove('visible');
                }
            });

            // API Key Visibility
            toggleApiVisibility.addEventListener('click', () => {
                if (apiKeyInput.type === 'password') {
                    apiKeyInput.type = 'text';
                    eyeIcon.classList.add('hidden');
                    eyeOffIcon.classList.remove('hidden');
                } else {
                    apiKeyInput.type = 'password';
                    eyeIcon.classList.remove('hidden');
                    eyeOffIcon.classList.add('hidden');
                }
            });

            // --- File Handling Functions ---
            function handleFiles(files, playerIndex) {
                if (!files || files.length === 0) return;
                
                const imageFiles = Array.from(files).filter(file => file.type.startsWith('image/'));
                if (imageFiles.length === 0) return;

                if (playerIndex === 0) {
                    uploadPlaceholderSingle.classList.add('hidden');
                    clearButtonSingle.classList.remove('hidden');
                } else if (playerIndex === 1) {
                    uploadPlaceholder1.classList.add('hidden');
                    clearButton1.classList.remove('hidden');
                } else if (playerIndex === 2) {
                    uploadPlaceholder2.classList.add('hidden');
                    clearButton2.classList.remove('hidden');
                }

                for (const file of imageFiles) {
                    processFile(file, playerIndex);
                }
            }

            function processFile(file, playerIndex) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const dataUrl = e.target.result;
                    const parts = dataUrl.split(',');
                    const mimeTypeRaw = parts[0].match(/:(.*?);/)[1];
                    
                    playerData[playerIndex].images.push(parts[1]);
                    playerData[playerIndex].mimes.push(mimeTypeRaw);
                    
                    addImageToPreview(dataUrl, playerIndex);
                    updateAnalyzeButtonState();
                    hideError();
                };
                reader.readAsDataURL(file);
            }

            function addImageToPreview(dataUrl, playerIndex) {
                let container;
                if (playerIndex === 0) container = imagePreviewContainerSingle;
                else if (playerIndex === 1) container = imagePreviewContainer1;
                else if (playerIndex === 2) container = imagePreviewContainer2;
                
                if (!container) return;
                const img = document.createElement('img');
                img.src = dataUrl;
                img.alt = "Player data preview";
                container.appendChild(img);
            }

            function clearData(playerIndex) {
                playerData[playerIndex] = { images: [], mimes: [] };
                
                if (playerIndex === 0) {
                    imagePreviewContainerSingle.innerHTML = '';
                    uploadPlaceholderSingle.classList.remove('hidden');
                    clearButtonSingle.classList.add('hidden');
                    textStatsSingle.value = '';
                    matchContextSingle.value = '';
                    chartContainer.classList.add('hidden');
                    if (statsChartInstance) {
                        statsChartInstance.destroy();
                        statsChartInstance = null;
                    }
                    visualizeStatsButton.disabled = true;
                } else if (playerIndex === 1) {
                    imagePreviewContainer1.innerHTML = '';
                    uploadPlaceholder1.classList.remove('hidden');
                    clearButton1.classList.add('hidden');
                    textStats1.value = '';
                    matchContext1.value = '';
                } else if (playerIndex === 2) {
                    imagePreviewContainer2.innerHTML = '';
                    uploadPlaceholder2.classList.remove('hidden');
                    clearButton2.classList.add('hidden');
                    textStats2.value = '';
                    matchContext2.value = '';
                }
                
                updateAnalyzeButtonState();
                resultsSection.classList.add('hidden');
                hideError();
            }

            function updateAnalyzeButtonState() {
                if (activeTab === 'single') {
                    analyzeButton.disabled = playerData[0].images.length === 0;
                } else {
                    // Both players must have at least one image to compare
                    analyzeButton.disabled = playerData[1].images.length === 0 || playerData[2].images.length === 0;
                }
            }

            // --- Stats Visualization ---
            function visualizeStats() {
                const text = textStatsSingle.value;
                if (!text.trim()) {
                    chartContainer.classList.add('hidden');
                    return;
                }

                const lines = text.split('\n');
                const labels = [];
                const data = [];

                lines.forEach(line => {
                    const parts = line.split(':');
                    if (parts.length < 2) return;
                    
                    const label = parts[0].trim();
                    let valueString = parts[1].trim();
                    
                    // Handle "X/Y" formats like "4/5"
                    if (valueString.includes('/')) {
                        valueString = valueString.split('/')[0].trim();
                    }
                    
                    // Handle percentages like "80%"
                    if (valueString.includes('%')) {
                        valueString = valueString.replace('%', '').trim();
                    }

                    const value = parseFloat(valueString);

                    if (!isNaN(value) && label) {
                        labels.push(label);
                        data.push(value);
                    }
                });

                if (data.length === 0) {
                    showError("No parsable numeric stats found in the text box. Use format: 'Stat Name: 123'.");
                    return;
                }

                chartContainer.classList.remove('hidden');

                if (statsChartInstance) {
                    statsChartInstance.destroy();
                }

                statsChartInstance = new Chart(statsChartCanvas, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Player Stats',
                            data: data,
                            backgroundColor: 'rgba(56, 189, 248, 0.6)', // sky-400
                            borderColor: 'rgba(56, 189, 248, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        indexAxis: 'y', // Horizontal bar chart
                        responsive: true,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                displayColors: false
                            }
                        },
                        scales: {
                            x: {
                                beginAtZero: true,
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                },
                                ticks: {
                                    color: '#d1d5db' // gray-300
                                }
                            },
                            y: {
                                grid: {
                                    display: false
                                },
                                ticks: {
                                    color: '#d1d5db' // gray-300
                                }
                            }
                        }
                    }
                });
            }

            // --- Analysis & API Call ---
            function handleAnalysis() {
                setLoading(true);
                hideError();
                resultsSection.classList.add('hidden');
                
                const parts = [];
                let query;
                
                if (activeTab === 'single') {
                    // --- Single Player Analysis ---
                    const context = matchContextSingle.value || "Not specified";
                    const stats = textStatsSingle.value;
                    query = singleUserQuery.replace('{MATCH_CONTEXT}', context);
                    
                    parts.push({ text: query });
                    if (stats.trim() !== "") {
                        parts.push({ text: "\n\n# Additional Textual Stats:\n" + stats });
                    }
                    playerData[0].images.forEach((imgData, i) => {
                        parts.push({ inlineData: { mimeType: playerData[0].mimes[i], data: imgData } });
                    });
                    
                } else {
                    // --- Player Comparison Analysis ---
                    const context1 = matchContext1.value || "Not specified";
                    const stats1 = textStats1.value;
                    const context2 = matchContext2.value || "Not specified";
                    const stats2 = textStats2.value;
                    
                    query = comparisonUserQuery
                        .replace('{MATCH_CONTEXT_1}', context1)
                        .replace('{MATCH_CONTEXT_2}', context2);
                        
                    parts.push({ text: query });
                    
                    // Add Player 1 Data
                    parts.push({ text: "\n\n# --- PLAYER 1 DATA ---" });
                    if (stats1.trim() !== "") {
                        parts.push({ text: "\n# Player 1 Additional Textual Stats:\n" + stats1 });
                    }
                    playerData[1].images.forEach((imgData, i) => {
                        parts.push({ inlineData: { mimeType: playerData[1].mimes[i], data: imgData } });
                    });
                    
                    // Add Player 2 Data
                    parts.push({ text: "\n\n# --- PLAYER 2 DATA ---" });
                    if (stats2.trim() !== "") {
                        parts.push({ text: "\n# Player 2 Additional Textual Stats:\n" + stats2 });
                    }
                    playerData[2].images.forEach((imgData, i) => {
                        parts.push({ inlineData: { mimeType: playerData[2].mimes[i], data: imgData } });
                    });
                }
                
                callGeminiApi(parts);
            }

            async function callGeminiApi(parts, retryCount = 0) {
                // Check for user-provided API key
                const userApiKey = apiKeyInput.value.trim();
                const apiKey = userApiKey || ""; // Use user's key if provided, otherwise default
                
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

                const payload = {
                    contents: [{ role: "user", parts: parts }],
                    systemInstruction: {
                        parts: [{ text: systemPrompt }]
                    },
                    generationConfig: {
                        temperature: 0.3,
                    }
                };

                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 429 || response.status >= 500) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        } else {
                            const errorData = await response.json();
                            throw new Error(errorData.error?.message || "An unknown error occurred.");
                        }
                    }

                    const result = await response.json();
                    
                    if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                        const analysisText = result.candidates[0].content.parts[0].text;
                        displayResults(analysisText);
                    } else if (result.candidates?.[0]?.finishReason === "SAFETY") {
                        throw new Error("Analysis blocked due to safety settings. Try different images or text.");
                    } else {
                        throw new Error("Invalid response structure from API. No text generated.");
                    }
                    
                } catch (error) {
                    if (retryCount < 3 && error.message.includes("HTTP error")) {
                        const delay = Math.pow(2, retryCount) * 1000 + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        callGeminiApi(parts, retryCount + 1);
                    } else {
                        showError(`Failed to get analysis: ${error.message}`);
                    }
                } finally {
                    if (retryCount === 0) {
                         setLoading(false);
                    }
                }
            }

            // --- UI Helper Functions ---
            function displayResults(text) {
                // More comprehensive markdown conversion
                let html = text
                    .replace(/^# 1. (.*)/gm, '<h3 class="text-xl font-semibold text-blue-300 mt-4 mb-2">$1</h3>')
                    .replace(/^# 2. (.*)/gm, '<h3 class="text-xl font-semibold text-blue-300 mt-4 mb-2">$1</h3>')
                    .replace(/^# 3. (.*)/gm, '<h3 class="text-xl font-semibold text-blue-300 mt-4 mb-2">$1</h3>')
                    .replace(/^# 4. (.*)/gm, '<h3 class="text-xl font-semibold text-blue-300 mt-4 mb-2">$1</h3>')
                    .replace(/^# 5. (.*)/gm, '<h3 class="text-xl font-semibold text-blue-300 mt-4 mb-2">$1</h3>')
                    .replace(/^# 6. (.*)/gm, '<h3 class="text-xl font-semibold text-blue-300 mt-4 mb-2">$1</h3>')
                    .replace(/^# 7. (.*)/gm, '<h3 class="text-xl font-semibold text-blue-300 mt-4 mb-2">$1</h3>')
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); // Bold

                analysisOutput.innerHTML = html;
                resultsSection.classList.remove('hidden');
                // Re-initialize icons if they are in the results (though they aren't right now)
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
            }
            
            function copyReport() {
                const textToCopy = analysisOutput.innerText;
                // Use a temporary textarea to preserve formatting (like newlines)
                const textArea = document.createElement('textarea');
                textArea.value = textToCopy;
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    copyButton.innerHTML = '<svg data-lucide="check" class="h-4 w-4"></svg> Copied!';
                    if (typeof lucide !== 'undefined') {
                        lucide.createIcons();
                    }
                    setTimeout(() => {
                        copyButton.innerHTML = '<svg data-lucide="copy" class="h-4 w-4"></svg> Copy';
                        if (typeof lucide !== 'undefined') {
                            lucide.createIcons();
                        }
                    }, 2000);
                } catch (err) {
                    showError('Failed to copy text.');
                }
                document.body.removeChild(textArea);
            }

            function setLoading(isLoading) {
                if (isLoading) {
                    analyzeButton.disabled = true;
                    buttonText.classList.add('hidden');
                    buttonIcon.classList.add('hidden');
                    loadingSpinner.classList.remove('hidden');
                } else {
                    updateAnalyzeButtonState(); // Re-check if it should be enabled
                    buttonText.classList.remove('hidden');
                    buttonIcon.classList.remove('hidden');
                    loadingSpinner.classList.add('hidden');
                }
            }

            function showError(message) {
                errorText.textContent = message;
                errorMessage.classList.remove('hidden');
            }

            function hideError() {
                errorMessage.classList.add('hidden');
            }
            
            // --- Initialization ---
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            } else {
                console.error("Lucide icons script not loaded.");
            }

            updateAnalyzeButtonState(); // Set initial button state
            visualizeStatsButton.disabled = true; // Disabled until user types
        });
    </script>
</body>
</html>

