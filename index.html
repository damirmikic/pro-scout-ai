<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro Scout AI - Player Analysis</title>
    <!-- FAVICON -->
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cg fill='none' stroke-linecap='round'%3E%3Ccircle cx='45' cy='45' r='30' stroke='%2338bdf8' stroke-width='10'/%3E%3Cline x1='65' y1='65' x2='85' y2='85' stroke='%239ca3af' stroke-width='12'/%3E%3C/g%3E%3Cg fill='%232dd4bf'%3E%3Crect x='30' y='40' width='8' height='20' rx='2'/%3E%3Crect x='41' y='30' width='8' height='30' rx='2'/%3E%3Crect x='52' y='35' width='8' height='25' rx='2'/%3E%3C/g%3E%3C/svg%3E" type="image/svg+xml">
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Lucide icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Load Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Load PDF generation libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* Use Inter font */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom styles for the file input */
        .file-input-label {
            cursor: pointer;
        }
        /* Simple spinner animation */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-left-color: #ffffff;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        .spinner-sm {
            width: 16px;
            height: 16px;
            border-width: 2px;
        }
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
        
        /* Styles for image preview containers */
        .image-preview-container {
            display: flex;
            overflow-x: auto;
            overflow-y: hidden;
            white-space: nowrap;
            padding-bottom: 8px; /* For scrollbar visibility */
            min-height: 100px;
            background: rgba(0,0,0,0.1);
            border-radius: 8px;
        }
        .image-preview-container img {
            max-height: 200px; /* Smaller for comparison view */
            height: auto;
            width: auto;
            object-fit: contain;
            border-radius: 8px;
            margin-right: 12px;
            flex-shrink: 0;
        }
        /* Larger preview for single player tab */
        #imagePreviewContainerSingle img {
            max-height: 300px;
        }

        /* Custom scrollbar */
        .image-preview-container::-webkit-scrollbar,
        #chatHistory::-webkit-scrollbar,
        #searchScroller::-webkit-scrollbar { 
            height: 8px;
            width: 8px;
        }
        .image-preview-container::-webkit-scrollbar-track,
        #chatHistory::-webkit-scrollbar-track,
        #searchScroller::-webkit-scrollbar-track { 
            background: #4a5568; 
            border-radius: 4px; 
        }
        .image-preview-container::-webkit-scrollbar-thumb,
        #chatHistory::-webkit-scrollbar-thumb,
        #searchScroller::-webkit-scrollbar-thumb { 
            background: #718096; 
            border-radius: 4px; 
        }
        .image-preview-container::-webkit-scrollbar-thumb:hover,
        #chatHistory::-webkit-scrollbar-thumb:hover,
        #searchScroller::-webkit-scrollbar-thumb:hover { 
            background: #a0aec0; 
        }

        /* Tab styles */
        .tab-button {
            padding: 0.75rem 1rem;
            font-weight: 600;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            color: #9ca3af; /* gray-400 */
            white-space: nowrap; /* Prevent tabs from wrapping */
        }
        .tab-button.active {
            color: #38bdf8; /* sky-400 */
            border-color: #38bdf8;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }

        /* Modal styles */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.75);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: #1f2937; /* gray-800 */
            color: #d1d5db; /* gray-300 */
            padding: 1.5rem;
            border-radius: 0.75rem;
            max-width: 90%;
            width: 50rem;
            max-height: 80vh;
            overflow-y: auto;
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }
        .modal-overlay.visible .modal-content {
            transform: scale(1);
        }
        .modal-content h2 {
            font-size: 1.5rem;
            font-weight: 700;
            color: #ffffff;
            margin-bottom: 1rem;
        }
        .modal-content h3 {
            font-size: 1.25rem;
            font-weight: 600;
            color: #38bdf8; /* sky-400 */
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
        }
        .modal-content p {
            line-height: 1.6;
            margin-bottom: 1rem;
        }
        .modal-content ol, .modal-content ul {
            list-style-type: decimal;
            padding-left: 1.5rem;
            margin-bottom: 1rem;
        }
        .modal-content li {
            margin-bottom: 0.5rem;
        }
        
        /* PDF Preview Modal */
        #pdfPreviewModalOverlay .modal-content {
            width: 60rem; /* Wider for PDF */
            max-width: 95%;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }
        #pdfPreviewFrame {
            width: 100%;
            height: 70vh; /* Make iframe tall */
            border: 1px solid #4b5563; /* gray-600 */
            border-radius: 0.5rem;
            background-color: #ffffff;
        }

        /* Custom Radio Button Styles */
        .radio-label {
            display: inline-flex;
            align-items: center;
            cursor: pointer;
            padding: 0.75rem 1.25rem;
            border: 2px solid #4b5563; /* gray-600 */
            border-radius: 0.5rem;
            transition: all 0.2s ease;
            background-color: #374151; /* gray-700 */
            color: #d1d5db; /* gray-300 */
        }
        .radio-label:hover {
            background-color: #4b5563; /* gray-600 */
        }
        .radio-input {
            display: none;
        }
        .radio-input:checked + .radio-label {
            background-color: #0c4a6e; /* sky-900 */
            border-color: #38bdf8; /* sky-400 */
            color: #e0f2fe; /* sky-100 */
            box-shadow: 0 0 10px rgba(56, 189, 248, 0.3);
        }
        .radio-circle {
            width: 1.25em;
            height: 1.25em;
            border-radius: 50%;
            border: 2px solid #9ca3af; /* gray-400 */
            margin-right: 0.75rem;
            display: inline-block;
            position: relative;
        }
        .radio-input:checked + .radio-label .radio-circle {
            border-color: #38bdf8; /* sky-400 */
        }
        .radio-input:checked + .radio-label .radio-circle::after {
            content: '';
            width: 0.75em;
            height: 0.75em;
            border-radius: 50%;
            background-color: #38bdf8; /* sky-400 */
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        
        /* API Key fields */
        #apiKeyMessage {
            color: #10b981; /* emerald-500 */
            font-size: 0.9rem;
            display: none;
        }
        #apiKeyMessage.visible {
            display: block;
        }
        #apiKeyClearButton {
            color: #f87171; /* red-400 */
            text-decoration: underline;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
            margin-left: 0.5rem;
        }
        #apiKeyInputContainer.hidden {
            display: none;
        }
        
        /* Chatbot styles */
        #chatHistory {
            height: 400px;
            overflow-y: auto;
            background-color: #111827; /* gray-900 */
            border-radius: 0.5rem;
            padding: 1rem;
            border: 1px solid #374151; /* gray-700 */
        }
        .chat-message {
            padding: 0.75rem 1rem;
            border-radius: 0.75rem;
            margin-bottom: 1rem;
            max-width: 80%;
            line-height: 1.6;
            word-wrap: break-word; /* Ensure text wraps */
        }
        .chat-message.user {
            background-color: #1d4ed8; /* blue-700 */
            color: #e0f2fe; /* blue-100 */
            margin-left: auto;
            align-self: flex-end;
        }
        .chat-message.ai {
            background-color: #374151; /* gray-700 */
            color: #d1d5db; /* gray-300 */
            margin-right: auto;
            align-self: flex-start;
        }
        .chat-message.ai.loading {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-style: italic;
            color: #9ca3af; /* gray-400 */
        }
        /* Style for HTML content in chat */
        .chat-message.ai strong {
            color: #e5e7eb; /* gray-200 */
            font-weight: 600;
        }
        .chat-message.ai ul {
            list-style-type: disc;
            padding-left: 1.25rem;
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
        }
        
        /* Resources tab styles */
        #contentResources ul {
            list-style-type: disc;
            padding-left: 1.5rem;
        }
        #contentResources li {
            margin-bottom: 1rem;
        }
        #contentResources a {
            color: #38bdf8; /* sky-400 */
            text-decoration: underline;
            font-weight: 500;
        }
        #contentResources a:hover {
            color: #7dd3fc; /* sky-300 */
        }
        #contentResources p {
            color: #d1d5db; /* gray-300 */
            line-height: 1.6;
            margin-bottom: 0.5rem;
        }
        #contentResources h3 {
            font-size: 1.25rem;
            font-weight: 600;
            color: #e5e7eb; /* gray-200 */
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 1px solid #374151; /* gray-700 */
            padding-bottom: 0.25rem;
        }
        
        /* Advanced Search Results */
        #searchScroller {
            max-height: 600px;
            overflow-y: auto;
            background: #111827;
            border-radius: 8px;
            padding: 1rem;
        }
        #searchResults table {
            width: 100%;
            border-collapse: collapse;
        }
        #searchResults th, #searchResults td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #374151; /* gray-700 */
        }
        #searchResults th {
            background-color: #374151; /* gray-700 */
            font-weight: 600;
            color: #d1d5db; /* gray-300 */
        }
        #searchResults tr:hover {
            background-color: #1f2937; /* gray-800 */
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 flex items-center justify-center min-h-screen p-4">
    
    <div class="w-full max-w-6xl mx-auto p-6 md:p-8 bg-gray-800 rounded-2xl shadow-2xl">
        <header class="text-center mb-4 relative">
            <h1 class="text-3xl md:text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-teal-300">
                Pro Scout AI
            </h1>
            <p class="text-lg text-gray-400 mt-2">Professional-grade player analysis, powered by AI.</p>
            <button id="guideButton" class="absolute top-0 right-0 flex items-center gap-2 px-3 py-1 bg-gray-700 text-gray-300 rounded-md hover:bg-gray-600 transition-colors text-sm">
                <svg data-lucide="help-circle" class="h-4 w-4"></svg>
                How to Use
            </button>
        </header>

        <!-- Tab Navigation -->
        <nav class="flex border-b border-gray-700 mb-6 overflow-x-auto">
            <button id="tabSingle" class="tab-button active">Single Player Analysis</button>
            <button id="tabCompare" class="tab-button">Player Comparison</button>
            <button id="tabOpposition" class="tab-button">Opposition Analysis</button>
            <button id="tabSearch" class="tab-button">Advanced Search</button>
            <button id="tabChatbot" class="tab-button">Scout AI Chatbot</button>
            <button id="tabResources" class="tab-button">Resources</button>
        </nav>

        <main>
            <!-- ======================= -->
            <!-- SINGLE PLAYER TAB       -->
            <!-- ======================= -->
            <div id="contentSingle" class="tab-content active">
                <!-- Upload Section -->
                <div id="uploadBoxSingle" class="flex flex-col items-center justify-center bg-gray-700 p-6 rounded-lg border-2 border-dashed border-gray-500 min-h-[24rem]">
                    <div id="imagePreviewContainerSingle" class="w-full mb-4 image-preview-container">
                        <!-- Images will be added here dynamically -->
                    </div>
                    <div id="uploadPlaceholderSingle" class="text-center text-gray-400">
                        <svg class="mx-auto h-16 w-16 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.409a2.25 2.25 0 013.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 001.5-1.5V6a1.5 1.5 0 00-1.5-1.5H3.75A1.5 1.5 0 002.25 6v12a1.5 1.5 0 001.5 1.5zm10.5-11.25h.008v.008h-.008V8.25zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z" /></svg>
                        <p class="mt-2 font-semibold">Drag & Drop, Paste, or Select Images</p>
                    </div>
                    <div class="flex gap-4 mt-4">
                        <label class="file-input-label px-4 py-2 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 transition-colors cursor-pointer">
                            <span>Select Image(s)</span>
                            <input type="file" id="imageUploadSingle" accept="image/png, image/jpeg" class="hidden" multiple>
                        </label>
                        <button id="clearButtonSingle" class="hidden px-4 py-2 bg-red-600 text-white rounded-lg shadow-md hover:bg-red-700 transition-colors">
                            Clear All
                        </button>
                    </div>
                </div>

                <!-- Player Info Section -->
                <div id="playerInfoSection" class="mt-6 p-4 bg-gray-700/50 rounded-lg">
                    <h3 class="text-lg font-semibold text-gray-200 mb-4">Player Information</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="playerName" class="mb-1 block text-sm font-medium text-gray-300">Player Name</label>
                            <input type="text" id="playerName" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-gray-200 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., John Doe">
                        </div>
                        <div>
                            <label for="playerAge" class="mb-1 block text-sm font-medium text-gray-300">Age</label>
                            <input type="number" id="playerAge" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-gray-200 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., 22">
                        </div>
                        <div>
                            <label for="playerRating" class="mb-1 block text-sm font-medium text-gray-300">Player Rating (A/B, 5-9, etc.)</label>
                            <input type="text" id="playerRating" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-gray-200 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., A-, 8.1, Green">
                        </div>
                        <div>
                            <label for="playerClub" class="mb-1 block text-sm font-medium text-gray-300">Club</label>
                            <input type="text" id="playerClub" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-gray-200 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., AC Milan">
                        </div>
                        <div>
                            <label for="playerLeague" class="mb-1 block text-sm font-medium text-gray-300">League</label>
                            <input type="text" id="playerLeague" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-gray-200 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., Serie A">
                        </div>
                        <div>
                            <label for="matchContextSingle" class="mb-1 block text-sm font-medium text-gray-300">Match Observed</label>
                            <input type="text" id="matchContextSingle" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-gray-200 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., vs. Liverpool, 90 mins">
                        </div>
                    </div>
                </div>

                <!-- Controls and Text Input -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                    <!-- Report Type -->
                    <div id="reportTypeSection">
                        <label class="mb-3 block font-semibold text-gray-300">Report Type</label>
                        <div class="flex gap-4">
                            <input type="radio" id="reportQuick" name="reportType" value="quick" class="radio-input" checked>
                            <label for="reportQuick" class="radio-label w-full justify-center">
                                <span class="radio-circle"></span>
                                Quick Report
                            </label>

                            <input type="radio" id="reportPro" name="reportType" value="pro" class="radio-input">
                            <label for="reportPro" class="radio-label w-full justify-center">
                                <span class="radio-circle"></span>
                                Pro Scout Report
                            </label>
                        </div>
                    </div>
                    
                    <!-- Stats Input -->
                    <div>
                        <label for="textStatsSingle" class="mb-2 block font-semibold text-gray-300">Optional: Paste Additional Stats</label>
                        <textarea id="textStatsSingle" rows="5" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-gray-200 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g.,&#10;Goals: 1&#10;Assists: 0&#10;Tackles: 4/5..."></textarea>
                        <button id="visualizeStatsButton" class="mt-2 w-full flex items-center justify-center gap-2 bg-teal-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-teal-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                            <svg data-lucide="bar-chart-3" class="h-5 w-5"></svg>
                            Visualize Text Stats
                        </button>
                    </div>
                </div>

                <!-- Stats Visualization Canvas -->
                <div id="chartContainer" class="hidden mt-6 bg-gray-700 p-4 rounded-lg">
                    <h3 class="text-lg font-semibold text-gray-200 mb-2">Text Stats Visualization</h3>
                    <canvas id="statsChart"></canvas>
                </div>
            </div>

            <!-- ======================= -->
            <!-- COMPARISON TAB          -->
            <!-- ======================= -->
            <div id="contentCompare" class="tab-content">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Player 1 Column -->
                    <div id="uploadBox1" class="bg-gray-700 p-4 rounded-lg">
                        <h3 class="text-xl font-bold text-center text-blue-300 mb-4">Player 1</h3>
                        <div id="imagePreviewContainer1" class="w-full mb-4 image-preview-container"></div>
                        <div id="uploadPlaceholder1" class="text-center text-gray-400 py-8">
                            <svg class="mx-auto h-12 w-12 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.409a2.25 2.25 0 013.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 001.5-1.5V6a1.5 1.5 0 00-1.5-1.5H3.75A1.5 1.5 0 002.25 6v12a1.5 1.5 0 001.5 1.5zm10.5-11.25h.008v.008h-.008V8.25zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z" /></svg>
                            <p class="mt-1 text-sm font-semibold">Upload/Paste Player 1 Images</p>
                        </div>
                        <div class="flex gap-4 mt-2 justify-center">
                            <label class="file-input-label px-3 py-2 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 transition-colors cursor-pointer text-sm">
                                <span>Select Image(s)</span>
                                <input type="file" id="imageUpload1" accept="image/png, image/jpeg" class="hidden" multiple>
                            </label>
                            <button id="clearButton1" class="hidden px-3 py-2 bg-red-600 text-white rounded-lg shadow-md hover:bg-red-700 transition-colors text-sm">Clear</button>
                        </div>
                        <label for="matchContext1" class="mt-4 mb-2 block font-semibold text-gray-300 text-sm">Context (Optional)</label>
                        <input type="text" id="matchContext1" class="w-full p-2 bg-gray-600 border border-gray-500 rounded-lg text-gray-200 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm" placeholder="e.g., vs. Liverpool">
                        <label for="textStats1" class="mt-4 mb-2 block font-semibold text-gray-300 text-sm">Stats (Optional)</label>
                        <textarea id="textStats1" rows="4" class="w-full p-2 bg-gray-600 border border-gray-500 rounded-lg text-gray-200 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm" placeholder="Paste Player 1 stats..."></textarea>
                    </div>

                    <!-- Player 2 Column -->
                    <div id="uploadBox2" class="bg-gray-700 p-4 rounded-lg">
                        <h3 class="text-xl font-bold text-center text-teal-300 mb-4">Player 2</h3>
                        <div id="imagePreviewContainer2" class="w-full mb-4 image-preview-container"></div>
                        <div id="uploadPlaceholder2" class="text-center text-gray-400 py-8">
                            <svg class="mx-auto h-12 w-12 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.409a2.25 2.25 0 013.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 001.5-1.5V6a1.5 1.s 0 00-1.5-1.5H3.75A1.5 1.5 0 002.25 6v12a1.5 1.5 0 001.5 1.5zm10.5-11.25h.008v.008h-.008V8.25zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z" /></svg>
                            <p class="mt-1 text-sm font-semibold">Upload/Paste Player 2 Images</p>
                        </div>
                        <div class="flex gap-4 mt-2 justify-center">
                            <label class="file-input-label px-3 py-2 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 transition-colors cursor-pointer text-sm">
                                <span>Select Image(s)</span>
                                <input type="file" id="imageUpload2" accept="image/png, image/jpeg" class="hidden" multiple>
                            </label>
                            <button id="clearButton2" class="hidden px-3 py-2 bg-red-600 text-white rounded-lg shadow-md hover:bg-red-700 transition-colors text-sm">Clear</button>
                        </div>
                        <label for="matchContext2" class="mt-4 mb-2 block font-semibold text-gray-300 text-sm">Context (Optional)</label>
                        <input type="text" id="matchContext2" class="w-full p-2 bg-gray-600 border border-gray-500 rounded-lg text-gray-200 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm" placeholder="e.g., vs. Chelsea">
                        <label for="textStats2" class="mt-4 mb-2 block font-semibold text-gray-300 text-sm">Stats (Optional)</label>
                        <textarea id="textStats2" rows="4" class="w-full p-2 bg-gray-600 border border-gray-500 rounded-lg text-gray-200 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm" placeholder="Paste Player 2 stats..."></textarea>
                    </div>
                </div>
            </div>
            
            <!-- ======================= -->
            <!-- OPPOSITION TAB          -->
            <!-- ======================= -->
            <div id="contentOpposition" class="tab-content">
                <!-- Inputs -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="opponentName" class="mb-2 block font-semibold text-gray-300">Opponent Name</label>
                        <input type="text" id="opponentName" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-gray-200 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., Liverpool">
                        
                        <label for="matchContextOpp" class="mt-4 mb-2 block font-semibold text-gray-300">Match Context (Optional)</label>
                        <input type="text" id="matchContextOpp" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-gray-200 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., Our Team: Man City, FA Cup Final">
                        
                        <label for="textStatsOpponent" class="mt-4 mb-2 block font-semibold text-gray-300">Paste Team Stats (Optional)</label>
                        <textarea id="textStatsOpponent" rows="8" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-gray-200 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g.,&#10;Avg Possession: 58%&#10;Goals For: 12 (last 5 games)&#10;Key Player: Mohamed Salah..."></textarea>
                    </div>
                    <!-- Upload Section -->
                    <div>
                        <label class="mb-2 block font-semibold text-gray-300">Upload Images (Formations, Heatmaps, etc.)</label>
                        <div id="uploadBoxOpponent" class="flex flex-col items-center justify-center bg-gray-700 p-6 rounded-lg border-2 border-dashed border-gray-500 min-h-[16rem]">
                            <div id="imagePreviewContainerOpponent" class="w-full mb-4 image-preview-container">
                                <!-- Images will be added here dynamically -->
                            </div>
                            <div id="uploadPlaceholderOpponent" class="text-center text-gray-400">
                                <svg class="mx-auto h-12 w-12 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.409a2.25 2.25 0 013.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 001.5-1.5V6a1.5 1.5 0 00-1.5-1.5H3.75A1.5 1.5 0 002.25 6v12a1.5 1.5 0 001.5 1.5zm10.5-11.25h.008v.008h-.008V8.25zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z" /></svg>
                                <p class="mt-2 text-sm font-semibold">Drag & Drop, Paste, or Select Images</p>
                            </div>
                            <div class="flex gap-4 mt-4">
                                <label class="file-input-label px-3 py-2 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 transition-colors cursor-pointer text-sm">
                                    <span>Select Image(s)</span>
                                    <input type="file" id="imageUploadOpponent" accept="image/png, image/jpeg" class="hidden" multiple>
                                </label>
                                <button id="clearButtonOpponent" class="hidden px-3 py-2 bg-red-600 text-white rounded-lg shadow-md hover:bg-red-700 transition-colors text-sm">
                                    Clear All
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ======================= -->
            <!-- ADVANCED SEARCH TAB     -->
            <!-- ======================= -->
            <div id="contentSearch" class="tab-content">
                <p class="text-sm text-gray-400 mb-6 text-center">Find players matching specific criteria. Uses Google Search for real-time data.</p>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
                    <!-- Column 1 -->
                    <div>
                        <label for="searchPosition" class="mb-1 block text-sm font-medium text-gray-300">Position</label>
                        <input type="text" id="searchPosition" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-gray-200 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., Striker, DM, Left Winger">
                        
                        <label for="searchNationality" class="mt-4 mb-1 block text-sm font-medium text-gray-300">Nationality / Passport</label>
                        <input type="text" id="searchNationality" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-gray-200 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., Brazilian, EU Passport">
                    
                        <label for="searchLeague" class="mt-4 mb-1 block text-sm font-medium text-gray-300">Suitable for League</label>
                        <input type="text" id="searchLeague" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-gray-200 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., Bundesliga, Top 5 leagues">
                    </div>
                    <!-- Column 2 -->
                    <div>
                        <label for="searchAgeMin" class="mb-1 block text-sm font-medium text-gray-300">Age</label>
                        <div class="flex gap-2">
                            <input type="number" id="searchAgeMin" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-gray-200 placeholder-gray-400" placeholder="Min">
                            <input type="number" id="searchAgeMax" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-gray-200 placeholder-gray-400" placeholder="Max">
                        </div>
                        
                        <label for="searchValueMin" class="mt-4 mb-1 block text-sm font-medium text-gray-300">Market Value (Millions)</label>
                        <div class="flex gap-2">
                            <input type="number" id="searchValueMin" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-gray-200 placeholder-gray-400" placeholder="Min €">
                            <input type="number" id="searchValueMax" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-gray-200 placeholder-gray-400" placeholder="Max €">
                        </div>
                        
                        <label for="searchContract" class="mt-4 mb-1 block text-sm font-medium text-gray-300">Contract Expires</Gabel>
                        <select id="searchContract" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Any</option>
                            <option value="in last 6 months">Last 6 months</option>
                            <option value="in last 1 year">Last 1 year</option>
                            <option value="1-2 years remaining">1-2 years</option>
                            <option value="2+ years remaining">2+ years</option>
                        </select>
                    </div>
                    <!-- Column 3 -->
                    <div>
                        <label for="searchStats" class="mb-1 block text-sm font-medium text-gray-300">Specific Stats (This Season)</label>
                        <textarea id="searchStats" rows="4" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-gray-200 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., >10 goals, >80% pass accuracy, >3 tackles p90"></textarea>
                        
                        <label for="searchMatches" class="mt-4 mb-1 block text-sm font-medium text-gray-300">Matches / Minutes</label>
                        <input type="text" id="searchMatches" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg text-gray-200 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., >20 matches, >1500 minutes">
                    </div>
                </div>
                
                <button id="searchButton" class="w-full flex items-center justify-center gap-2 bg-gradient-to-r from-blue-500 to-teal-500 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:from-blue-600 hover:to-teal-600 transition-all duration-300">
                    <svg data-lucide="search" class="h-5 w-5"></svg>
                    Search Players
                </button>
                
                <!-- Search Results -->
                <div id="searchResultsContainer" class="hidden mt-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-gray-100">Search Results</h2>
                        <button id="downloadSearchButton" class="flex items-center gap-2 px-3 py-1 bg-gray-600 text-gray-200 rounded-md hover:bg-gray-500 transition-colors text-sm">
                            <svg data-lucide="download" class="h-4 w-4"></svg>
                            Download CSV
                        </button>
                    </div>
                    <div id="searchScroller">
                        <div id="searchResults" class="text-gray-300">
                            <!-- Search results will be injected here -->
                        </div>
                    </div>
                </div>
                
                <div id="searchErrorMessage" class="hidden mt-4 bg-red-800 border border-red-600 text-red-200 px-4 py-3 rounded-lg" role="alert">
                    <strong class="font-bold">Error:</strong>
                    <span class="block sm:inline" id="searchErrorText"></span>
                </div>
            </div>
            
            <!-- ======================= -->
            <!-- CHATBOT TAB             -->
            <!-- ======================= -->
            <div id="contentChatbot" class="tab-content">
                <p class="text-sm text-gray-400 mb-4 text-center">Your AI scouting assistant. Ask about players, teams, stats, or tactics. Powered by Google Search.</p>
                <div id="chatHistory" class="mb-4 flex flex-col gap-4">
                    <!-- Chat messages will be appended here -->
                    <div class="chat-message ai">
                        Hello! I'm your AI scouting assistant. How can I help you today?
                    </div>
                </div>
                <div class="flex gap-2">
                    <input type="text" id="chatInput" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-gray-200 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ask about a player, team, or statistic...">
                    <button id="chatSendButton" class="p-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50">
                        <svg data-lucide="send" class="h-5 w-5"></svg>
                    </button>
                    <button id="chatNewButton" class="p-3 bg-gray-600 text-white rounded-lg hover:bg-gray-500" title="Start New Chat">
                        <svg data-lucide="refresh-cw" class="h-5 w-5"></svg>
                    </button>
                </div>
            </div>
            
            <!-- ======================= -->
            <!-- RESOURCES TAB           -->
            <!-- ======================= -->
            <div id="contentResources" class="tab-content">
                <p class="text-lg text-gray-300 mb-6">Here is a list of excellent resources for data collection and scouting. This app works best when combined with high-quality data from these sources.</p>
                
                <h3>Primary Data & Statistics</h3>
                <ul>
                    <li>
                        <a href="https://www.sofascore.com" target="_blank">Sofascore</a>
                        <p>Excellent for live scores, in-depth match statistics, and player heatmaps. The source for many of the images this tool is designed to analyze.</p>
                    </li>
                    <li>
                        <a href="https://www.flashscore.com" target="_blank">Flashscore</a>
                        <p>Similar to Sofascore, providing fast live data, stats, and player ratings for a vast number of leagues.</p>
                    </li>
                    <li>
                        <a href="https://fbref.com" target="_blank">FBref (StatsBomb)</a>
                        <p>The gold standard for in-depth, advanced football statistics. In partnership with StatsBomb, it provides detailed percentile rankings, scouting reports, and comparison tools.</p>
                    </li>
                    <li>
                        <a href="https://www.transfermarkt.com" target="_blank">Transfermarkt</a>
                        <p>The best resource for player market values, contract information, agent details, and transfer history.</p>
                    </li>
                </ul>
                
                <h3>Tactical Analysis & Professional Tools</h3>
                <ul>
                    <li>
                        <a href="https://wyscout.com" target="_blank">Wyscout</a>
                        <p>A professional platform used by clubs worldwide. It offers a massive video library for analyzing any player or team, along with advanced data and tools.</p>
                    </li>
                    <li>
                        <a href="https://www.theanalyst.com" target="_blank">The Analyst (Opta)</a>
                        <p>High-level tactical articles and data insights powered by Opta data. Great for understanding modern tactical trends.</p>
                    </li>
                    <li>
                        <a href="https://breakingthelines.com" target="_blank">Breaking The Lines</a>
                        <p>Features excellent, in-depth articles on rising talents, tactical profiles, and team analyses from around the world.</p>
                    </li>
                </ul>
                
                <h3>Public Books & Scouting Guides</h3>
                <ul>
                    <li>
                        <a href="https://footballina.com/i/the-art-of-scouting-by-chelsea-fc.pdf" target="_blank">The Art of Scouting (Chelsea FC)</a>
                        <p>A publicly shared PDF guide from Chelsea FC's academy, detailing their scouting principles and processes. An excellent look into a top club's methodology.</p>
                    </li>
                    <li>
                        <a href="https://www.soccerscouting.net/free-books" target="_blank">SoccerScouting.net Free Books</a>
                        <p>A collection of free e-books covering talent identification, player analysis, and the fundamentals of professional scouting.</p>
                    </li>
                    <li>
                        <a href="https://web.archive.org/web/20210506192233/http://www.11tegen11.net/wp-content/uploads/2014/12/Introduction-to-Football-Tactics-1.0.pdf" target="_blank">Introduction to Football Tactics (Archived)</a>
                        <p>A fantastic primer on football tactics. Understanding tactics is essential for effective player scouting and analysis.</p>
                    </li>
                </ul>
            </div>

            <!-- ======================= -->
            <!-- ANALYSIS CONTROLS       -->
            <!-- ======================= -->
            <div id="analysisControls" class="mt-6">
                <!-- API Key Input -->
                <div class="mb-4">
                    <label for="apiKey" class="mb-2 block text-sm font-semibold text-gray-400">Optional: Your Gemini API Key</label>
                    <div id="apiKeyInputContainer" class="flex items-center gap-2">
                        <input type="password" id="apiKey" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-gray-200 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Enter your API key">
                        <button type="button" id="toggleApiVisibility" class="p-3 bg-gray-600 rounded-lg text-gray-300 hover:bg-gray-500">
                            <svg data-lucide="eye" id="eyeIcon" class="h-5 w-5"></svg>
                            <svg data-lucide="eye-off" id="eyeOffIcon" class="h-5 w-5 hidden"></svg>
                        </button>
                        <button type="button" id="apiKeySaveButton" class="p-3 bg-green-600 text-white rounded-lg hover:bg-green-700">
                            <svg data-lucide="save" class="h-5 w-5"></svg>
                        </button>
                    </div>
                    <div id="apiKeyMessage" class="mt-2">
                        Key saved!
                        <button id="apiKeyClearButton"> [Clear Key]</button>
                    </div>
                </div>

                <button id="analyzeButton" class="w-full flex items-center justify-center gap-2 bg-gradient-to-r from-blue-500 to-teal-500 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:from-blue-600 hover:to-teal-600 transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg id="buttonIcon" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 17.25v1.007a3 3 0 01-.879 2.122L7.5 21M9 17.25v-1.007a3 3 0 00-.879-2.122L7.5 15M9 17.25H15M15 17.25v1.007a3 3 0 00.879 2.122L16.5 21M15 17.25v-1.007a3 3 0 01.879-2.122L16.5 15M15 17.25H9M9 15h6M9 15c-1.036 0-1.875-.84-1.875-1.875v-1.25c0-1.036.84-1.875 1.875-1.875h6c1.036 0 1.875.84 1.875 1.875v1.25c0-1.036-.84-1.875-1.875-1.875M9 15v-1.875c0-1.036.84-1.875 1.875-1.875h6c1.036 0 1.875.84 1.875 1.875V15M9 9.75h6c1.036 0 1.875-.84 1.875-1.875v-1.25c0-1.036-.84-1.875-1.875-1.875h-6c-1.036 0-1.875.84-1.875-1.875v1.25c0 1.036.84 1.875 1.875 1.875z" />
                    </svg>
                    <span id="buttonText">Analyze Player</span>
                    <div id="loadingSpinner" class="spinner hidden"></div>
                </button>
                
                <!-- Error Message Box -->
                <div id="errorMessage" class="hidden mt-4 bg-red-800 border border-red-600 text-red-200 px-4 py-3 rounded-lg" role="alert">
                    <strong class="font-bold">Error:</strong>
                    <span class="block sm:inline" id="errorText"></span>
                </div>
            </div>

            <!-- ======================= -->
            <!-- RESULTS SECTION         -->
            <!-- ======================= -->
            <div id="resultsSection" class="hidden mt-8 bg-gray-700/50 p-6 rounded-lg">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-gray-100">Scouting Report</h2>
                    <div id="reportActions" class="flex gap-2">
                        <button id="copyButton" class="flex items-center gap-2 px-3 py-1 bg-gray-600 text-gray-200 rounded-md hover:bg-gray-500 transition-colors text-sm">
                            <svg data-lucide="copy" class="h-4 w-4"><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><rect x="7" y="5" width="6" height="6" rx="1"></rect></svg>
                            Copy
                        </button>
                        <button id="previewButton" class="flex items-center gap-2 px-3 py-1 bg-gray-600 text-gray-200 rounded-md hover:bg-gray-500 transition-colors text-sm">
                            <svg data-lucide="file-check" class="h-4 w-4"></svg>
                            Preview PDF
                        </button>
                    </div>
                </div>
                <div id="analysisOutput" class="text-gray-300 leading-relaxed whitespace-pre-line">
                    <!-- AI analysis will be injected here -->
                </div>
            </div>
        </main>
    </div>

    <!-- ======================= -->
    <!-- "HOW TO USE" MODAL      -->
    <!-- ======================= -->
    <div id="guideModalOverlay" class="modal-overlay">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl">How to Use Pro Scout AI</h2>
                <button id="closeGuideModal" class="text-gray-400 hover:text-white">
                    <svg data-lucide="x" class="h-6 w-6"></svg>
                </button>
            </div>
            
            <p>Welcome! This app helps you create professional scouting reports by analyzing images (like heatmaps and stat graphics) and text data.</p>

            <h3 class="text-xl">Single Player Analysis</h3>
            <ol>
                <li><strong>Upload Images:</strong> Click "Select Image(s)" or drag-and-drop heatmap/stats images into the upload box. You can also paste an image from your clipboard (Ctrl+V/Cmd+V).</li>
                <li><strong>Add Player Info (Optional):</strong> Fill in the player's Name, Age, Club, League, Rating, and the Match you observed. This is highly recommended for the "Pro Scout Report".</li>
                <li><strong>Add Text Stats (Optional):</strong> Paste any extra stats (e.g., `Goals: 1`) into the "Additional Stats" box.</li>
                <li><strong>Visualize (Optional):</strong> If you added text stats, click "Visualize Text Stats" to see a simple bar chart of that data.</li>
                <li><strong>Select Report Type:</strong> Choose "Quick Report" for a 7-point summary or "Pro Scout Report" for a detailed 8-section analysis.</li>
                <li><strong>Analyze:</strong> Click the "Analyze Player" button.</li>
                <li><strong>Export:</strong> Use the "Copy" or "Preview PDF" buttons to save your report. The new PDF preview is a professional, multi-page document that includes your charts and images.</li>
            </ol>

            <h3 class="text-xl">Player Comparison</h3>
            <ol>
                <li><strong>Switch Tab:</strong> Click "Player Comparison" at the top.</li>
                <li><strong>Upload for Player 1 & 2:</strong> Use the two boxes to upload images and add optional context/stats for both players.</li>
                <li><strong>Analyze:</strong> Click the "Compare Players" button.</li>
            </ol>
            
            <h3 class="text-xl">Opposition Analysis</h3>
            <ol>
                <li><strong>Switch Tab:</strong> Click "Opposition Analysis" at the top.</li>
                <li><strong>Add Info:</strong> Enter the Opponent's Name, Match Context, and any team stats you have.</li>
                <li><strong>Upload Images:</strong> Upload any relevant images (formations, team heatmaps, etc.).</li>
                <li><strong>Analyze:</strong> Click the "Analyze Opposition" button.</li>
            </ol>
            
            <h3 class="text-xl">Advanced Search</h3>
            <ol>
                <li><strong>Switch Tab:</strong> Click "Advanced Search" at the top.</li>
                <li><strong>Enter Criteria:</strong> Fill in any fields you want to search by (e.g., Age 18-22, Position: Striker, Market Value: < 10M).</li>
                <li><strong>Search:</strong> Click the "Search Players" button. The AI will use Google Search to find real players.</li>
                <li><strong>Review & Download:</strong> The results will appear in a table. You can download this list as a CSV file.</li>
            </ol>
            
            <h3 class="text-xl">Scout AI Chatbot</h3>
            <ol>
                <li><strong>Switch Tab:</strong> Click "Scout AI Chatbot" at the top.</li>
                <li><strong>Ask Questions:</strong> Type any scouting-related question into the input field and press Enter or the Send button.</li>
                <li><strong>Real-time Info:</strong> The bot uses Google Search to answer questions about recent form, stats, or tactics.</li>
                <li><strong>New Chat:</strong> Click the "Refresh" icon to clear the conversation.</li>
            </ol>
            
            <h3 class="text-xl">Resources</h3>
            <p>This tab contains a list of useful websites for data collection to help you get the most out of this tool.</p>
        </div>
    </div>
    
    <!-- ======================= -->
    <!-- PDF PREVIEW MODAL       -->
    <!-- ======================= -->
    <div id="pdfPreviewModalOverlay" class="modal-overlay">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl">PDF Report Preview</h2>
                <button id="closePreviewModal" class="text-gray-400 hover:text-white">
                    <svg data-lucide="x" class="h-6 w-6"></svg>
                </button>
            </div>
            
            <iframe id="pdfPreviewFrame" class="mb-4"></iframe>
            
            <button id="downloadPdfButton" class="w-full flex items-center justify-center gap-2 bg-blue-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-blue-700 transition-all duration-300">
                <svg data-lucide="download" class="h-5 w-5"></svg>
                Download PDF
            </button>
        </div>
    </div>
    

    <script>
        // Wait for the DOM to be fully loaded before running the script
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- Global State ---
            let activeTab = 'single'; // 'single', 'compare', etc.
            // playerData[0] = single, [1] = p1, [2] = p2, [3] = opposition
            let playerData = [
                { images: [], mimes: [] },
                { images: [], mimes: [] },
                { images: [], mimes: [] },
                { images: [], mimes: [] }
            ];
            let statsChartInstance = null; // To hold the Chart.js instance
            let generatedPdfDoc = null; // To hold the generated jsPDF object
            let lastAiResponse = ""; // Store raw AI text for PDF/Copy
            let lastSearchResponse = ""; // Store raw search response for CSV

            // --- DOM Elements ---
            const tabSingle = document.getElementById('tabSingle');
            const tabCompare = document.getElementById('tabCompare');
            const tabOpposition = document.getElementById('tabOpposition');
            const tabSearch = document.getElementById('tabSearch');
            const tabChatbot = document.getElementById('tabChatbot');
            const tabResources = document.getElementById('tabResources');
            
            const contentSingle = document.getElementById('contentSingle');
            const contentCompare = document.getElementById('contentCompare');
            const contentOpposition = document.getElementById('contentOpposition');
            const contentSearch = document.getElementById('contentSearch');
            const contentChatbot = document.getElementById('contentChatbot');
            const contentResources = document.getElementById('contentResources');
            
            const analysisControls = document.getElementById('analysisControls');
            const analyzeButton = document.getElementById('analyzeButton');
            const buttonText = document.getElementById('buttonText');
            const buttonIcon = document.getElementById('buttonIcon');
            const loadingSpinner = document.getElementById('loadingSpinner');
            const resultsSection = document.getElementById('resultsSection');
            const analysisOutput = document.getElementById('analysisOutput');
            const errorMessage = document.getElementById('errorMessage');
            const errorText = document.getElementById('errorText');
            const copyButton = document.getElementById('copyButton');
            const previewButton = document.getElementById('previewButton');
            const guideButton = document.getElementById('guideButton');
            const guideModalOverlay = document.getElementById('guideModalOverlay');
            const closeGuideModal = document.getElementById('closeGuideModal');
            
            // API Key Elements
            const apiKeyInputContainer = document.getElementById('apiKeyInputContainer');
            const apiKeyInput = document.getElementById('apiKey');
            const toggleApiVisibility = document.getElementById('toggleApiVisibility');
            const eyeIcon = document.getElementById('eyeIcon');
            const eyeOffIcon = document.getElementById('eyeOffIcon');
            const apiKeySaveButton = document.getElementById('apiKeySaveButton');
            const apiKeyMessage = document.getElementById('apiKeyMessage');
            const apiKeyClearButton = document.getElementById('apiKeyClearButton');
            
            // --- PDF Preview Modal Elements ---
            const pdfPreviewModalOverlay = document.getElementById('pdfPreviewModalOverlay');
            const closePreviewModal = document.getElementById('closePreviewModal');
            const pdfPreviewFrame = document.getElementById('pdfPreviewFrame');
            const downloadPdfButton = document.getElementById('downloadPdfButton');
            
            // --- Single Player Elements ---
            const uploadBoxSingle = document.getElementById('uploadBoxSingle');
            const imageUploadSingle = document.getElementById('imageUploadSingle');
            const imagePreviewContainerSingle = document.getElementById('imagePreviewContainerSingle');
            const uploadPlaceholderSingle = document.getElementById('uploadPlaceholderSingle');
            const clearButtonSingle = document.getElementById('clearButtonSingle');
            const textStatsSingle = document.getElementById('textStatsSingle');
            const visualizeStatsButton = document.getElementById('visualizeStatsButton');
            const chartContainer = document.getElementById('chartContainer');
            const statsChartCanvas = document.getElementById('statsChart');
            const playerName = document.getElementById('playerName');
            const playerAge = document.getElementById('playerAge');
            const playerClub = document.getElementById('playerClub');
            const playerLeague = document.getElementById('playerLeague');
            const playerRating = document.getElementById('playerRating');
            const matchContextSingle = document.getElementById('matchContextSingle');
            
            // --- Player 1 Elements ---
            const uploadBox1 = document.getElementById('uploadBox1');
            const imageUpload1 = document.getElementById('imageUpload1');
            const imagePreviewContainer1 = document.getElementById('imagePreviewContainer1');
            const uploadPlaceholder1 = document.getElementById('uploadPlaceholder1');
            const clearButton1 = document.getElementById('clearButton1');
            const matchContext1 = document.getElementById('matchContext1');
            const textStats1 = document.getElementById('textStats1');
            
            // --- Player 2 Elements ---
            const uploadBox2 = document.getElementById('uploadBox2');
            const imageUpload2 = document.getElementById('imageUpload2');
            const imagePreviewContainer2 = document.getElementById('imagePreviewContainer2');
            const uploadPlaceholder2 = document.getElementById('uploadPlaceholder2');
            const clearButton2 = document.getElementById('clearButton2');
            const matchContext2 = document.getElementById('matchContext2');
            const textStats2 = document.getElementById('textStats2');
            
            // --- Opposition Elements ---
            const uploadBoxOpponent = document.getElementById('uploadBoxOpponent');
            const imageUploadOpponent = document.getElementById('imageUploadOpponent');
            const imagePreviewContainerOpponent = document.getElementById('imagePreviewContainerOpponent');
            const uploadPlaceholderOpponent = document.getElementById('uploadPlaceholderOpponent');
            const clearButtonOpponent = document.getElementById('clearButtonOpponent');
            const opponentName = document.getElementById('opponentName');
            const matchContextOpp = document.getElementById('matchContextOpp');
            const textStatsOpponent = document.getElementById('textStatsOpponent');
            
            // --- Chatbot Elements ---
            const chatHistory = document.getElementById('chatHistory');
            const chatInput = document.getElementById('chatInput');
            const chatSendButton = document.getElementById('chatSendButton');
            const chatNewButton = document.getElementById('chatNewButton');
            
            // --- Search Elements ---
            const searchButton = document.getElementById('searchButton');
            const searchResultsContainer = document.getElementById('searchResultsContainer');
            const searchResults = document.getElementById('searchResults');
            const downloadSearchButton = document.getElementById('downloadSearchButton');
            const searchErrorMessage = document.getElementById('searchErrorMessage');
            const searchErrorText = document.getElementById('searchErrorText');
            // Search Input Fields
            const searchPosition = document.getElementById('searchPosition');
            const searchNationality = document.getElementById('searchNationality');
            const searchLeague = document.getElementById('searchLeague');
            const searchAgeMin = document.getElementById('searchAgeMin');
            const searchAgeMax = document.getElementById('searchAgeMax');
            const searchValueMin = document.getElementById('searchValueMin');
            const searchValueMax = document.getElementById('searchValueMax');
            const searchContract = document.getElementById('searchContract');
            const searchStats = document.getElementById('searchStats');
            const searchMatches = document.getElementById('searchMatches');

            // --- AI Prompts ---
            const systemPrompt = `You are an expert football (soccer) scout and tactical analyst with decades of experience at the highest level. Your task is to analyze the provided image(s) and any optional text data. You must be critical, insightful, and professional.`;
            
            const chatbotSystemPrompt = `You are "Scout AI," a helpful and expert football (soccer) scouting assistant. You have access to Google Search to find real-time statistics, player information, team tactics, and news. Answer user questions concisely and accurately, focusing on data and tactical insights. **Format your responses using simple HTML tags for readability (e.g., <strong> for headings, <ul> and <li> for lists). Do not use Markdown.**`;

            // Prompt 1: Quick Report
            const quickReportQuery = `Analyze the following image(s) and any provided text statistics for the player.
Based on all available data (heatmap activity, image stats, and text stats), please provide a full professional scouting report.
Note the provided player info:
- Player: {PLAYER_NAME}
- Age: {PLAYER_AGE}
- Club: {PLAYER_CLUB}
- League: {PLAYER_LEAGUE}
- Rating: {PLAYER_RATING}
- Match Observed: {MATCH_CONTEXT}

Structure your analysis with the following 7 clear sections. Use Markdown formatting for headings.

# 1. Likely Position(s)
Identify the player's most likely position and any secondary positions (e.g., 'Primary: Box-to-Box Midfielder (CM)', 'Secondary: Deep-Lying Playmaker (DLP)'). Justify your choice based on the heatmap(s).

# 2. Key Duties & Tactical Role
Describe their primary responsibilities and tactical role on the pitch based on the data (e.g., 'Covers ground between both boxes, contributes to both defense and attack, looks to progress the ball...').

# 3. Pros
Identify 3-5 key strengths visible from the data. Be specific. (e.g., 'High Defensive Work Rate: Indicated by heavy shading in his own half and high tackle/interception numbers.', 'Passing Range: Evident from the high number of long balls completed.').

# 4. Cons & Areas for Improvement
Identify 3-5 potential weaknesses or areas for improvement. Be critical and constructive. (e.g., 'Final Third Ineffectiveness: Heatmap thins out in the opponent's box, supported by low key passes.', 'Disciplinary Issues: High number of fouls.').

# 5. Full Scouting Summary
Provide a detailed, narrative summary (2-3 paragraphs) of the player's style, impact, and overall profile. Conclude with a final verdict on their potential level (e.g., 'Solid rotational player for a top-division side', 'High-potential prospect needs refinement', 'Top-class Champions League level player').

# 6. Suggested Similar Player
Based on the complete analysis (heatmap, stats, role), suggest ONE well-known professional player with a similar playstyle. Briefly justify your choice (1-2 sentences). (e.g., "Style Comparison: N'Golo Kanté. Both players exhibit exceptional work rate, strong defensive positioning, and primarily focus on ball recovery and simple distribution.")

# 7. Suggested Development Plan
Based on the 'Cons' you identified, suggest 2-3 specific, actionable development points or drills. (e.g., "1. Final Third Decision-Making: Drills focusing on cut-back passes and shooting under pressure.", "2. Weaker Foot Usage: Dedicate 15 minutes post-training to repetitive passing and shooting with weaker foot.").
`;
            
            // Prompt 2: Pro Scout Report
            const proReportQuery = `Generate a comprehensive, professional scouting report based on the provided data (images and text).
            
# 1. Player Information
- Name: {PLAYER_NAME}
- Age: {PLAYER_AGE}
- Position (from data): (Identify this from the heatmap/stats)
- Club: {PLAYER_CLUB}
- League: {PLAYER_LEAGUE}
- Match Observed: {MATCH_CONTEXT}

# 2. Player Rating
- Performance Rating: {PLAYER_RATING}
- (Briefly justify this rating based on the provided stats and your analysis)

# 3. Summary
Provide a brief overview of the player's performance.
- Key Strengths: (List 2-3 standout attributes from the data)
- Areas for Improvement: (List 2-3 specific parts of their game that need attention)

# 4. Positional Play
Analyze positioning in various phases based on the heatmap and stats.
- Offensive Phase: (e.g., "Finds pockets of space between midfield and defense lines, evident from heatmap activity in zone 14...")
- Defensive Phase: (e.g., "Disciplined in holding his position, but heatmap shows a reluctance to track runners wide...")
- Transition Play: (e.g., "Quick to support the attack, but slow in defensive recovery as shown by...")

# 5. Key Actions (PMDS Framework)
Analyze 2-3 critical moments or recurring actions from the stats using the PMDS framework (Position, Moment, Direction, Speed).
- Example Action 1 (e.g., Pressing): "Position: High in the opponent's half. Moment: Triggered by a poor first touch from the defender. Direction: Arcing run to cut off the pass. Speed: Explosive. Result: Forced a turnover."
- Example Action 2 (e.g., Key Pass): "Position: Right half-space. Moment: As winger checked to him. Direction: Forward, breaking the lines. Speed: Perfectly weighted. Result: Created a clear shot on goal."

# 6. Tactical Awareness (Four Phases Framework)
Assess the player's ability to understand and implement tactical instructions.
- Communication (Information): (e.g., "Appears to scan a field frequently, implied by successful long passes...")
- Decision (What): (e.g., "Consistently chose the simple, correct pass (high pass %)..." or "Tended to force dribbles in crowded areas (low dribble success)...")
- Decision (How): (e.g., "Used a variety of pass types (curved, driven, lobbed)...")
- Execution: (e.g., "Technically proficient, with high accuracy in passing and tackling stats...")

# 7. Mentality
Assess intangible qualities based on the provided stats.
- Work Rate: (e.g., "Exceptional, as shown by the extensive heatmap coverage and high number of defensive actions...")
- Leadership: (e.g., "Difficult to assess from stats alone, but high pass volume suggests teammates trust him as a hub...")
- Composure Under Pressure: (e.g., "Pass completion rate remained high despite... " or "High foul count (5) suggests moments of panic...")

# 8. Conclusion
Summarize your thoughts on the player’s potential and suitability.
- Growth Potential: (e.g., "Significant potential to become a top-division starter if 'Areas for Improvement' are addressed.")
- Suitability for a System: (e.g., "Best suited for a high-possession team that needs a creative fulcrum..." or "Ideal for a counter-attacking side...")
- Transfer Recommendation: (e.g., "Recommend for further monitoring" or "Immediate signing for B-team/loan.")
- **Similar Player Models:**
    - Top-League Comparison: (e.g., Martin Ødegaard - Similar vision and left foot)
    - Mid-League Comparison: (e.g., Joey Veerman (PSV) - Similar tempo-dictating style)
    - Same-League Comparison: (e.g., Teun Koopmeiners - If you cannot find a non-teammate, state that)
    - Historical Comparison: (e.g., Guti - Similar flair and risk-taking in final third)
`;

            // Prompt 3: Comparison Report
            const comparisonUserQuery = `Analyze the provided data for TWO players. Player 1's data is provided first, followed by Player 2's data.
- Player 1 Context: {MATCH_CONTEXT_1}
- Player 2 Context: {MATCH_CONTEXT_2}

Provide a professional head-to-head scouting report. Structure your analysis with the following clear sections. Use Markdown formatting for headings.

# 1. Player 1 Profile (Position & Role)
Briefly identify Player 1's likely position and tactical role based on their data.

# 2. Player 2 Profile (Position & Role)
Briefly identify Player 2's likely position and tactical role based on their data.

# 3. Head-to-Head Comparison (Strengths)
Compare the players directly on 3-5 key attributes, stating who has the edge in each. (e.g., 'Work Rate: Player 1 shows superior defensive coverage...', 'Passing: Player 2 appears to be the more creative passer...').

# 4. Head-to-Head Comparison (Weaknesses)
Compare their primary weaknesses or areas for improvement.

# 5. Final Verdict & Tactical Fit
Provide a concluding summary. Which player is more impactful? Who has higher potential? What kind of tactical system would each player thrive in?
`;
            
            // Prompt 4: Opposition Analysis
            const oppositionQuery = `Act as a senior tactical analyst. I am providing you with data on an upcoming opponent.
- Opponent: {OPPONENT_NAME}
- Match Context: {MATCH_CONTEXT}
- Provided Stats: {OPPONENT_STATS}

Based on the images (formations, heatmaps, etc.) and the text stats provided, generate a concise pre-match tactical report. Follow this structure:

# 1. Opponent Profile & Likely Formation
Based on the data, what is their most likely formation (e.g., 4-3-3, 3-5-2) and their general style (e.g., High-press, possession-based, counter-attack)?

# 2. Key Players
Identify 2-3 players who appear to be central to their play, based on stats or positional maps.

# 3. Key Strengths
List 3-4 primary tactical strengths. (e.g., "Attacks down the right flank," "Solid defensive block," "Quick transitions").

# 4. Key Weaknesses
List 3-4 exploitable weaknesses. (e.g., "Space behind fullbacks," "Vulnerable to high press," "Slow defensive transitions").

# 5. Suggested Tactical Exploitation
Provide 3-5 brief, actionable points on how *our* team can exploit these weaknesses. (e.g., "1. Target their left-back with quick 1-2s.", "2. Press their center-backs to force long balls.", "3. Use a false-9 to draw their holding midfielder out of position.").
`;

            // --- Tab Navigation ---
            tabSingle.addEventListener('click', () => switchTab('single'));
            tabCompare.addEventListener('click', () => switchTab('compare'));
            tabOpposition.addEventListener('click', () => switchTab('opposition'));
            tabSearch.addEventListener('click', () => switchTab('search'));
            tabChatbot.addEventListener('click', () => switchTab('chatbot'));
            tabResources.addEventListener('click', () => switchTab('resources'));

            function switchTab(tabName) {
                activeTab = tabName;
                
                // Toggle all tabs and content
                [tabSingle, tabCompare, tabOpposition, tabSearch, tabChatbot, tabResources].forEach(tab => {
                    tab.classList.remove('active');
                });
                [contentSingle, contentCompare, contentOpposition, contentSearch, contentChatbot, contentResources].forEach(content => {
                    content.classList.remove('active');
                });
                
                // Activate the selected one
                document.getElementById(`tab${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`).classList.add('active');
                document.getElementById(`content${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`).classList.add('active');

                // Show analysis controls only for report-generation tabs
                const showAnalysisControls = ['single', 'compare', 'opposition'].includes(tabName);
                analysisControls.style.display = showAnalysisControls ? 'block' : 'none';
                
                // Hide results section when switching tabs
                resultsSection.classList.add('hidden');
                
                if (tabName === 'single') buttonText.textContent = "Analyze Player";
                else if (tabName === 'compare') buttonText.textContent = "Compare Players";
                else if (tabName === 'opposition') buttonText.textContent = "Analyze Opposition";
                
                if (showAnalysisControls) updateAnalyzeButtonState();
            }

            // --- Event Listeners ---
            
            // Single Player
            imageUploadSingle.addEventListener('change', (e) => handleFiles(e.target.files, 0));
            clearButtonSingle.addEventListener('click', () => clearData(0));
            textStatsSingle.addEventListener('input', () => {
                visualizeStatsButton.disabled = textStatsSingle.value.trim() === '';
            });
            visualizeStatsButton.addEventListener('click', visualizeStats);
            [playerName, playerAge, playerClub, playerLeague, playerRating, matchContextSingle, textStatsSingle].forEach(el => {
                if (el) el.addEventListener('input', updateAnalyzeButtonState);
            });

            // Player 1
            imageUpload1.addEventListener('change', (e) => handleFiles(e.target.files, 1));
            clearButton1.addEventListener('click', () => clearData(1));
            [matchContext1, textStats1].forEach(el => {
                if (el) el.addEventListener('input', updateAnalyzeButtonState);
            });
            
            // Player 2
            imageUpload2.addEventListener('change', (e) => handleFiles(e.target.files, 2));
            clearButton2.addEventListener('click', () => clearData(2));
            [matchContext2, textStats2].forEach(el => {
                if (el) el.addEventListener('input', updateAnalyzeButtonState);
            });
            
            // Opposition
            imageUploadOpponent.addEventListener('change', (e) => handleFiles(e.target.files, 3));
            clearButtonOpponent.addEventListener('click', () => clearData(3));
            [opponentName, matchContextOpp, textStatsOpponent].forEach(el => {
                if (el) el.addEventListener('input', updateAnalyzeButtonState);
            });

            // Paste event listeners
            uploadBoxSingle.addEventListener('paste', (e) => handlePaste(e, 0));
            uploadBox1.addEventListener('paste', (e) => handlePaste(e, 1));
            uploadBox2.addEventListener('paste', (e) => handlePaste(e, 2));
            uploadBoxOpponent.addEventListener('paste', (e) => handlePaste(e, 3));

            // Analyze Button
            analyzeButton.addEventListener('click', handleAnalysis);

            // Export Buttons
            copyButton.addEventListener('click', copyReport);
            previewButton.addEventListener('click', handlePdfPreview);

            // Guide Modal
            guideButton.addEventListener('click', () => guideModalOverlay.classList.add('visible'));
            closeGuideModal.addEventListener('click', () => guideModalOverlay.classList.remove('visible'));
            guideModalOverlay.addEventListener('click', (e) => {
                if (e.target === guideModalOverlay) {
                    guideModalOverlay.classList.remove('visible');
                }
            });
            
            // PDF Preview Modal
            closePreviewModal.addEventListener('click', () => pdfPreviewModalOverlay.classList.remove('visible'));
            pdfPreviewModalOverlay.addEventListener('click', (e) => {
                if (e.target === pdfPreviewModalOverlay) {
                    pdfPreviewModalOverlay.classList.remove('visible');
                }
            });
            downloadPdfButton.addEventListener('click', () => {
                if (generatedPdfDoc) {
                    const pName = (playerName.value || opponentName.value || "report").replace(/\s+/g, '-');
                    generatedPdfDoc.save(`scout-report-${pName}.pdf`);
                } else {
                    showError("No PDF generated. Please preview again.");
                }
            });

            // API Key Listeners
            apiKeySaveButton.addEventListener('click', () => {
                const key = apiKeyInput.value.trim();
                if (key) {
                    try {
                        localStorage.setItem('geminiApiKey', key);
                        updateApiKeyUI(true);
                        apiKeyMessage.textContent = 'API Key saved locally!';
                        apiKeyMessage.classList.add('visible');
                    } catch (e) {
                        showError("Failed to save API key. Local storage might be full or disabled.");
                    }
                }
            });
            
            apiKeyClearButton.addEventListener('click', () => {
                try {
                    localStorage.removeItem('geminiApiKey');
                    apiKeyInput.value = '';
                    updateApiKeyUI(false);
                } catch (e) {
                    showError("Failed to clear API key.");
                }
            });

            toggleApiVisibility.addEventListener('click', () => {
                if (apiKeyInput.type === 'password') {
                    apiKeyInput.type = 'text';
                    eyeIcon.classList.add('hidden');
                    eyeOffIcon.classList.remove('hidden');
                } else {
                    apiKeyInput.type = 'password';
                    eyeIcon.classList.remove('hidden');
                    eyeOffIcon.classList.add('hidden');
                }
            });
            
            // Chatbot Listeners
            chatSendButton.addEventListener('click', handleChat);
            chatInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    handleChat();
                }
            });
            chatNewButton.addEventListener('click', handleNewChat);
            
            // Search Listeners
            searchButton.addEventListener('click', handleSearch);
            downloadSearchButton.addEventListener('click', downloadSearchResults);
            
            // --- API Key UI Function ---
            function updateApiKeyUI(isKeySaved) {
                if (isKeySaved) {
                    apiKeyInputContainer.classList.add('hidden');
                    apiKeyMessage.classList.add('visible');
                } else {
                    apiKeyInputContainer.classList.remove('hidden');
                    apiKeyMessage.classList.remove('visible');
                }
            }

            // --- File Handling Functions ---
            function handlePaste(event, playerIndex) {
                event.preventDefault();
                event.stopPropagation();
                
                const clipboardItems = event.clipboardData.items;
                const files = [];
                
                if (!clipboardItems) {
                    return;
                }
                
                for (let i = 0; i < clipboardItems.length; i++) {
                    if (clipboardItems[i].kind === 'file' && clipboardItems[i].type.startsWith('image/')) {
                        files.push(clipboardItems[i].getAsFile());
                    }
                }
                
                if (files.length > 0) {
                    handleFiles(files, playerIndex);
                } else {
                    showError("No image found in clipboard. Paste a screenshot or an image file.");
                }
            }
            
            function handleFiles(files, playerIndex) {
                if (!files || files.length === 0) return;
                
                const imageFiles = Array.from(files).filter(file => file.type.startsWith('image/'));
                if (imageFiles.length === 0) return;

                let placeholder, clearButton;
                if (playerIndex === 0) {
                    placeholder = uploadPlaceholderSingle;
                    clearButton = clearButtonSingle;
                } else if (playerIndex === 1) {
                    placeholder = uploadPlaceholder1;
                    clearButton = clearButton1;
                } else if (playerIndex === 2) {
                    placeholder = uploadPlaceholder2;
                    clearButton = clearButton2;
                } else if (playerIndex === 3) {
                    placeholder = uploadPlaceholderOpponent;
                    clearButton = clearButtonOpponent;
                }
                
                if (placeholder) placeholder.classList.add('hidden');
                if (clearButton) clearButton.classList.remove('hidden');

                for (const file of imageFiles) {
                    processFile(file, playerIndex);
                }
            }

            function processFile(file, playerIndex) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const dataUrl = e.target.result;
                    const parts = dataUrl.split(',');
                    const mimeTypeRaw = parts[0].match(/:(.*?);/)[1];
                    
                    playerData[playerIndex].images.push(parts[1]);
                    playerData[playerIndex].mimes.push(mimeTypeRaw);
                    
                    addImageToPreview(dataUrl, playerIndex);
                    updateAnalyzeButtonState();
                    hideError();
                };
                reader.readAsDataURL(file);
            }

            function addImageToPreview(dataUrl, playerIndex) {
                let container;
                if (playerIndex === 0) container = imagePreviewContainerSingle;
                else if (playerIndex === 1) container = imagePreviewContainer1;
                else if (playerIndex === 2) container = imagePreviewContainer2;
                else if (playerIndex === 3) container = imagePreviewContainerOpponent;
                
                if (!container) return;
                const img = document.createElement('img');
                img.src = dataUrl;
                img.alt = "Data preview";
                container.appendChild(img);
            }

            function clearData(playerIndex) {
                playerData[playerIndex] = { images: [], mimes: [] };
                
                if (playerIndex === 0) {
                    imagePreviewContainerSingle.innerHTML = '';
                    uploadPlaceholderSingle.classList.remove('hidden');
                    clearButtonSingle.classList.add('hidden');
                    textStatsSingle.value = '';
                    matchContextSingle.value = '';
                    playerName.value = '';
                    playerAge.value = '';
                    playerClub.value = '';
                    playerLeague.value = '';
                    playerRating.value = '';
                    chartContainer.classList.add('hidden');
                    if (statsChartInstance) {
                        statsChartInstance.destroy();
                        statsChartInstance = null;
                    }
                    visualizeStatsButton.disabled = true;
                } else if (playerIndex === 1) {
                    imagePreviewContainer1.innerHTML = '';
                    uploadPlaceholder1.classList.remove('hidden');
                    clearButton1.classList.add('hidden');
                    textStats1.value = '';
                    matchContext1.value = '';
                } else if (playerIndex === 2) {
                    imagePreviewContainer2.innerHTML = '';
                    uploadPlaceholder2.classList.remove('hidden');
                    clearButton2.classList.add('hidden');
                    textStats2.value = '';
                    matchContext2.value = '';
                } else if (playerIndex === 3) {
                    imagePreviewContainerOpponent.innerHTML = '';
                    uploadPlaceholderOpponent.classList.remove('hidden');
                    clearButtonOpponent.classList.add('hidden');
                    textStatsOpponent.value = '';
                    opponentName.value = '';
                    matchContextOpp.value = '';
                }
                
                updateAnalyzeButtonState();
                resultsSection.classList.add('hidden');
                hideError();
            }

            function updateAnalyzeButtonState() {
                if (activeTab === 'single') {
                    analyzeButton.disabled = playerData[0].images.length === 0;
                } else if (activeTab === 'compare') {
                    analyzeButton.disabled = playerData[1].images.length === 0 || playerData[2].images.length === 0;
                } else if (activeTab === 'opposition') {
                    const hasText = opponentName.value.trim() !== '' || textStatsOpponent.value.trim() !== '';
                    const hasImages = playerData[3].images.length > 0;
                    analyzeButton.disabled = !hasText && !hasImages;
                }
            }

            // --- Stats Visualization ---
            function visualizeStats() {
                const text = textStatsSingle.value;
                if (!text || !text.trim()) {
                    chartContainer.classList.add('hidden');
                    return;
                }

                const lines = text.split('\n');
                const labels = [];
                const data = [];

                lines.forEach(line => {
                    const parts = line.split(':');
                    if (parts.length < 2) return;
                    
                    const label = parts[0].trim();
                    let valueString = parts[1].trim();
                    
                    if (valueString.includes('/')) valueString = valueString.split('/')[0].trim();
                    if (valueString.includes('%')) valueString = valueString.replace('%', '').trim();

                    const value = parseFloat(valueString);
                    if (!isNaN(value) && label) {
                        labels.push(label);
                        data.push(value);
                    }
                });

                if (data.length === 0) {
                    showError("No parsable numeric stats found. Use format: 'Stat Name: 123'.");
                    return;
                }

                chartContainer.classList.remove('hidden');
                if (statsChartInstance) statsChartInstance.destroy();

                statsChartInstance = new Chart(statsChartCanvas, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Player Stats',
                            data: data,
                            backgroundColor: 'rgba(56, 189, 248, 0.6)',
                            borderColor: 'rgba(56, 189, 248, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        plugins: { legend: { display: false }, tooltip: { displayColors: false } },
                        scales: {
                            x: {
                                beginAtZero: true,
                                grid: { color: 'rgba(255, 255, 255, 0.1)' },
                                ticks: { color: '#d1d5db' }
                            },
                            y: {
                                grid: { display: false },
                                ticks: { color: '#d1d5db' }
                            }
                        }
                    }
                });
            }

            // --- Analysis & API Call ---
            function handleAnalysis() {
                setLoading(true);
                hideError();
                resultsSection.classList.add('hidden');
                lastAiResponse = ""; // Clear last response
                
                const parts = [];
                let query;
                
                if (activeTab === 'single') {
                    const reportType = document.querySelector('input[name="reportType"]:checked').value;
                    const pName = playerName.value || "Not specified";
                    query = (reportType === 'quick' ? quickReportQuery : proReportQuery)
                        .replace('{PLAYER_NAME}', pName)
                        .replace('{PLAYER_AGE}', playerAge.value || "Not specified")
                        .replace('{PLAYER_CLUB}', playerClub.value || "Not specified")
                        .replace('{PLAYER_LEAGUE}', playerLeague.value || "Not specified")
                        .replace('{PLAYER_RATING}', playerRating.value || "Not specified")
                        .replace('{MATCH_CONTEXT}', matchContextSingle.value || "Not specified");
                    
                    parts.push({ text: query });
                    const stats = textStatsSingle.value;
                    if (stats.trim() !== "") parts.push({ text: "\n\n# Additional Textual Stats:\n" + stats });
                    playerData[0].images.forEach((imgData, i) => {
                        parts.push({ inlineData: { mimeType: playerData[0].mimes[i], data: imgData } });
                    });
                    
                } else if (activeTab === 'compare') {
                    query = comparisonUserQuery
                        .replace('{MATCH_CONTEXT_1}', matchContext1.value || "Not specified")
                        .replace('{MATCH_CONTEXT_2}', matchContext2.value || "Not specified");
                    parts.push({ text: query });
                    
                    const stats1 = textStats1.value;
                    parts.push({ text: "\n\n# --- PLAYER 1 DATA ---" });
                    if (stats1.trim() !== "") parts.push({ text: "\n# Player 1 Stats:\n" + stats1 });
                    playerData[1].images.forEach((imgData, i) => {
                        parts.push({ inlineData: { mimeType: playerData[1].mimes[i], data: imgData } });
                    });
                    
                    const stats2 = textStats2.value;
                    parts.push({ text: "\n\n# --- PLAYER 2 DATA ---" });
                    if (stats2.trim() !== "") parts.push({ text: "\n# Player 2 Stats:\n" + stats2 });
                    playerData[2].images.forEach((imgData, i) => {
                        parts.push({ inlineData: { mimeType: playerData[2].mimes[i], data: imgData } });
                    });
                    
                } else if (activeTab === 'opposition') {
                    query = oppositionQuery
                        .replace('{OPPONENT_NAME}', opponentName.value || "Not specified")
                        .replace('{MATCH_CONTEXT}', matchContextOpp.value || "Not specified")
                        .replace('{OPPONENT_STATS}', textStatsOpponent.value || "No stats provided");
                    parts.push({ text: query });
                    playerData[3].images.forEach((imgData, i) => {
                        parts.push({ inlineData: { mimeType: playerData[3].mimes[i], data: imgData } });
                    });
                }
                
                callReportApi(parts);
            }

            async function callReportApi(parts, retryCount = 0) {
                // Get key from input or local storage
                let key = apiKeyInput.value.trim();
                if (!key) {
                    try {
                        key = localStorage.getItem('geminiApiKey') || "";
                    } catch (e) {
                        key = "";
                    }
                }
                
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`;

                const payload = {
                    contents: [{ role: "user", parts: parts }],
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                    generationConfig: { temperature: 0.3 }
                };

                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 429 || response.status >= 500) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        } else {
                            const errorText = await response.text();
                            let errorData;
                            try {
                                errorData = JSON.parse(errorText);
                            } catch (e) {
                                throw new Error(`HTTP error! status: ${response.status}. ${errorText}`);
                            }
                            throw new Error(errorData.error?.message || "An unknown error occurred.");
                        }
                    }

                    const result = await response.json();
                    
                    if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                        lastAiResponse = result.candidates[0].content.parts[0].text;
                        displayResults(lastAiResponse);
                    } else if (result.candidates?.[0]?.finishReason === "SAFETY") {
                        throw new Error("Analysis blocked due to safety settings. Try different images or text.");
                    } else {
                        throw new Error("Invalid response structure from API. No text generated.");
                    }
                    
                } catch (error) {
                    if (retryCount < 3 && (error.message.includes("HTTP error") || error.message.includes("Failed to fetch"))) {
                        const delay = Math.pow(2, retryCount) * 1000 + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        callReportApi(parts, retryCount + 1);
                    } else {
                        showError(`Failed to get analysis: ${error.message}`);
                    }
                } finally {
                    if (retryCount === 0) {
                         setLoading(false);
                    }
                }
            }
            
            // --- Chatbot Functions ---
            function handleNewChat() {
                chatHistory.innerHTML = '';
                addMessageToChat('ai', "Hello! I'm your AI scouting assistant. How can I help you today?");
            }

            function handleChat() {
                const query = chatInput.value.trim();
                if (!query) return;
                
                chatInput.value = '';
                addMessageToChat('user', query);
                const loadingMessage = addMessageToChat('ai', '...', true);
                callChatbotApi(query, loadingMessage, true); // true for search
            }
            
            function addMessageToChat(role, text, isLoading = false) {
                const messageDiv = document.createElement('div');
                messageDiv.classList.add('chat-message', role);
                
                if (isLoading) {
                    messageDiv.classList.add('loading');
                    messageDiv.innerHTML = `<div class="spinner spinner-sm"></div><span>Thinking...</span>`;
                } else {
                    messageDiv.innerHTML = text; // Render HTML
                }
                
                chatHistory.appendChild(messageDiv);
                chatHistory.scrollTop = chatHistory.scrollHeight; // Auto-scroll
                return messageDiv;
            }
            
            async function callChatbotApi(query, loadingMessageElement, useSearch, retryCount = 0) {
                let key = apiKeyInput.value.trim();
                if (!key) {
                    try {
                        key = localStorage.getItem('geminiApiKey') || "";
                    } catch (e) {
                        key = "";
                    }
                }
                
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`;
                
                const payload = {
                    contents: [{ role: "user", parts: [{ text: query }] }],
                    systemInstruction: { parts: [{ text: chatbotSystemPrompt }] },
                };
                
                if (useSearch) {
                    payload.tools = [{ "google_search": {} }];
                }
                
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    if (!response.ok) {
                        if (response.status === 429 || response.status >= 500) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        } else {
                            const errorText = await response.text();
                            let errorData;
                            try {
                                errorData = JSON.parse(errorText);
                            } catch (e) {
                                // Handle non-JSON error responses
                                throw new Error(`HTTP error! status: ${response.status}. ${errorText}`);
                            }
                            throw new Error(errorData.error?.message || "An unknown error occurred.");
                        }
                    }

                    // Fix for "Unexpected end of input"
                    const responseText = await response.text();
                    if (!responseText) {
                        throw new Error("Received an empty response from the API.");
                    }
                    
                    let result;
                    try {
                         result = JSON.parse(responseText);
                    } catch (e) {
                        console.error("Failed to parse JSON response:", responseText);
                        throw new Error("Failed to parse API response. Raw: " + responseText);
                    }

                    
                    if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                        const generatedText = result.candidates[0].content.parts[0].text;
                        
                        if (loadingMessageElement) { // For chatbot
                            loadingMessageElement.innerHTML = generatedText; // Render HTML
                            loadingMessageElement.classList.remove('loading');
                        } else if (activeTab === 'search') { // For search tab
                            lastSearchResponse = generatedText;
                            displaySearchResults(generatedText);
                        }
                    } else if (result.candidates?.[0]?.finishReason === "SAFETY") {
                        throw new Error("Response blocked due to safety settings.");
                    } else {
                        throw new Error("Invalid response from API (no text).");
                    }
                    
                } catch (error) {
                    if (retryCount < 3 && (error.message.includes("HTTP error") || error.message.includes("Failed to fetch"))) {
                        const delay = Math.pow(2, retryCount) * 1000 + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        callChatbotApi(query, loadingMessageElement, useSearch, retryCount + 1);
                    } else {
                        if (loadingMessageElement) {
                            loadingMessageElement.innerHTML = `Error: ${error.message}`; // Render HTML
                            loadingMessageElement.classList.remove('loading');
                            loadingMessageElement.style.color = '#f87171'; // red-400
                        } else if (activeTab === 'search') {
                            showSearchError(`Failed to get results: ${error.message}`);
                        }
                    }
                } finally {
                    if (activeTab === 'search' && retryCount === 0) {
                        searchButton.disabled = false;
                        searchButton.innerHTML = `<svg data-lucide="search" class="h-5 w-5"></svg> Search Players`;
                        if (typeof lucide !== 'undefined') lucide.createIcons();
                    }
                }
            }
            
            // --- Search Tab Functions ---
            function handleSearch() {
                // Build the query from the form fields
                let queryParts = [];
                if (searchPosition.value.trim()) queryParts.push(`Position: ${searchPosition.value.trim()}`);
                if (searchAgeMin.value || searchAgeMax.value) {
                    let ageQuery = "Age: ";
                    if (searchAgeMin.value) ageQuery += `> ${searchAgeMin.value}`;
                    if (searchAgeMin.value && searchAgeMax.value) ageQuery += " and ";
                    if (searchAgeMax.value) ageQuery += `< ${searchAgeMax.value}`;
                    queryParts.push(ageQuery);
                }
                if (searchNationality.value.trim()) queryParts.push(`Nationality/Passport: ${searchNationality.value.trim()}`);
                if (searchValueMin.value || searchValueMax.value) {
                    let valueQuery = "Market Value: ";
                    if (searchValueMin.value) valueQuery += `> €${searchValueMin.value}m`;
                    if (searchValueMin.value && searchValueMax.value) valueQuery += " and ";
                    if (searchValueMax.value) valueQuery += `< €${searchValueMax.value}m`;
                    queryParts.push(valueQuery);
                }
                if (searchContract.value) queryParts.push(`Contract Status: ${searchContract.value}`);
                if (searchStats.value.trim()) queryParts.push(`Specific Stats: ${searchStats.value.trim()}`);
                if (searchMatches.value.trim()) queryParts.push(`Matches/Minutes: ${searchMatches.value.trim()}`);
                if (searchLeague.value.trim()) queryParts.push(`Has the potential quality or playstyle suitable for: ${searchLeague.value.trim()} (This is a scout assessment, they don't have to be playing in that league currently).`);
                
                if (queryParts.length === 0) {
                    showSearchError("Please enter at least one search criterion.");
                    return;
                }
                
                const fullQuery = `
Based on publicly available data and tactical analysis from Google Search, find up to 25 football players who match the following criteria:
- ${queryParts.join('\n- ')}

One key criterion is "Suitable for League." This means you should assess if the player's *potential* and *playstyle* match that league, not just if they *currently* play in it.

Format the result as a simple HTML table (no classes) with columns: Name, Age, Club, Nationality, Position, Market Value (Est.), Contract Expires.
If a value is unknown, use "N/A".
`;
                
                searchButton.disabled = true;
                searchButton.innerHTML = `<div class="spinner spinner-sm"></div> Searching...`;
                searchResultsContainer.classList.add('hidden');
                searchErrorMessage.classList.add('hidden');
                
                callChatbotApi(fullQuery, null, true); // null for loading element, true for search
            }
            
            function displaySearchResults(htmlTable) {
                searchResultsContainer.classList.remove('hidden');
                searchResults.innerHTML = htmlTable;
                // Simple styling for the table in case AI didn't add it
                const table = searchResults.querySelector('table');
                if (table) {
                    table.style.width = '100%';
                    table.style.borderCollapse = 'collapse';
                }
            }
            
            function showSearchError(message) {
                searchErrorText.textContent = message;
                searchErrorMessage.classList.remove('hidden');
            }
            
            function downloadSearchResults() {
                if (!lastSearchResponse) {
                    showSearchError("No results to download. Please run a search first.");
                    return;
                }
                
                let csv = htmlTableToCsv(lastSearchResponse);
                if (!csv) {
                    showSearchError("Could not parse results. Please try another search.");
                    return;
                }
                
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', 'player_search_results.csv');
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
            
            function htmlTableToCsv(html) {
                try {
                    // Find the table in the HTML
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = html;
                    const table = tempDiv.querySelector('table');
                    if (!table) return null;
                    
                    let csv = [];
                    const rows = table.querySelectorAll('tr');
                    
                    for (const row of rows) {
                        let rowCsv = [];
                        const cols = row.querySelectorAll('th, td');
                        for (const col of cols) {
                            let text = col.textContent.trim().replace(/"/g, '""'); // Escape double quotes
                            if (text.includes(',')) text = `"${text}"`; // Add quotes if comma
                            rowCsv.push(text);
                        }
                        csv.push(rowCsv.join(','));
                    }
                    return csv.join('\n');
                } catch (e) {
                    console.error("Error parsing table to CSV:", e);
                    return null;
                }
            }


            // --- UI Helper Functions ---
            function displayResults(text) {
                let html = text
                    .replace(/^# 1. (.*)/gm, '<h3 class="text-xl font-semibold text-blue-300 mt-4 mb-2">$1</h3>')
                    .replace(/^# 2. (.*)/gm, '<h3 class="text-xl font-semibold text-blue-300 mt-4 mb-2">$1</h3>')
                    .replace(/^# 3. (.*)/gm, '<h3 class="text-xl font-semibold text-blue-300 mt-4 mb-2">$1</h3>')
                    .replace(/^# 4. (.*)/gm, '<h3 class="text-xl font-semibold text-blue-300 mt-4 mb-2">$1</h3>')
                    .replace(/^# 5. (.*)/gm, '<h3 class="text-xl font-semibold text-blue-300 mt-4 mb-2">$1</h3>')
                    .replace(/^# 6. (.*)/gm, '<h3 class="text-xl font-semibold text-blue-300 mt-4 mb-2">$1</h3>')
                    .replace(/^# 7. (.*)/gm, '<h3 class="text-xl font-semibold text-blue-300 mt-4 mb-2">$1</h3>')
                    .replace(/^# 8. (.*)/gm, '<h3 class="text-xl font-semibold text-blue-300 mt-4 mb-2">$1</h3>')
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/^- (.*)/gm, '<li class="ml-4 list-disc">$1</li>');

                analysisOutput.innerHTML = html;
                resultsSection.classList.remove('hidden');
                if (typeof lucide !== 'undefined') lucide.createIcons();
            }
            
            // --- New PDF Generation ---
            async function handlePdfPreview() {
                if (!lastAiResponse) {
                    showError("Please generate a report first.");
                    return;
                }
                if (activeTab !== 'single') {
                    showError("PDF Export is only available for the 'Single Player' tab.");
                    return;
                }
                
                const reportType = document.querySelector('input[name="reportType"]:checked').value;
                if (reportType !== 'pro') {
                    showError("The professional PDF export is only available for the 'Pro Scout Report' type.");
                    return;
                }
                
                previewButton.disabled = true;
                previewButton.innerHTML = `<div class="spinner -ml-1 mr-3 h-4 w-4"></div> Generating PDF...`;

                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF('p', 'mm', 'a4');
                    const margin = 15;
                    const pageWidth = doc.internal.pageSize.getWidth();
                    const pageHeight = doc.internal.pageSize.getHeight();
                    const contentWidth = pageWidth - (margin * 2);
                    let currentY = 0;
                    
                    // --- Helper Functions for PDF ---
                    const addHeader = (title) => {
                        checkPageBreak(16); // Check space for header
                        doc.setFillColor(236, 249, 255); // sky-100
                        doc.rect(margin, currentY, contentWidth, 12, 'F');
                        doc.setFont('helvetica', 'bold');
                        doc.setFontSize(14);
                        doc.setTextColor(12, 74, 110); // sky-900
                        doc.text(title, margin + 2, currentY + 8);
                        currentY += 16;
                    };
                    
                    const addBodyText = (text) => {
                        doc.setFont('helvetica', 'normal');
                        doc.setFontSize(10);
                        doc.setTextColor(31, 41, 55); // gray-700
                        
                        // Clean up markdown-like text
                        let cleanText = text
                            .replace(/<[^>]*>/g, '') // Remove any HTML
                            .replace(/\*\*(.*?)\*\*/g, '$1') // Remove bold markers
                            .replace(/^- /gm, '  • ') // Convert md list to bullet
                            .trim();

                        const lines = doc.splitTextToSize(cleanText, contentWidth);
                        for (const line of lines) {
                            checkPageBreak(5); // Check space for line
                            doc.text(line, margin, currentY);
                            currentY += 5;
                        }
                        currentY += 4;
                    };
                    
                    const checkPageBreak = (heightNeeded) => {
                        if (currentY + heightNeeded > pageHeight - margin) {
                            doc.addPage();
                            currentY = margin;
                            return true;
                        }
                        return false;
                    };

                    // --- 1. Parse AI Response ---
                    // Split the report into sections.
                    const sections = lastAiResponse.split(/^# \d. /m).filter(Boolean).map(s => s.trim());
                    if (sections.length < 8) throw new Error("Could not parse Pro Scout Report. AI response was incomplete. Please try again.");

                    const reportData = {
                        info: sections[0],
                        rating: sections[1],
                        summary: sections[2],
                        positional: sections[3],
                        keyActions: sections[4],
                        tactical: sections[5],
                        mentality: sections[6],
                        conclusion: sections[7]
                    };

                    // --- 2. Build PDF Document ---
                    currentY = margin;

                    // == PDF Header ==
                    doc.setFillColor(243, 244, 246); // gray-100
                    doc.rect(0, 0, pageWidth, 35, 'F');
                    
                    // Player Photo Placeholder
                    doc.setDrawColor(156, 163, 175); // gray-400
                    doc.setLineWidth(0.5);
                    doc.rect(margin, margin - 5, 25, 25); // Adjusted Y
                    doc.setFontSize(8);
                    doc.setTextColor(107, 114, 128); // gray-500
                    doc.text("Photo", margin + 12.5, margin + 7.5, { align: 'center' });

                    // Player Info
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(22);
                    doc.setTextColor(0, 0, 0);
                    doc.text(playerName.value || 'Player Report', margin + 30, margin + 3); // Adjusted Y
                    
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(10);
                    doc.setTextColor(55, 65, 81); // gray-600
                    doc.text(`Age: ${playerAge.value || 'N/A'}`, margin + 30, margin + 9);
                    doc.text(`Club: ${playerClub.value || 'N/A'}`, margin + 30, margin + 14);
                    doc.text(`Match: ${matchContextSingle.value || 'N/A'}`, margin + 30, margin + 19);
                    
                    // Report Info
                    const reportDate = new Date().toLocaleDateString();
                    doc.setFontSize(8);
                    doc.setTextColor(107, 114, 128);
                    doc.text(`Report Date: ${reportDate}`, pageWidth - margin, margin + 3, { align: 'right' });
                    doc.text(`Report ID: ${Date.now()}`, pageWidth - margin, margin + 8, { align: 'right' });
                    
                    currentY = 40; // Start content below header
                    
                    // == Section 1: Player Rating & Summary ==
                    checkPageBreak(30);
                    addHeader("Summary & Rating");
                    
                    // Rating
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(10);
                    doc.text("PERFORMANCE RATING:", margin, currentY);
                    
                    const ratingText = playerRating.value || 'N/A';
                    const ratingWidth = doc.getTextWidth(ratingText) + 8;
                    doc.setFillColor(56, 189, 248); // sky-400
                    doc.setDrawColor(56, 189, 248);
                    doc.roundedRect(margin + 50, currentY - 4.5, ratingWidth, 7, 2, 2, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(12);
                    doc.text(ratingText, margin + 54, currentY + 1);
                    currentY += 8;

                    addBodyText(reportData.rating.substring(reportData.rating.indexOf('\n') + 1)); // Skip title
                    addBodyText(reportData.summary.substring(reportData.summary.indexOf('\n') + 1)); // Skip title

                    // == Section 2: Visuals (Charts & Images) ==
                    checkPageBreak(16);
                    addHeader("Visual Data");

                    // Stats Chart
                    if (statsChartInstance) {
                        const chartDataUrl = statsChartInstance.toBase64Image();
                        const chartWidth = contentWidth;
                        const chartHeight = (statsChartInstance.height / statsChartInstance.width) * chartWidth;
                        checkPageBreak(chartHeight + 10);
                        doc.addImage(chartDataUrl, 'PNG', margin, currentY, chartWidth, chartHeight);
                        currentY += chartHeight + 10;
                    }
                    
                    // Uploaded Heatmaps/Images
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(10);
                    doc.setTextColor(31, 41, 55);
                    checkPageBreak(6);
                    doc.text("Uploaded Heatmaps & Stats:", margin, currentY);
                    currentY += 6;
                    
                    let xPos = margin;
                    const imgWidth = (contentWidth / 2) - 2;
                    let rowMaxHeight = 0;
                    
                    for (let i = 0; i < playerData[0].images.length; i++) {
                        const imgData = `data:${playerData[0].mimes[i]};base64,${playerData[0].images[i]}`;
                        const imgProps = doc.getImageProperties(imgData);
                        const imgHeight = (imgProps.height / imgProps.width) * imgWidth;
                        
                        if (xPos > margin && (xPos + imgWidth > pageWidth - margin)) {
                            // New row
                            currentY += rowMaxHeight + 4;
                            xPos = margin;
                            rowMaxHeight = 0;
                        }
                        
                        checkPageBreak(imgHeight + 4);
                        doc.addImage(imgData, 'JPEG', xPos, currentY, imgWidth, imgHeight);
                        
                        rowMaxHeight = Math.max(rowMaxHeight, imgHeight);
                        xPos += imgWidth + 4;
                    }
                    currentY += rowMaxHeight + 10; // Add padding after last row


                    // == Sections 3-7: Detailed Analysis ==
                    const analysisSections = [
                        { title: reportData.positional.split('\n')[0], text: reportData.positional.substring(reportData.positional.indexOf('\n') + 1) },
                        { title: reportData.keyActions.split('\n')[0], text: reportData.keyActions.substring(reportData.keyActions.indexOf('\n') + 1) },
                        { title: reportData.tactical.split('\n')[0], text: reportData.tactical.substring(reportData.tactical.indexOf('\n') + 1) },
                        { title: reportData.mentality.split('\n')[0], text: reportData.mentality.substring(reportData.mentality.indexOf('\n') + 1) },
                    ];
                    
                    for (const section of analysisSections) {
                        checkPageBreak(16); // Header + buffer
                        addHeader(section.title);
                        addBodyText(section.text);
                    }

                    // == Section 8: Conclusion & Recommendation ==
                    checkPageBreak(16);
                    addHeader("Conclusion & Recommendation");
                    addBodyText(reportData.conclusion.substring(reportData.conclusion.indexOf('\n') + 1));
                    
                    
                    generatedPdfDoc = doc;
                    
                    // --- 4. Show Preview ---
                    const pdfDataUri = doc.output('datauristring');
                    pdfPreviewFrame.src = pdfDataUri;
                    pdfPreviewModalOverlay.classList.add('visible');

                } catch (err) {
                    showError("Error generating PDF preview: " + err.message);
                    console.error(err);
                } finally {
                    // Reset button
                    previewButton.disabled = false;
                    previewButton.innerHTML = `<svg data-lucide="file-check" class="h-4 w-4"></svg> Preview PDF`;
                    if (typeof lucide !== 'undefined') lucide.createIcons();
                }
            }


            function copyReport() {
                let textToCopy = analysisOutput.innerHTML
                    .replace(/<h3 class="[^"]*">(.*?)<\/h3>/g, '\n\n$1\n--------------------\n')
                    .replace(/<strong>(.*?)<\/strong>/g, '$1')
                    .replace(/<li class="[^"]*">(.*?)<\/li>/g, '\n- $1')
                    .replace(/<br>/g, '\n')
                    .replace(/&lt;/g, '<')
                    .replace(/&gt;/g, '>')
                    .replace(/&amp;/g, '&');
                
                const tempEl = document.createElement('div');
                tempEl.innerText = textToCopy;
                textToCopy = tempEl.innerText.trim();

                const textArea = document.createElement('textarea');
                textArea.value = textToCopy;
                textArea.style.position = 'fixed';
                textArea.style.left = '-9999px';
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    copyButton.innerHTML = '<svg data-lucide="check" class="h-4 w-4"></svg> Copied!';
                    if (typeof lucide !== 'undefined') lucide.createIcons();
                    setTimeout(() => {
                        copyButton.innerHTML = '<svg data-lucide="copy" class="h-4 w-4"></svg> Copy';
                        if (typeof lucide !== 'undefined') lucide.createIcons();
                    }, 2000);
                } catch (err) {
                    showError('Failed to copy text.');
                }
                document.body.removeChild(textArea);
            }

            function setLoading(isLoading) {
                if (isLoading) {
                    analyzeButton.disabled = true;
                    buttonText.classList.add('hidden');
                    buttonIcon.classList.add('hidden');
                    loadingSpinner.classList.remove('hidden');
                } else {
                    updateAnalyzeButtonState();
                    buttonText.classList.remove('hidden');
                    buttonIcon.classList.remove('hidden');
                    loadingSpinner.classList.add('hidden');
                }
            }

            function showError(message) {
                errorText.textContent = message;
                errorMessage.classList.remove('hidden');
            }

            function hideError() {
                errorMessage.classList.add('hidden');
            }
            
            // --- Initialization ---
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            } else {
                console.error("Lucide icons script not loaded.");
            }
            
            // Check for saved API key on load
            try {
                const savedKey = localStorage.getItem('geminiApiKey');
                if (savedKey) {
                    apiKeyInput.value = savedKey;
                    updateApiKeyUI(true);
                } else {
                    updateApiKeyUI(false);
                }
            } catch (e) {
                console.warn("Could not access local storage.");
                updateApiKeyUI(false);
            }

            updateAnalyzeButtonState(); // Set initial button state
            visualizeStatsButton.disabled = true; // Disabled until user types
        });
    </script>
</body>
</html>


