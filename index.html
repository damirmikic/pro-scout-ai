<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro Scout AI - Player Analysis</title>
    <!-- FAVICON -->
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cg fill='none' stroke-linecap='round'%3E%3Ccircle cx='45' cy='45' r='30' stroke='%2338bdf8' stroke-width='10'/%3E%3Cline x1='65' y1='65' x2='85' y2='85' stroke='%239ca3af' stroke-width='12'/%3E%3C/g%3E%3Cg fill='%232dd4bf'%3E%3Crect x='30' y='40' width='8' height='20' rx='2'/%3E%3Crect x='41' y='30' width='8' height='30' rx='2'/%3E%3Crect x='52' y='35' width='8' height='25' rx='2'/%3E%3C/g%3E%3C/svg%3E" type="image/svg+xml">
    
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Global Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@500;600;700&display=swap" rel="stylesheet">
    
    <!-- Load Lucide icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Load Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Load PDF generation libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        /* Custom scrollbar for webkit browsers */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1e293b; /* slate-800 */
        }
        ::-webkit-scrollbar-thumb {
            background: #475569; /* slate-600 */
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #64748b; /* slate-500 */
        }

        /* Styling for the PDF preview modal */
        #pdfPreviewModal iframe {
            width: 100%;
            height: 70vh;
            border: 1px solid #475569; /* slate-600 */
        }

        /* Class to hide elements during PDF generation */
        .pdf-hide {
            display: none !important;
        }
        
        /* A4 page styles for the hidden PDF generation element */
        @media print {
            body, html {
                height: auto;
            }
            .a4-page {
                page-break-after: always;
            }
        }
        
        /* Focus ring for contenteditable */
        [contenteditable="true"]:focus {
            outline: none;
            box-shadow: 0 0 0 2px #0ea5e9; /* Equivalent to ring-2 ring-sky-500 */
        }

        .quick-action {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            border-radius: 0.75rem;
            border: 1px solid #334155;
            background-color: rgba(15, 23, 42, 0.7);
            padding: 0.75rem 1rem;
            color: #e2e8f0;
            font-weight: 500;
            font-size: 0.875rem;
            transition: all 0.2s ease;
        }

        .quick-action:hover {
            border-color: #38bdf8;
            color: #bae6fd;
            background-color: rgba(30, 41, 59, 0.9);
        }

        .analysis-view-btn {
            padding: 0.6rem 1rem;
            background: rgba(15, 23, 42, 0.7);
            border: 1px solid #334155;
            color: #cbd5f5;
            border-radius: 9999px;
            font-size: 0.85rem;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .analysis-view-btn.active,
        .analysis-view-btn:hover {
            background: rgba(56, 189, 248, 0.15);
            border-color: #38bdf8;
            color: #e0f2fe;
        }

        .analysis-view {
            display: block;
        }

        .analysis-view.hidden {
            display: none;
        }

        .tab-nav-scroll {
            scroll-snap-type: x mandatory;
            -webkit-overflow-scrolling: touch;
        }

        .tab-nav-scroll::-webkit-scrollbar {
            display: none;
        }

        .tab-btn {
            scroll-snap-align: center;
            flex-shrink: 0;
        }

        #floatingGenerateBtn {
            position: fixed;
            right: 1.5rem;
            bottom: 1.5rem;
            z-index: 90;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.9rem 1.4rem;
            border-radius: 9999px;
            background: linear-gradient(135deg, rgba(56, 189, 248, 0.95), rgba(59, 130, 246, 0.95));
            color: #0f172a;
            font-weight: 700;
            box-shadow: 0 15px 35px rgba(15, 118, 210, 0.35);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        #floatingGenerateBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 18px 40px rgba(14, 116, 144, 0.45);
        }

        #floatingGenerateBtn:active {
            transform: translateY(0);
        }

        .loading-progress-track {
            width: min(440px, 80vw);
            height: 10px;
            border-radius: 999px;
            overflow: hidden;
            background: rgba(148, 163, 184, 0.2);
            border: 1px solid rgba(148, 163, 184, 0.25);
            position: relative;
        }

        .loading-progress-bar {
            height: 100%;
            width: 0%;
            border-radius: 999px;
            background: linear-gradient(90deg, rgba(56, 189, 248, 0.9), rgba(59, 130, 246, 0.95));
            transition: width 0.4s ease;
        }

        .loading-progress-labels {
            display: flex;
            justify-content: space-between;
            width: min(440px, 80vw);
            margin-top: 0.75rem;
            font-size: 0.6rem;
            text-transform: uppercase;
            letter-spacing: 0.2em;
            color: #64748b;
        }

        .loading-progress-labels span.active {
            color: #e0f2fe;
        }

        .analysis-theme {
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .analysis-theme.theme-default {
            border-color: #334155;
            box-shadow: 0 0 0 1px rgba(15, 23, 42, 0.6);
        }

        .analysis-theme.theme-club {
            border-color: #38bdf8;
            box-shadow: 0 10px 30px rgba(56, 189, 248, 0.25);
        }

        .analysis-theme.theme-agency {
            border-color: #f97316;
            box-shadow: 0 10px 30px rgba(249, 115, 22, 0.25);
        }

        .analysis-theme.theme-academy {
            border-color: #22c55e;
            box-shadow: 0 10px 30px rgba(34, 197, 94, 0.25);
        }

        .analysis-report-layout {
            display: grid;
            gap: 1.25rem;
            grid-template-columns: 1fr;
        }

        @media (min-width: 1280px) {
            .analysis-report-layout {
                grid-template-columns: 320px 1fr;
                align-items: start;
            }
        }

        .analysis-report-column {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .analysis-report-card {
            position: relative;
            border-radius: 20px;
            border: 1px solid rgba(148, 163, 184, 0.15);
            background: linear-gradient(155deg, rgba(15, 23, 42, 0.92), rgba(15, 23, 42, 0.65));
            box-shadow: 0 20px 45px rgba(15, 23, 42, 0.35);
            padding: 1.25rem;
        }

        .analysis-report-card::before {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: inherit;
            border: 1px solid rgba(148, 163, 184, 0.05);
            pointer-events: none;
        }

        .analysis-report-card h4 {
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
            letter-spacing: 0.02em;
        }

        .analysis-metric-list {
            display: grid;
            gap: 0.75rem;
        }

        .analysis-metric {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.65rem 0.85rem;
            border-radius: 14px;
            background: rgba(148, 163, 184, 0.08);
            border: 1px solid rgba(148, 163, 184, 0.08);
        }

        .analysis-metric span {
            display: inline-flex;
            align-items: center;
            gap: 0.45rem;
            font-weight: 500;
            color: #e2e8f0;
        }

        .analysis-metric strong {
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
            color: #38bdf8;
        }

        .analysis-grade-card {
            display: flex;
            flex-direction: column;
            gap: 0.6rem;
            padding: 0.9rem 1rem;
            border-radius: 16px;
            background: rgba(14, 165, 233, 0.08);
            border: 1px solid rgba(56, 189, 248, 0.18);
        }

        .analysis-grade-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-weight: 600;
            color: #e0f2fe;
        }

        .analysis-grade-meter {
            position: relative;
            height: 8px;
            border-radius: 999px;
            background: rgba(148, 163, 184, 0.2);
            overflow: hidden;
        }

        .analysis-grade-meter span {
            position: absolute;
            inset: 0;
            border-radius: inherit;
        }

        .analysis-grade-comment {
            font-size: 0.8rem;
            color: #cbd5f5;
            line-height: 1.4;
        }

        .analysis-section-grid {
            display: grid;
            gap: 1rem;
        }

        @media (min-width: 1024px) {
            .analysis-section-grid {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }
        }

        .analysis-section-card {
            position: relative;
            border-radius: 22px;
            border: 1px solid rgba(148, 163, 184, 0.1);
            background: linear-gradient(160deg, rgba(15, 23, 42, 0.95), rgba(30, 41, 59, 0.85));
            padding: 1.4rem 1.6rem;
            min-height: 180px;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            box-shadow: 0 24px 50px rgba(8, 47, 73, 0.35);
        }

        .analysis-section-card .analysis-section-title {
            display: flex;
            align-items: center;
            gap: 0.6rem;
            font-size: 1.05rem;
            font-weight: 600;
            color: #e2e8f0;
            font-family: 'Poppins', sans-serif;
            letter-spacing: 0.01em;
        }

        .analysis-section-card .analysis-section-body {
            font-size: 0.92rem;
            line-height: 1.6;
            color: #cbd5f5;
        }

        .analysis-section-card .analysis-section-body > :first-child {
            margin-top: 0;
        }

        .analysis-section-card .analysis-section-body > :last-child {
            margin-bottom: 0;
        }

        .analysis-section-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            width: 6px;
            border-radius: 22px 0 0 22px;
            background: var(--section-accent, #38bdf8);
        }

        .analysis-section-card ul {
            margin: 0;
            padding-left: 1.1rem;
        }

        .analysis-section-card li {
            margin-bottom: 0.35rem;
        }

        .analysis-hero-visual img {
            width: 100%;
            border-radius: 16px;
            border: 1px solid rgba(148, 163, 184, 0.2);
            box-shadow: 0 18px 35px rgba(15, 23, 42, 0.35);
        }

        .analysis-hero-visual figcaption {
            margin-top: 0.5rem;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            color: #94a3b8;
            text-align: center;
        }

        @media (max-width: 1024px) {
            #floatingGenerateBtn {
                right: 1rem;
                bottom: 1rem;
            }

            .loading-progress-track,
            .loading-progress-labels {
                width: min(360px, 90vw);
            }
        }
    </style>
</head>
<body class="bg-slate-950 text-slate-300 font-sans antialiased" style="font-family: 'Inter', 'Poppins', sans-serif;">

    <!-- Main Container -->
    <div class="flex flex-col min-h-screen">

        <!-- Header -->
        <header class="bg-slate-800/50 backdrop-blur-sm shadow-lg sticky top-0 z-50">
            <nav class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <div class="flex items-center">
                        <i data-lucide="shield-check" class="text-sky-400 h-8 w-8 mr-3"></i>
                        <h1 class="text-2xl font-bold text-white">Pro Scout AI</h1>
                    </div>
                    <button id="howToUseBtn" class="flex items-center bg-sky-500 hover:bg-sky-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                        <i data-lucide="help-circle" class_="h-5 w-5 mr-2"></i>
                        <span class="hidden sm:inline">How to Use</span>
                    </button>
                </div>
            </nav>
            <!-- Tab Navigation -->
            <div class="bg-slate-800 border-t border-slate-700">
                <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="flex space-x-2 sm:space-x-4 overflow-x-auto tab-nav-scroll" style="-ms-overflow-style: none; scrollbar-width: none;">
                        <button class="tab-btn" data-tab="dashboard">
                            <i data-lucide="layout-dashboard" class="h-4 w-4 mr-2"></i>Dashboard
                        </button>
                        <button class="tab-btn" data-tab="singlePlayer">
                            <i data-lucide="user" class="h-4 w-4 mr-2"></i>Single Player
                        </button>
                        <button class="tab-btn" data-tab="savedReports">
                            <i data-lucide="bookmark" class="h-4 w-4 mr-2"></i>Saved Reports
                        </button>
                        <button class="tab-btn" data-tab="comparison">
                            <i data-lucide="users" class="h-4 w-4 mr-2"></i>Comparison
                        </button>
                        <button class="tab-btn" data-tab="opposition">
                            <i data-lucide="shield-off" class="h-4 w-4 mr-2"></i>Opposition
                        </button>
                        <button class="tab-btn" data-tab="search">
                            <i data-lucide="search" class="h-4 w-4 mr-2"></i>Advanced Search
                        </button>
                        <button class="tab-btn" data-tab="chatbot">
                            <i data-lucide="bot" class="h-4 w-4 mr-2"></i>AI Chatbot
                        </button>
                        <button class="tab-btn" data-tab="resources">
                            <i data-lucide="book-open" class="h-4 w-4 mr-2"></i>Resources
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="container mx-auto p-4 sm:p-6 lg:p-8 flex-grow">

            <!-- TAB: Dashboard -->
            <div id="dashboardTab" class="tab-content space-y-6">
                <section class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-5">
                    <article class="bg-slate-800/70 rounded-2xl border border-slate-700/60 shadow-xl hover:shadow-sky-500/10 transition transform hover:-translate-y-1 p-6 flex flex-col justify-between">
                        <div>
                            <div class="flex items-center justify-between mb-4">
                                <span class="inline-flex items-center justify-center h-10 w-10 rounded-full bg-sky-500/20 text-sky-300">
                                    <i data-lucide="user-check" class="h-5 w-5"></i>
                                </span>
                                <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Player Focus</span>
                            </div>
                            <h2 class="text-lg font-semibold text-white">Player Analysis</h2>
                            <p class="mt-2 text-sm text-slate-400">Deep dive into individual performances with multimedia insights and tactical context.</p>
                        </div>
                        <button class="mt-6 inline-flex items-center justify-center gap-2 rounded-xl bg-sky-500/90 hover:bg-sky-400 text-white py-2.5 px-4 font-medium transition" data-open-tab="singlePlayer">
                            Launch
                            <i data-lucide="arrow-up-right" class="h-4 w-4"></i>
                        </button>
                    </article>
                    <article class="bg-slate-800/70 rounded-2xl border border-slate-700/60 shadow-xl hover:shadow-teal-500/10 transition transform hover:-translate-y-1 p-6 flex flex-col justify-between">
                        <div>
                            <div class="flex items-center justify-between mb-4">
                                <span class="inline-flex items-center justify-center h-10 w-10 rounded-full bg-teal-500/20 text-teal-300">
                                    <i data-lucide="shield" class="h-5 w-5"></i>
                                </span>
                                <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Collective IQ</span>
                            </div>
                            <h2 class="text-lg font-semibold text-white">Team Analysis</h2>
                            <p class="mt-2 text-sm text-slate-400">Assess squad structure, phases of play, and opposition tendencies in a unified workspace.</p>
                        </div>
                        <button class="mt-6 inline-flex items-center justify-center gap-2 rounded-xl bg-teal-500/90 hover:bg-teal-400 text-white py-2.5 px-4 font-medium transition" data-open-tab="opposition">
                            Explore
                            <i data-lucide="arrow-up-right" class="h-4 w-4"></i>
                        </button>
                    </article>
                    <article class="bg-slate-800/70 rounded-2xl border border-slate-700/60 shadow-xl hover:shadow-indigo-500/10 transition transform hover:-translate-y-1 p-6 flex flex-col justify-between">
                        <div>
                            <div class="flex items-center justify-between mb-4">
                                <span class="inline-flex items-center justify-center h-10 w-10 rounded-full bg-indigo-500/20 text-indigo-300">
                                    <i data-lucide="users" class="h-5 w-5"></i>
                                </span>
                                <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Head-to-Head</span>
                            </div>
                            <h2 class="text-lg font-semibold text-white">Compare Players</h2>
                            <p class="mt-2 text-sm text-slate-400">Overlay heatmaps, stats, and qualitative data to benchmark talent profiles.</p>
                        </div>
                        <button class="mt-6 inline-flex items-center justify-center gap-2 rounded-xl bg-indigo-500/90 hover:bg-indigo-400 text-white py-2.5 px-4 font-medium transition" data-open-tab="comparison">
                            Compare
                            <i data-lucide="arrow-up-right" class="h-4 w-4"></i>
                        </button>
                    </article>
                    <article class="bg-slate-800/70 rounded-2xl border border-slate-700/60 shadow-xl hover:shadow-amber-500/10 transition transform hover:-translate-y-1 p-6 flex flex-col justify-between">
                        <div>
                            <div class="flex items-center justify-between mb-4">
                                <span class="inline-flex items-center justify-center h-10 w-10 rounded-full bg-amber-500/20 text-amber-300">
                                    <i data-lucide="database" class="h-5 w-5"></i>
                                </span>
                                <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Talent Radar</span>
                            </div>
                            <h2 class="text-lg font-semibold text-white">Search Database</h2>
                            <p class="mt-2 text-sm text-slate-400">Query emerging prospects, filter by market fit, and surface similar profiles instantly.</p>
                        </div>
                        <button class="mt-6 inline-flex items-center justify-center gap-2 rounded-xl bg-amber-500/90 hover:bg-amber-400 text-slate-900 py-2.5 px-4 font-medium transition" data-open-tab="search">
                            Search
                            <i data-lucide="arrow-up-right" class="h-4 w-4"></i>
                        </button>
                    </article>
                </section>

                <section class="grid grid-cols-1 lg:grid-cols-2 gap-5">
                    <div class="bg-slate-800/60 border border-slate-700 rounded-2xl p-6 flex flex-col gap-4">
                        <div class="flex items-center justify-between">
                            <h3 class="text-white font-semibold text-lg">Quick Actions</h3>
                            <span class="text-xs uppercase tracking-widest text-slate-500">Productivity</span>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <button class="quick-action" data-open-tab="singlePlayer"><i data-lucide="file-text" class="h-4 w-4"></i>New Player Report</button>
                            <button class="quick-action" data-open-tab="opposition"><i data-lucide="flag" class="h-4 w-4"></i>Team Briefing</button>
                            <button class="quick-action" data-open-tab="comparison"><i data-lucide="git-branch" class="h-4 w-4"></i>Compare Profiles</button>
                            <button class="quick-action" data-open-tab="chatbot"><i data-lucide="message-circle" class="h-4 w-4"></i>Ask Scout AI</button>
                        </div>
                    </div>
                </section>

                <section class="bg-gradient-to-br from-slate-800/80 to-slate-900/80 border border-slate-700 rounded-2xl p-6 flex flex-col lg:flex-row lg:items-center lg:justify-between gap-6">
                    <div>
                        <h3 class="text-white text-xl font-semibold">Workflow Tips</h3>
                        <p class="text-sm text-slate-400 leading-relaxed max-w-2xl">Jump into a player, comparison, or opposition workspace from the cards above. Each workspace now includes its own AI Narrative Builder for quickly packaging insights into stakeholder-ready clips.</p>
                    </div>
                    <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 text-sm text-slate-300">
                        <div class="bg-slate-900/60 border border-slate-700 rounded-xl px-3 py-2 shadow-lg shadow-sky-500/10 text-center">
                            <p class="font-semibold text-sky-300">1</p>
                            <p class="text-xs uppercase tracking-wide text-slate-500">Upload</p>
                        </div>
                        <div class="bg-slate-900/60 border border-slate-700 rounded-xl px-3 py-2 shadow-lg shadow-sky-500/10 text-center">
                            <p class="font-semibold text-sky-300">2</p>
                            <p class="text-xs uppercase tracking-wide text-slate-500">Analyze</p>
                        </div>
                        <div class="bg-slate-900/60 border border-slate-700 rounded-xl px-3 py-2 shadow-lg shadow-sky-500/10 text-center">
                            <p class="font-semibold text-sky-300">3</p>
                            <p class="text-xs uppercase tracking-wide text-slate-500">Narrate</p>
                        </div>
                        <div class="bg-slate-900/60 border border-slate-700 rounded-xl px-3 py-2 shadow-lg shadow-sky-500/10 text-center">
                            <p class="font-semibold text-sky-300">4</p>
                            <p class="text-xs uppercase tracking-wide text-slate-500">Deliver</p>
                        </div>
                    </div>
                </section>
            </div>

            <!-- TAB: Single Player Analysis -->
            <div id="singlePlayerTab" class="tab-content grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Left Column: Inputs -->
                <div class="flex flex-col space-y-6">
                    <!-- Player Info -->
                    <div class="bg-slate-800 p-5 rounded-lg shadow-lg">
                        <h2 class="text-xl font-semibold text-white mb-4">1. Player Information</h2>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <input id="playerName" type="text" placeholder="Player Name (e.g., Arda GÃ¼ler)" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-sky-500">
                            <input id="playerAge" type="number" placeholder="Age (e.g., 19)" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-sky-500">
                            <input id="playerClub" type="text" placeholder="Club (e.g., Real Madrid)" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-sky-500">
                            <input id="playerLeague" type="text" placeholder="League (e.g., La Liga)" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-sky-500">
                            <input id="playerPositions" type="text" placeholder="Position(s) (e.g., CAM, RW)" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-sky-500">
                            <input id="matchContext" type="text" placeholder="Match Context (e.g., vs. Barcelona)" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-sky-500">
                        </div>
                    </div>
                    
                    <!-- Report Type -->
                    <div class="bg-slate-800 p-5 rounded-lg shadow-lg">
                        <h2 class="text-xl font-semibold text-white mb-4">2. Report Type</h2>
                        <select id="reportType" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-sky-500">
                            <option value="quick">Quick Report (7-Point Analysis)</option>
                            <option value="pro">Pro Scout Report (Professional Template)</option>
                        </select>
                    </div>

                    <!-- Image Upload -->
                    <div class="bg-slate-800 p-5 rounded-lg shadow-lg">
                        <h2 class="text-xl font-semibold text-white mb-4">3. Upload Heatmap & Stats Images</h2>
                        <div id="dropZoneSingle" class="flex flex-col items-center justify-center w-full h-48 border-2 border-slate-600 border-dashed rounded-lg cursor-pointer bg-slate-700/50 hover:bg-slate-700 transition">
                            <div class="flex flex-col items-center justify-center pt-5 pb-6">
                                <i data-lucide="upload-cloud" class="w-10 h-10 mb-3 text-slate-400"></i>
                                <p class="mb-2 text-sm text-slate-400"><span class="font-semibold">Click to upload,</span> drag & drop, or paste</p>
                                <p class="text-xs text-slate-500">PNG, JPG, or WEBP (Multi-paste enabled)</p>
                            </div>
                            <input id="fileUploadSingle" type="file" class="hidden" multiple accept="image/png, image/jpeg, image/webp">
                        </div>
                        <div id="imagePreviewSingle" class="mt-4 grid grid-cols-2 sm:grid-cols-3 gap-4"></div>
                        <button id="scanStatsBtn" class="mt-4 w-full flex items-center justify-center bg-teal-500 hover:bg-teal-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                            <i data-lucide="scan-eye" class="h-5 w-5 mr-2"></i>
                            Scan Images for Stats
                        </button>
                    </div>

                    <!-- Text Stats -->
                    <div class="bg-slate-800 p-5 rounded-lg shadow-lg">
                        <h2 class="text-xl font-semibold text-white mb-4">4. Paste Additional Stats</h2>
                        <textarea id="textStatsSingle" rows="6" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-sky-500" placeholder="Paste stats here (e.g., Goals: 1, Tackles: 3/4, Pass Accuracy: 88%)..."></textarea>
                        <button id="visualizeStatsBtn" class="mt-4 w-full flex items-center justify-center bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 disabled:opacity-50" disabled>
                            <i data-lucide="bar-chart-3" class="h-5 w-5 mr-2"></i>
                            Visualize Text Stats
                        </button>
                        <div class="mt-4">
                            <canvas id="statsChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Right Column: Output -->
                <div class="flex flex-col space-y-6">
                    <div class="bg-slate-800 p-5 rounded-2xl shadow-xl sticky top-[128px] space-y-5"> <!-- 128px = header + tabs height -->
                        <div class="flex items-center justify-between">
                            <h2 class="text-xl font-semibold text-white">Scouting Report</h2>
                            <div class="flex items-center gap-2">
                                <button id="analyzeBtn" class="flex items-center gap-2 bg-sky-500 hover:bg-sky-600 text-white font-bold py-2.5 px-4 rounded-xl transition duration-200">
                                    <i data-lucide="sparkles" class="h-5 w-5"></i>
                                    Analyze
                                </button>
                                <button id="clearBtn" class="flex items-center gap-2 bg-red-500/90 hover:bg-red-500 text-white font-semibold py-2.5 px-4 rounded-xl transition duration-200">
                                    <i data-lucide="trash-2" class="h-5 w-5"></i>
                                    Clear
                                </button>
                            </div>
                        </div>

                        <!-- API Key Input -->
                        <div id="apiKeySection" class="bg-slate-900/70 border border-slate-700 rounded-xl p-4 space-y-3">
                            <div class="flex items-center justify-between">
                                <p class="text-sm font-medium text-slate-200">AI Service Status</p>
                                <span class="text-[0.65rem] uppercase tracking-[0.18em] text-slate-500">Secure proxy</span>
                            </div>
                            <p class="text-sm text-slate-300 leading-relaxed">
                                Gemini requests are routed through a Netlify Function so your API key stays on the server. Deployers should set the
                                <code class="bg-slate-800 text-slate-200 px-1 py-0.5 rounded">GEMINI_API_KEY</code> environment variable in Netlify. No key entry is required in the browser.
                            </p>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <label class="flex flex-col text-xs uppercase tracking-[0.2em] text-slate-400 gap-2">
                                Export Theme
                                <select id="reportTheme" class="bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-sm text-white">
                                    <option value="club">Club Identity</option>
                                    <option value="agency">Agency Pitch</option>
                                    <option value="academy">Academy Review</option>
                                    <option value="default" selected>Neutral</option>
                                </select>
                            </label>
                            <div class="flex flex-col gap-2">
                                <span class="text-xs uppercase tracking-[0.2em] text-slate-400">Saved Reports</span>
                                <div class="flex items-center gap-2">
                                    <button id="saveReportBtn" class="flex-1 flex items-center justify-center gap-2 bg-emerald-500/90 hover:bg-emerald-400 text-slate-900 font-semibold px-3 py-2 rounded-lg">
                                        <i data-lucide="bookmark-plus" class="h-5 w-5"></i>Save
                                    </button>
                                    <button id="loadReportBtn" class="flex-1 flex items-center justify-center gap-2 bg-slate-700 hover:bg-slate-600 text-white font-semibold px-3 py-2 rounded-lg">
                                        <i data-lucide="folder-open" class="h-5 w-5"></i>Load
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="flex flex-wrap gap-2" id="analysisViewControls">
                            <button class="analysis-view-btn active" data-view="summary">Summary</button>
                            <button class="analysis-view-btn" data-view="detailed">Detailed</button>
                            <button class="analysis-view-btn" data-view="tactical">Tactical</button>
                            <button class="analysis-view-btn" data-view="data">Data Table</button>
                        </div>

                        <!-- Export Buttons -->
                        <div id="exportButtons" class="hidden flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
                            <button id="copyBtn" class="flex-1 flex items-center justify-center bg-slate-700 hover:bg-slate-600 text-white font-semibold py-2.5 px-4 rounded-lg transition duration-200">
                                <i data-lucide="clipboard" class="h-5 w-5 mr-2"></i>Copy
                            </button>
                            <button id="pdfBtn" class="flex-1 flex items-center justify-center bg-slate-700 hover:bg-slate-600 text-white font-semibold py-2.5 px-4 rounded-lg transition duration-200">
                                <i data-lucide="file-text" class="h-5 w-5 mr-2"></i>Preview PDF
                            </button>
                            <button id="videoBtn" class="flex-1 flex items-center justify-center bg-slate-700 hover:bg-slate-600 text-white font-semibold py-2.5 px-4 rounded-lg transition duration-200">
                                <i data-lucide="youtube" class="h-5 w-5 mr-2"></i>Find Videos
                            </button>
                        </div>

                        <!-- Analysis Output -->
                        <div class="analysis-theme theme-default bg-slate-900/80 border border-slate-700 rounded-2xl p-4">
                            <div class="flex flex-col gap-4">
                                <div class="space-y-4">
                                    <div id="analysisOutput" class="analysis-view h-[40vh] lg:h-[50vh] overflow-y-auto rounded-xl bg-slate-950/70 border border-slate-800 p-4 prose prose-invert prose-slate max-w-none prose-h3:text-sky-300 prose-strong:text-white">
                                        <p class="text-slate-400">Your analysis will appear here. Start by filling out the fields on the left and click "Analyze Player".</p>
                                    </div>
                                    <div id="analysisDataView" class="analysis-view hidden h-[40vh] lg:h-[50vh] overflow-y-auto rounded-xl bg-slate-950/70 border border-slate-800 p-4 text-sm text-slate-200"></div>
                                </div>
                                <div class="rounded-xl border border-slate-800 bg-slate-950/60 p-3">
                                    <h3 class="text-sm font-semibold text-slate-200 flex items-center gap-2 mb-2">
                                        <i data-lucide="images" class="h-4 w-4 text-sky-400"></i>Visual Preview
                                    </h3>
                                    <div id="analysisVisuals" class="grid grid-cols-2 gap-2 max-h-48 overflow-y-auto"></div>
                                </div>
                                <div class="rounded-xl border border-slate-800 bg-slate-950/60 p-3">
                                    <h3 class="text-sm font-semibold text-slate-200 flex items-center gap-2 mb-2">
                                        <i data-lucide="notebook-text" class="h-4 w-4 text-emerald-400"></i>Highlights
                                    </h3>
                                    <div id="analysisSummary" class="text-sm text-slate-300 space-y-2"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-slate-800/90 border border-slate-700 rounded-2xl shadow-xl p-5 space-y-4">
                        <div class="flex items-center justify-between">
                            <h2 class="text-xl font-semibold text-white">AI Narrative Video Creator</h2>
                            <span class="text-xs uppercase tracking-[0.25em] text-slate-500">Player Story</span>
                        </div>
                        <p class="text-sm text-slate-400 leading-relaxed">Transform the latest scouting report into a short-form video script. Choose a tone, adjust duration, and preview narration, on-screen prompts, and recommended B-roll without leaving the workspace.</p>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                            <label class="flex flex-col gap-1 text-xs uppercase tracking-wide text-slate-500">
                                Narrative Tone
                                <select id="playerNarrativeTone" class="bg-slate-900 border border-slate-700 rounded-xl px-3 py-2 text-sm text-white">
                                    <option value="analytical">Analytical</option>
                                    <option value="motivational">Motivational</option>
                                    <option value="recruitment">Recruitment Pitch</option>
                                    <option value="academy">Academy Feedback</option>
                                </select>
                            </label>
                            <label class="flex flex-col gap-1 text-xs uppercase tracking-wide text-slate-500">
                                Duration Goal
                                <select id="playerNarrativeDuration" class="bg-slate-900 border border-slate-700 rounded-xl px-3 py-2 text-sm text-white">
                                    <option value="45">45 seconds</option>
                                    <option value="60">60 seconds</option>
                                    <option value="90">90 seconds</option>
                                </select>
                            </label>
                            <label class="flex flex-col gap-1 text-xs uppercase tracking-wide text-slate-500">
                                Voice
                                <select id="playerNarrativeVoice" class="bg-slate-900 border border-slate-700 rounded-xl px-3 py-2 text-sm text-white"></select>
                            </label>
                        </div>
                        <div class="flex flex-wrap gap-3">
                            <button id="playerGenerateNarrativeBtn" class="flex items-center gap-2 bg-gradient-to-r from-sky-500 to-indigo-500 hover:from-sky-400 hover:to-indigo-400 text-slate-900 font-semibold px-4 py-2 rounded-xl transition">
                                <i data-lucide="video" class="h-4 w-4"></i>Build Narrative Video
                            </button>
                            <button id="playerStopNarrativeBtn" class="flex items-center gap-2 bg-slate-900 border border-slate-700 text-slate-200 px-4 py-2 rounded-xl font-medium transition hidden">
                                <i data-lucide="square" class="h-4 w-4"></i>Stop Voice-over
                            </button>
                        </div>
                        <div class="bg-slate-900/80 border border-slate-800 rounded-xl p-4 space-y-4">
                            <div>
                                <h3 class="text-sm font-semibold text-white">Voice-Over Preview</h3>
                                <div id="playerNarrativeScript" class="space-y-2 text-sm text-slate-300 max-h-40 overflow-y-auto"></div>
                            </div>
                            <div>
                                <h3 class="text-sm font-semibold text-white">Storyboard Planner</h3>
                                <div id="playerNarrativeStoryboard" class="space-y-3 text-sm text-slate-300">
                                    <p class="text-xs text-slate-500">Generate a narrative to view suggested scenes and camera cues.</p>
                                </div>
                            </div>
                            <p class="text-xs text-slate-500">Audio playback uses your browser voice engine. Export visuals separately for final edits.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB: Saved Reports -->
            <div id="savedReportsTab" class="tab-content hidden space-y-6">
                <div class="bg-slate-800/80 border border-slate-700 rounded-2xl shadow-xl p-6 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                    <div>
                        <h2 class="text-2xl font-semibold text-white">Saved Player Reports</h2>
                        <p class="text-sm text-slate-400">Quickly reload previous scouting outputs, keep track of themes, and manage your workspace library.</p>
                    </div>
                    <button id="openLoadReportModalBtn" class="inline-flex items-center gap-2 bg-slate-900 border border-slate-700 hover:border-sky-500 hover:text-sky-300 text-white px-4 py-2 rounded-xl transition">
                        <i data-lucide="folder-open" class="h-4 w-4"></i>Open Modal View
                    </button>
                </div>
                <div id="savedReportsEmptyState" class="bg-slate-800/60 border border-dashed border-slate-700 rounded-2xl p-10 text-center text-slate-400 text-sm hidden">
                    <i data-lucide="bookmark-plus" class="mx-auto h-8 w-8 text-slate-500 mb-3"></i>
                    <p>No saved reports yet. Run a player analysis and click <strong>Save</strong> to build your library.</p>
                </div>
                <div id="savedReportsGrid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-5"></div>
            </div>

            <!-- TAB: Saved Reports -->
            <div id="savedReportsTab" class="tab-content hidden space-y-6">
                <div class="bg-slate-800/80 border border-slate-700 rounded-2xl shadow-xl p-6 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                    <div>
                        <h2 class="text-2xl font-semibold text-white">Saved Player Reports</h2>
                        <p class="text-sm text-slate-400">Quickly reload previous scouting outputs, keep track of themes, and manage your workspace library.</p>
                    </div>
                    <button id="openLoadReportModalBtn" class="inline-flex items-center gap-2 bg-slate-900 border border-slate-700 hover:border-sky-500 hover:text-sky-300 text-white px-4 py-2 rounded-xl transition">
                        <i data-lucide="folder-open" class="h-4 w-4"></i>Open Modal View
                    </button>
                </div>
                <div id="savedReportsEmptyState" class="bg-slate-800/60 border border-dashed border-slate-700 rounded-2xl p-10 text-center text-slate-400 text-sm hidden">
                    <i data-lucide="bookmark-plus" class="mx-auto h-8 w-8 text-slate-500 mb-3"></i>
                    <p>No saved reports yet. Run a player analysis and click <strong>Save</strong> to build your library.</p>
                </div>
                <div id="savedReportsGrid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-5"></div>
            </div>

            <!-- TAB: Player Comparison -->
            <div id="comparisonTab" class="tab-content hidden">
                 <!-- Comparison Controls -->
                <div class="flex items-center space-x-2 mb-4">
                    <button id="analyzeCompareBtn" class="flex-1 flex items-center justify-center bg-sky-500 hover:bg-sky-600 text-white font-bold py-3 px-6 rounded-lg transition duration-200">
                        <i data-lucide="sparkles" class="h-5 w-5 mr-2"></i>
                        Analyze Comparison
                    </button>
                    <button id="clearCompareBtn" class="flex-1 flex items-center justify-center bg-red-500 hover:bg-red-600 text-white font-semibold py-3 px-6 rounded-lg transition duration-200">
                        <i data-lucide="trash-2" class="h-5 w-5 mr-2"></i>
                        Clear Comparison
                    </button>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Player 1 Column -->
                    <div class="flex flex-col space-y-6">
                        <div class="bg-slate-800 p-5 rounded-lg shadow-lg">
                            <h2 class="text-xl font-semibold text-white mb-4">Player 1</h2>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                                <input id="p1Name" type="text" placeholder="Player 1 Name" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-sky-500">
                                <input id="p1Age" type="number" placeholder="Age" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-sky-500">
                                <input id="p1Club" type="text" placeholder="Club" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-sky-500">
                                <input id="p1League" type="text" placeholder="League" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-sky-500">
                            </div>
                            <div id="dropZoneCompare1" class="flex flex-col items-center justify-center w-full h-40 border-2 border-slate-600 border-dashed rounded-lg cursor-pointer bg-slate-700/50 hover:bg-slate-700 transition">
                                <p class="text-slate-400">Upload P1 Images (Paste, Drag, Click)</p>
                            </div>
                            <input id="fileUploadCompare1" type="file" class="hidden" multiple accept="image/png, image/jpeg, image/webp">
                            <div id="imagePreviewCompare1" class="mt-4 grid grid-cols-3 gap-2"></div>
                            <textarea id="textStatsCompare1" rows="4" class="mt-4 w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-sky-500" placeholder="Paste Player 1's stats..."></textarea>
                        </div>
                    </div>
                    <!-- Player 2 Column -->
                    <div class="flex flex-col space-y-6">
                        <div class="bg-slate-800 p-5 rounded-lg shadow-lg">
                            <h2 class="text-xl font-semibold text-white mb-4">Player 2</h2>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                                <input id="p2Name" type="text" placeholder="Player 2 Name" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-sky-500">
                                <input id="p2Age" type="number" placeholder="Age" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-sky-500">
                                <input id="p2Club" type="text" placeholder="Club" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-sky-500">
                                <input id="p2League" type="text" placeholder="League" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-sky-500">
                            </div>
                            <div id="dropZoneCompare2" class="flex flex-col items-center justify-center w-full h-40 border-2 border-slate-600 border-dashed rounded-lg cursor-pointer bg-slate-700/50 hover:bg-slate-700 transition">
                                <p class="text-slate-400">Upload P2 Images (Paste, Drag, Click)</p>
                            </div>
                            <input id="fileUploadCompare2" type="file" class="hidden" multiple accept="image/png, image/jpeg, image/webp">
                            <div id="imagePreviewCompare2" class="mt-4 grid grid-cols-3 gap-2"></div>
                            <textarea id="textStatsCompare2" rows="4" class="mt-4 w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-sky-500" placeholder="Paste Player 2's stats..."></textarea>
                        </div>
                    </div>
                </div>
                <!-- Comparison Output -->
                <div class="mt-6 bg-slate-800 p-5 rounded-lg shadow-lg">
                    <h2 class="text-xl font-semibold text-white mb-4">Head-to-Head Analysis</h2>
                    <div id="analysisOutputCompare" class="w-full h-[60vh] overflow-y-auto bg-slate-900 border border-slate-700 rounded-lg p-4 prose prose-invert prose-slate max-w-none prose-h3:text-sky-300">
                        <p class="text-slate-400">Your comparison will appear here. Add data for both players and click "Analyze Comparison".</p>
                    </div>
                </div>
            </div>

            <!-- TAB: Opposition Analysis -->
            <div id="oppositionTab" class="tab-content hidden">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Inputs -->
                    <div class="flex flex-col space-y-6">
                        <div class="bg-slate-800 p-5 rounded-lg shadow-lg">
                            <h2 class="text-xl font-semibold text-white mb-4">1. Opposition Info</h2>
                            <input id="opponentName" type="text" placeholder="Opponent Team Name (e.g., Manchester City)" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-sky-500">
                        </div>
                        <div class="bg-slate-800 p-5 rounded-lg shadow-lg">
                            <h2 class="text-xl font-semibold text-white mb-4">2. Upload Formation, Heatmaps, etc.</h2>
                            <div id="dropZoneOpponent" class="flex flex-col items-center justify-center w-full h-48 border-2 border-slate-600 border-dashed rounded-lg cursor-pointer bg-slate-700/50 hover:bg-slate-700 transition">
                                <p class="text-slate-400">Upload Images (Paste, Drag, Click)</p>
                            </div>
                            <input id="fileUploadOpponent" type="file" class="hidden" multiple accept="image/png, image/jpeg, image/webp">
                            <div id="imagePreviewOpponent" class="mt-4 grid grid-cols-3 gap-2"></div>
                        </div>
                        <div class="bg-slate-800 p-5 rounded-lg shadow-lg">
                            <h2 class="text-xl font-semibold text-white mb-4">3. Paste Team Stats & Notes</h2>
                            <textarea id="textStatsOpponent" rows="6" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-sky-500" placeholder="Paste team stats, recent form, key players, tactical notes..."></textarea>
                        </div>
                    </div>
                    <!-- Output -->
                    <div class="bg-slate-800 p-5 rounded-lg shadow-lg">
                        <!-- Opposition Controls -->
                        <div class="flex items-center space-x-2 mb-4">
                            <button id="analyzeOpponentBtn" class="flex-1 flex items-center justify-center bg-sky-500 hover:bg-sky-600 text-white font-bold py-3 px-6 rounded-lg transition duration-200">
                                <i data-lucide="sparkles" class="h-5 w-5 mr-2"></i>
                                Analyze Opponent
                            </button>
                            <button id="clearOpponentBtn" class="flex-1 flex items-center justify-center bg-red-500 hover:bg-red-600 text-white font-semibold py-3 px-6 rounded-lg transition duration-200">
                                <i data-lucide="trash-2" class="h-5 w-5 mr-2"></i>
                                Clear
                            </button>
                        </div>
                        <div class="flex items-center space-x-2 mb-4">
                            <button id="saveOpponentAnalysisBtn" class="flex-1 flex items-center justify-center bg-teal-500 hover:bg-teal-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                                <i data-lucide="save" class="h-5 w-5 mr-2"></i>Save
                            </button>
                            <button id="loadOpponentAnalysisBtn" class="flex-1 flex items-center justify-center bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                                <i data-lucide="folder-down" class="h-5 w-5 mr-2"></i>Load
                            </button>
                        </div>
                        <h2 class="text-xl font-semibold text-white mb-4">Tactical Report & Exploitation Plan</h2>
                        <div id="analysisOutputOpponent" contenteditable="true" class="w-full h-[60vh] overflow-y-auto bg-slate-900 border border-slate-700 rounded-lg p-4 prose prose-invert prose-slate max-w-none prose-h3:text-sky-300 focus:outline-none focus:ring-2 focus:ring-sky-500">
                            <p class="text-slate-400">Your opposition analysis will appear here. Add info and click "Analyze Opponent".</p>
                        </div>
                    </div>
                </div>

                <div class="mt-6 bg-slate-800/90 border border-slate-700 rounded-2xl shadow-xl p-5 space-y-4">
                    <div class="flex items-center justify-between">
                        <h2 class="text-xl font-semibold text-white">AI Narrative Video Creator</h2>
                        <span class="text-xs uppercase tracking-[0.25em] text-slate-500">Opposition Brief</span>
                    </div>
                    <p class="text-sm text-slate-400 leading-relaxed">Spin your tactical analysis into a briefing-ready video outline. Generate narration, slide prompts, and closing reminders for coaching presentations.</p>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                        <label class="flex flex-col gap-1 text-xs uppercase tracking-wide text-slate-500">
                            Narrative Tone
                            <select id="opponentNarrativeTone" class="bg-slate-900 border border-slate-700 rounded-xl px-3 py-2 text-sm text-white">
                                <option value="analytical">Analytical</option>
                                <option value="motivational">Motivational</option>
                                <option value="tactical">Tactical Briefing</option>
                                <option value="urgent">Urgent Alert</option>
                            </select>
                        </label>
                        <label class="flex flex-col gap-1 text-xs uppercase tracking-wide text-slate-500">
                            Duration Goal
                            <select id="opponentNarrativeDuration" class="bg-slate-900 border border-slate-700 rounded-xl px-3 py-2 text-sm text-white">
                                <option value="45">45 seconds</option>
                                <option value="60">60 seconds</option>
                                <option value="90">90 seconds</option>
                            </select>
                        </label>
                        <label class="flex flex-col gap-1 text-xs uppercase tracking-wide text-slate-500">
                            Voice
                            <select id="opponentNarrativeVoice" class="bg-slate-900 border border-slate-700 rounded-xl px-3 py-2 text-sm text-white"></select>
                        </label>
                    </div>
                    <div class="flex flex-wrap gap-3">
                        <button id="opponentGenerateNarrativeBtn" class="flex items-center gap-2 bg-gradient-to-r from-teal-500 to-emerald-500 hover:from-teal-400 hover:to-emerald-400 text-slate-900 font-semibold px-4 py-2 rounded-xl transition">
                            <i data-lucide="video" class="h-4 w-4"></i>Build Briefing Video
                        </button>
                        <button id="opponentStopNarrativeBtn" class="flex items-center gap-2 bg-slate-900 border border-slate-700 text-slate-200 px-4 py-2 rounded-xl font-medium transition hidden">
                            <i data-lucide="square" class="h-4 w-4"></i>Stop Voice-over
                        </button>
                    </div>
                    <div class="bg-slate-900/80 border border-slate-800 rounded-xl p-4 space-y-4">
                        <div>
                            <h3 class="text-sm font-semibold text-white">Briefing Script</h3>
                            <div id="opponentNarrativeScript" class="space-y-2 text-sm text-slate-300 max-h-40 overflow-y-auto"></div>
                        </div>
                        <div>
                            <h3 class="text-sm font-semibold text-white">Storyboard Planner</h3>
                            <div id="opponentNarrativeStoryboard" class="space-y-3 text-sm text-slate-300">
                                <p class="text-xs text-slate-500">Run the AI briefing to populate slide prompts and closing reminders.</p>
                            </div>
                        </div>
                        <p class="text-xs text-slate-500">Use this script alongside match clips or tactical boards to deliver a concise message.</p>
                    </div>
                </div>
            </div>

            <!-- TAB: Advanced Player Search -->
            <div id="searchTab" class="tab-content hidden">
                <div class="bg-slate-800 p-5 rounded-lg shadow-lg">
                    <h2 class="text-xl font-semibold text-white mb-4">Advanced Player Search</h2>
                    <p class="text-slate-400 mb-6">Use Google AI to find players based on your criteria. Not all fields are required.</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <input id="searchPosition" type="text" placeholder="Position (e.g., DM, Striker)" class="bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-sky-500">
                        <input id="searchAge" type="text" placeholder="Age (e.g., 18-22)" class="bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-sky-500">
                        <input id="searchNationality" type="text" placeholder="Nationality / Passport (e.g., EU)" class="bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-sky-500">
                        <input id="searchMarketValue" type="text" placeholder="Market Value (e.g., < â¬5m)" class="bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-sky-500">
                        <input id="searchContract" type="text" placeholder="Contract Expires (e.g., < 1 year)" class="bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-sky-500">
                        <input id="searchMatches" type="text" placeholder="Matches Played (e.g., > 20)" class="bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-sky-500">
                        <input id="searchLeague" type="text" placeholder="Suitable for League (e.g., Serie A)" class="bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-sky-500">
                        <input id="searchClub" type="text" placeholder="Suitable for Club (e.g., Liverpool)" class="bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-sky-500">
                        <input id="searchSimilar" type="text" placeholder="Similar Player Target" class="bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-sky-500">
                        <textarea id="searchStats" rows="3" class="md:col-span-2 lg:col-span-3 bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-sky-500" placeholder="Specific Stats (e.g., > 5 goals, > 80% pass accuracy, high pressing stats)..."></textarea>
                        
                        <button id="suggestStatsBtn" class="md:col-span-2 lg:col-span-3 w-full flex items-center justify-center bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 disabled:opacity-50" disabled>
                            <i data-lucide="lightbulb" class="h-5 w-5 mr-2"></i>
                            Suggest Stats Based on Position
                        </button>
                    </div>
                    <button id="searchButton" class="mt-6 w-full flex items-center justify-center bg-sky-500 hover:bg-sky-600 text-white font-bold py-3 px-6 rounded-lg transition duration-200">
                        <i data-lucide="search" class="h-5 w-5 mr-2"></i>
                        Search Players
                    </button>
                </div>
                <!-- Search Results -->
                <div class="mt-6 bg-slate-800 p-5 rounded-lg shadow-lg">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold text-white">Search Results</h2>
                        <button id="downloadCsvBtn" class="hidden bg-teal-500 hover:bg-teal-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                            <i data-lucide="download" class="h-5 w-5 mr-2"></i>Download CSV
                        </button>
                    </div>
                    <div id="searchError" class="hidden text-red-400 p-3 bg-red-900/50 rounded-lg mb-4"></div>
                    <div id="searchResults" class="w-full h-[60vh] overflow-auto bg-slate-900 border border-slate-700 rounded-lg p-4">
                        <p class="text-slate-400">Your search results will appear here.</p>
                    </div>
                </div>
            </div>
            
            <!-- TAB: Scout AI Chatbot -->
            <div id="chatbotTab" class="tab-content hidden">
                <div class="bg-slate-800 p-5 rounded-lg shadow-lg max-w-4xl mx-auto">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold text-white">Scout AI Chatbot</h2>
                        <button id="newChatBtn" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-3 rounded-lg transition duration-200">
                            <i data-lucide="plus" class="h-5 w-5 mr-1"></i>New Chat
                        </button>
                    </div>
                    <p class="text-slate-400 mb-4">Ask real-time, scout-related questions. Powered by Google Search.</p>
                    <div id="chatWindow" class="w-full h-[60vh] overflow-y-auto bg-slate-900 border border-slate-700 rounded-lg p-4 mb-4 space-y-4">
                        <!-- Chat messages will appear here -->
                        <div class="p-3 bg-slate-700 rounded-lg max-w-3/4">
                            <p class="font-semibold text-sky-300 mb-1">Scout AI</p>
                            <p>Hi! Ask me anything, like "What is the tactical style of Brighton?" or "Summarize Lamine Yamal's stats this season."</p>
                        </div>
                    </div>
                    <div class="flex space-x-2">
                        <input id="chatInput" type="text" placeholder="Ask a question..." class="flex-grow bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-sky-500">
                        <button id="chatSendBtn" class="bg-sky-500 hover:bg-sky-600 text-white font-bold p-3 rounded-lg transition duration-200">
                            <i data-lucide="send" class="h-6 w-6"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- TAB: Resources -->
            <div id="resourcesTab" class="tab-content hidden">
                <div class="bg-slate-800 p-6 rounded-lg shadow-lg max-w-4xl mx-auto prose prose-invert prose-slate max-w-none prose-h3:text-sky-300 prose-a:text-teal-400 hover:prose-a:text-teal-300">
                    <h2 class="text-2xl font-semibold text-white mb-4">Scouting Resources</h2>
                    <p>A curated list of public resources to help with data collection and tactical analysis.</p>

                    <h3>Data & Statistics Websites</h3>
                    <ul>
                        <li><a href="https://www.sofascore.com" target="_blank">Sofascore</a> - Great for live stats, player ratings, and heatmaps.</li>
                        <li><a href="https://fbref.com" target="_blank">FBref</a> - The most comprehensive public database for advanced football statistics.</li>
                        <li><a href="https://www.transfermarkt.com" target="_blank">Transfermarkt</a> - Best for market values, contract info, and transfer rumors.</li>
                        <li><a href="https://www.whoscored.com" target="_blank">WhoScored</a> - Good for statistical-based player ratings and team characteristics.</li>
                    </ul>

                    <h3>Tactical Analysis & Long-Form</h3>
                    <ul>
                        <li><a href="https://www.thecoachesvoice.com" target="_blank">The Coaches' Voice</a> - High-level analysis from professional coaches.</li>
                        <li><a href="https://breakingthelines.com" target="_blank">Breaking the Lines</a> - Excellent long-form tactical profiles and analysis.</li>
                        <li><a href="https://totalfootballanalysis.com" target="_blank">Total Football Analysis</a> - In-depth tactical breakdowns and scout reports.</li>
                    </ul>

                    <h3>Public Scouting Guides & Books (PDFs)</h3>
                    <ul>
                        <li><a href="https://www.google.com/search?q=introduction+to+football+scouting+pdf" target="_blank">Introduction to Football Scouting (Search)</a> - Search for introductory guides on the principles of scouting.</li>
                        <li><a href="https://www.google.com/search?q=talent+identification+in+football+pdf" target="_blank">Talent Identification in Football (Search)</a> - Find academic papers and guides on T.I.D. models.</li>
                        <li><a href="https://www.google.com/search?q=pfsa+scouting+resources" target="_blank">PFSA (Professional Football Scouts Association) Resources</a> - Look for free articles and resources from professional scouting organizations.</li>
                    </ul>
                </div>
            </div>

        </main>
        <button id="floatingGenerateBtn" class="hidden">
            <i data-lucide="wand2" class="h-5 w-5"></i>
            Generate Report
        </button>
    </div>

    <!-- Loading Spinner Overlay -->
    <div id="loadingSpinner" class="hidden fixed inset-0 bg-slate-900/80 backdrop-blur-sm flex items-center justify-center z-[100]">
        <div class="flex flex-col items-center">
            <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-sky-500"></div>
            <p id="loadingText" class="text-white text-xl mt-4">Analyzing...</p>
            <p id="loadingStageLabel" class="text-[0.65rem] uppercase tracking-[0.3em] text-slate-500 mt-3">Preparing Assets</p>
            <div class="loading-progress-track mt-4">
                <div id="loadingProgressBar" class="loading-progress-bar"></div>
            </div>
            <div class="loading-progress-labels">
                <span data-loading-label="upload">Upload</span>
                <span data-loading-label="analysis">Analysis</span>
                <span data-loading-label="summary">Summary</span>
                <span data-loading-label="download">Export</span>
            </div>
        </div>
    </div>

    <!-- Error Modal -->
    <div id="errorModal" class="hidden fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-[101] flex items-center justify-center p-4">
        <div class="bg-slate-800 rounded-lg shadow-2xl max-w-md w-full p-6 border border-red-500/50">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-2xl font-bold text-red-400">Analysis Error</h3>
                <button id="closeErrorBtn" class="text-slate-400 hover:text-white">&times;</button>
            </div>
            <div classs="max-h-60 overflow-y-auto">
                <p id="errorMessage" class="text-slate-300">An unknown error occurred.</p>
            </div>
        </div>
    </div>
    
    <!-- "How to Use" Modal -->
    <div id="howToUseModal" class="hidden fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-[100] flex items-center justify-center p-4">
        <div class="bg-slate-800 rounded-lg shadow-2xl max-w-2xl w-full border border-slate-700">
            <div class="flex items-center justify-between p-5 border-b border-slate-700">
                <h3 class="text-2xl font-bold text-white">How to Use Pro Scout AI</h3>
                <button id="closeHowToUseBtn" class="text-slate-400 hover:text-white p-1 rounded-full hover:bg-slate-700">
                    <i data-lucide="x" class="h-6 w-6"></i>
                </button>
            </div>
            <div class="p-6 max-h-[70vh] overflow-y-auto prose prose-invert prose-slate max-w-none prose-h4:text-sky-300">
                <h4>Single Player Analysis</h4>
                <ol>
                    <li>Fill in the <strong>Player Information</strong>.</li>
                    <li>Select a <strong>Report Type</strong> (Quick or Pro).</li>
                    <li>Upload heatmap/stats images (you can drag, click, or paste anywhere on the tab).</li>
                    <li>Click <strong>"Scan Images for Stats"</strong> to let the AI read stats from your images.</li>
                    <li>(Optional) Add more stats to the <strong>"Paste Additional Stats"</strong> box. Click <strong>"Visualize"</strong> to see a chart.</li>
                    <li>Click <strong>"Analyze Player"</strong>. The AI will generate a report.</li>
                    <li>Once complete, you can <strong>Copy</strong>, <strong>Preview PDF</strong> (with download), or <strong>Find Videos</strong>.</li>
                </ol>
                
                <h4>Player Comparison</h4>
                <ol>
                    <li>Add info, images, and stats for <strong>Player 1</strong> and <strong>Player 2</strong>.</li>
                    <li>Click the <strong>"Analyze Comparison"</strong> button on this tab.</li>
                    <li>Your Head-to-Head report will appear.</li>
                </ol>
                
                <h4>Opposition Analysis</h4>
                <ol>
                    <li>Add the opponent's name, tactical images, and team stats.</li>
                    <li>For a quick search, just enter the <strong>Opponent Name</strong>.</li>
                    <li>Click the <strong>"Analyze Opponent"</strong> button on this tab.</li>
                    <li>A tactical report will be generated. You can <strong>edit</strong> this report.</li>
                    <li>Click <strong>"Save"</strong> to store it in your browser. Click <strong>"Load"</strong> to see saved reports.</li>
                </ol>

                <h4>Advanced Player Search</h4>
                <ol>
                    <li>Fill in any criteria you want to search for.</li>
                    <li>Enter a position and click <strong>"Suggest Stats"</strong> for AI-powered help.</li>
                    <li>Click <strong>"Search Players"</strong>. The AI will use Google Search to find real players.</li>
                    <li>Results will appear in a table. You can then <strong>Download CSV</strong>.</li>
                </ol>

                <h4>Scout AI Chatbot</h4>
                <ol>
                    <li>Ask any scout-related question (e.g., "What is Man City's tactical style?", "Summarize Arda GÃ¼ler's season").</li>
                    <li>The AI will use Google Search to give you a real-time, up-to-date answer.</li>
                    <li>Click <strong>"New Chat"</strong> to clear the history.</li>
                </ol>

                <h4>API Key</h4>
                <p>Gemini traffic is proxied through a Netlify Function. Configure the <strong>GEMINI_API_KEY</strong> environment variable in your Netlify site settings&mdash;no keys are stored in or entered via the browser.</p>
            </div>
        </div>
    </div>

    <!-- PDF Preview Modal -->
    <div id="pdfPreviewModal" class="hidden fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-[101] flex items-center justify-center p-4">
        <div class="bg-slate-800 rounded-lg shadow-2xl max-w-4xl w-full p-6 border border-slate-700">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-2xl font-bold text-white">PDF Preview</h3>
                <button id="closePdfPreviewBtn" class="text-slate-400 hover:text-white p-1 rounded-full hover:bg-slate-700">
                    <i data-lucide="x" class="h-6 w-6"></i>
                </button>
            </div>
            <iframe id="pdfPreviewFrame" class="bg-white rounded" title="PDF Preview"></iframe>
            <button id="downloadPdfBtn" class="mt-4 w-full flex items-center justify-center bg-sky-500 hover:bg-sky-600 text-white font-bold py-3 px-6 rounded-lg transition duration-200">
                <i data-lucide="download" class="h-5 w-5 mr-2"></i>Download PDF
            </button>
        </div>
    </div>

    <div id="pdfContent" class="hidden"></div>

    <!-- Load Opponent Analysis Modal -->
    <div id="loadOpponentModal" class="hidden fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-[101] flex items-center justify-center p-4">
        <div class="bg-slate-800 rounded-lg shadow-2xl max-w-xl w-full p-6 border border-slate-700">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-2xl font-bold text-white">Load Saved Analysis</h3>
                <button id="closeLoadOpponentModalBtn" class="text-slate-400 hover:text-white p-1 rounded-full hover:bg-slate-700">
                    <i data-lucide="x" class="h-6 w-6"></i>
                </button>
            </div>
            <div id="loadOpponentList" class="max-h-[60vh] overflow-y-auto space-y-2">
                <!-- Saved analyses will be listed here -->
                <p class="text-slate-400">No saved analyses found.</p>
            </div>
        </div>
    </div>

    <div id="loadReportModal" class="hidden fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-[101] flex items-center justify-center p-4">
        <div class="bg-slate-800 rounded-lg shadow-2xl max-w-xl w-full p-6 border border-slate-700">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-2xl font-bold text-white">Saved Player Reports</h3>
                <button id="closeLoadReportModalBtn" class="text-slate-400 hover:text-white p-1 rounded-full hover:bg-slate-700">
                    <i data-lucide="x" class="h-6 w-6"></i>
                </button>
            </div>
            <div id="savedReportsList" class="max-h-[60vh] overflow-y-auto space-y-2">
                <p class="text-slate-400">No saved reports yet.</p>
            </div>
        </div>
    </div>


    <!-- Hidden element for PDF generation -->
    <div id="pdf-content" class="a4-page" style="position: absolute; left: -9999px; width: 210mm; font-family: 'Inter', 'Poppins', sans-serif; color: #0f172a; background: #f8fafc;">
        <!-- This will be populated by JS -->
    </div>


    <script type="module">
        // Initialize Lucide icons
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        } else {
            console.error("Lucide icons script not loaded.");
        }

        // Get global variables from environment (if they exist)
        const APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'default-pro-scout-ai';
        
        // --- DOM Elements ---
        const tabButtons = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');
        
        // Modals
        const howToUseBtn = document.getElementById('howToUseBtn');
        const howToUseModal = document.getElementById('howToUseModal');
        const closeHowToUseBtn = document.getElementById('closeHowToUseBtn');
        const errorModal = document.getElementById('errorModal');
        const closeErrorBtn = document.getElementById('closeErrorBtn');
        const errorMessage = document.getElementById('errorMessage');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const loadingText = document.getElementById('loadingText');
        const loadOpponentModal = document.getElementById('loadOpponentModal');
        const closeLoadOpponentModalBtn = document.getElementById('closeLoadOpponentModalBtn');
        const loadOpponentList = document.getElementById('loadOpponentList');
        const loadReportModal = document.getElementById('loadReportModal');
        const closeLoadReportModalBtn = document.getElementById('closeLoadReportModalBtn');
        const savedReportsList = document.getElementById('savedReportsList');
        const savedReportsGrid = document.getElementById('savedReportsGrid');
        const savedReportsEmptyState = document.getElementById('savedReportsEmptyState');
        const openLoadReportModalBtn = document.getElementById('openLoadReportModalBtn');
        const floatingGenerateBtn = document.getElementById('floatingGenerateBtn');
        const analysisViewControls = document.getElementById('analysisViewControls');
        const analysisDataView = document.getElementById('analysisDataView');
        const analysisSummary = document.getElementById('analysisSummary');
        const analysisVisuals = document.getElementById('analysisVisuals');
        const analysisContainer = document.querySelector('.analysis-theme');
        const reportTheme = document.getElementById('reportTheme');
        const saveReportBtn = document.getElementById('saveReportBtn');
        const loadReportBtn = document.getElementById('loadReportBtn');
        const narrativeBuilders = {
            player: {
                tone: document.getElementById('playerNarrativeTone'),
                duration: document.getElementById('playerNarrativeDuration'),
                voice: document.getElementById('playerNarrativeVoice'),
                script: document.getElementById('playerNarrativeScript'),
                storyboard: document.getElementById('playerNarrativeStoryboard'),
                generateBtn: document.getElementById('playerGenerateNarrativeBtn'),
                stopBtn: document.getElementById('playerStopNarrativeBtn'),
                context: 'player'
            },
            opponent: {
                tone: document.getElementById('opponentNarrativeTone'),
                duration: document.getElementById('opponentNarrativeDuration'),
                voice: document.getElementById('opponentNarrativeVoice'),
                script: document.getElementById('opponentNarrativeScript'),
                storyboard: document.getElementById('opponentNarrativeStoryboard'),
                generateBtn: document.getElementById('opponentGenerateNarrativeBtn'),
                stopBtn: document.getElementById('opponentStopNarrativeBtn'),
                context: 'opponent'
            }
        };
        const loadingProgressBar = document.getElementById('loadingProgressBar');
        const loadingStageLabel = document.getElementById('loadingStageLabel');
        const loadingProgressLabels = document.querySelectorAll('[data-loading-label]');
        const quickActionButtons = document.querySelectorAll('[data-open-tab]');

        // PDF Modal
        const pdfBtn = document.getElementById('pdfBtn');
        const pdfPreviewModal = document.getElementById('pdfPreviewModal');
        const closePdfPreviewBtn = document.getElementById('closePdfPreviewBtn');
        const pdfPreviewFrame = document.getElementById('pdfPreviewFrame');
        const downloadPdfBtn = document.getElementById('downloadPdfBtn');
        const pdfContent = document.getElementById('pdfContent');
        let generatedPdfBlobUrl = null;

        // Export Buttons
        const exportButtons = document.getElementById('exportButtons');
        const copyBtn = document.getElementById('copyBtn');
        const videoBtn = document.getElementById('videoBtn');
        
        // --- Single Player Tab ---
        const analyzeBtn = document.getElementById('analyzeBtn');
        const clearBtn = document.getElementById('clearBtn');
        const playerName = document.getElementById('playerName');
        const playerAge = document.getElementById('playerAge');
        const playerClub = document.getElementById('playerClub');
        const playerLeague = document.getElementById('playerLeague');
        const playerPositions = document.getElementById('playerPositions');
        const matchContext = document.getElementById('matchContext');
        const reportType = document.getElementById('reportType');
        const dropZoneSingle = document.getElementById('dropZoneSingle');
        const fileUploadSingle = document.getElementById('fileUploadSingle');
        const imagePreviewSingle = document.getElementById('imagePreviewSingle');
        const textStatsSingle = document.getElementById('textStatsSingle');
        const analysisOutput = document.getElementById('analysisOutput');
        const scanStatsBtn = document.getElementById('scanStatsBtn');
        const visualizeStatsBtn = document.getElementById('visualizeStatsBtn');
        const statsChartCanvas = document.getElementById('statsChart');
        let statsChart = null;
        let singlePlayerImages = []; // Store base64 images

        // --- Comparison Tab ---
        const analyzeCompareBtn = document.getElementById('analyzeCompareBtn');
        const clearCompareBtn = document.getElementById('clearCompareBtn');
        const dropZoneCompare1 = document.getElementById('dropZoneCompare1');
        const fileUploadCompare1 = document.getElementById('fileUploadCompare1');
        const imagePreviewCompare1 = document.getElementById('imagePreviewCompare1');
        const textStatsCompare1 = document.getElementById('textStatsCompare1');
        const p1Name = document.getElementById('p1Name');
        const p1Age = document.getElementById('p1Age');
        const p1Club = document.getElementById('p1Club');
        const p1League = document.getElementById('p1League');
        let compare1Images = [];
        
        const dropZoneCompare2 = document.getElementById('dropZoneCompare2');
        const fileUploadCompare2 = document.getElementById('fileUploadCompare2');
        const imagePreviewCompare2 = document.getElementById('imagePreviewCompare2');
        const textStatsCompare2 = document.getElementById('textStatsCompare2');
        const p2Name = document.getElementById('p2Name');
        const p2Age = document.getElementById('p2Age');
        const p2Club = document.getElementById('p2Club');
        const p2League = document.getElementById('p2League');
        let compare2Images = [];
        const analysisOutputCompare = document.getElementById('analysisOutputCompare');
        
        // --- Opposition Tab ---
        const analyzeOpponentBtn = document.getElementById('analyzeOpponentBtn');
        const clearOpponentBtn = document.getElementById('clearOpponentBtn');
        const saveOpponentAnalysisBtn = document.getElementById('saveOpponentAnalysisBtn');
        const loadOpponentAnalysisBtn = document.getElementById('loadOpponentAnalysisBtn');
        const opponentName = document.getElementById('opponentName');
        const dropZoneOpponent = document.getElementById('dropZoneOpponent');
        const fileUploadOpponent = document.getElementById('fileUploadOpponent');
        const imagePreviewOpponent = document.getElementById('imagePreviewOpponent');
        const textStatsOpponent = document.getElementById('textStatsOpponent');
        const analysisOutputOpponent = document.getElementById('analysisOutputOpponent');
        let opponentImages = [];

        // --- Search Tab ---
        const searchButton = document.getElementById('searchButton');
        const searchResults = document.getElementById('searchResults');
        const searchError = document.getElementById('searchError');
        const searchPosition = document.getElementById('searchPosition');
        const searchAge = document.getElementById('searchAge');
        const searchNationality = document.getElementById('searchNationality');
        const searchMarketValue = document.getElementById('searchMarketValue');
        const searchContract = document.getElementById('searchContract');
        const searchMatches = document.getElementById('searchMatches');
        const searchLeague = document.getElementById('searchLeague');
        const searchClub = document.getElementById('searchClub');
        const searchSimilar = document.getElementById('searchSimilar');
        const searchStats = document.getElementById('searchStats');
        const suggestStatsBtn = document.getElementById('suggestStatsBtn');
        const downloadCsvBtn = document.getElementById('downloadCsvBtn');
        let csvContent = "";
        
        // --- Chatbot Tab ---
        const chatWindow = document.getElementById('chatWindow');
        const chatInput = document.getElementById('chatInput');
        const chatSendBtn = document.getElementById('chatSendBtn');
        const newChatBtn = document.getElementById('newChatBtn');
        let chatHistory = [];

        const GEMINI_PROXY_ENDPOINT = '/.netlify/functions/gemini-proxy';

        // --- State ---
        let currentTab = 'dashboard';
        const LS_REPORT_KEY = 'proScoutSingleReports';
        const STAGE_ORDER = ['upload', 'analysis', 'summary', 'download'];
        const STAGE_TITLES = {
            upload: 'Preparing Assets',
            analysis: 'Running Analysis',
            summary: 'Building Summary',
            download: 'Finalizing Export'
        };
        let savedReports = [];
        let analysisViews = { summary: '', detailed: '', tactical: '', data: '' };
        let currentAnalysisView = 'summary';
        let speechUtterance = null;
        const funnyLoadingMessages = [
            "Brewing some tactical tea...",
            "Analyzing... Did he really just try that flick?",
            "Asking the VAR... just kidding.",
            "Calculating xG (Expected Genius)...",
            "Polishing the heatmap...",
            "Finding similar players... not just his cousin.",
            "Scouting for hidden gems...",
            "Checking contract clauses... mostly the buyout one.",
            "Re-watching the match... at 2x speed."
        ];

        // --- Utility Functions ---

        function showLoading(text, stage) {
            if (text) {
                loadingText.textContent = text;
            } else {
                loadingText.textContent = funnyLoadingMessages[Math.floor(Math.random() * funnyLoadingMessages.length)];
            }
            updateWorkflowStage(stage || 'upload');
            loadingSpinner.classList.remove('hidden');
        }

        function hideLoading() {
            loadingSpinner.classList.add('hidden');
            if (loadingProgressBar) {
                loadingProgressBar.style.width = '0%';
            }
            if (loadingStageLabel) {
                loadingStageLabel.textContent = STAGE_TITLES.upload;
            }
            if (loadingProgressLabels && loadingProgressLabels.length) {
                loadingProgressLabels.forEach(label => label.classList.remove('active'));
            }
        }

        function updateWorkflowStage(stage) {
            const stageIndex = STAGE_ORDER.indexOf(stage);
            if (stageIndex === -1) return;

            if (loadingProgressBar) {
                const progress = STAGE_ORDER.length > 1
                    ? (stageIndex / (STAGE_ORDER.length - 1)) * 100
                    : 100;
                loadingProgressBar.style.width = `${Math.max(progress, 0)}%`;
            }

            if (loadingStageLabel) {
                loadingStageLabel.textContent = STAGE_TITLES[stage] || stage.toUpperCase();
            }

            if (loadingProgressLabels && loadingProgressLabels.length) {
                loadingProgressLabels.forEach(label => {
                    const labelStage = label.dataset.loadingLabel;
                    const labelIndex = STAGE_ORDER.indexOf(labelStage);
                    if (labelIndex === -1) return;
                    label.classList.toggle('active', labelIndex <= stageIndex);
                });
            }

        }

        function showError(message) {
            errorMessage.textContent = message;
            errorModal.classList.remove('hidden');
            hideLoading();
        }

        function closeError() {
            errorModal.classList.add('hidden');
        }

        function showHowToUse() {
            howToUseModal.classList.remove('hidden');
        }

        function closeHowToUse() {
            howToUseModal.classList.add('hidden');
        }
        
        function showPdfPreview() {
            pdfPreviewModal.classList.remove('hidden');
        }

        function closePdfPreview() {
            pdfPreviewModal.classList.add('hidden');
            if (generatedPdfBlobUrl) {
                URL.revokeObjectURL(generatedPdfBlobUrl);
                generatedPdfBlobUrl = null;
            }
            pdfPreviewFrame.src = 'about:blank';
        }

        function showLoadOpponentModal() {
            loadOpponentAnalyses(); // Populate list
            loadOpponentModal.classList.remove('hidden');
        }

        function closeLoadOpponentModal() {
            loadOpponentModal.classList.add('hidden');
        }

        function showTab(tabId) {
            // Hide all content
            tabContents.forEach(content => content.classList.add('hidden'));

            // Deactivate all buttons
            tabButtons.forEach(button => {
                button.classList.remove('border-sky-400', 'text-white');
                button.classList.add('border-transparent', 'text-slate-400', 'hover:text-white');
            });

            // Show selected content
            const contentToShow = document.getElementById(tabId + 'Tab');
            if (contentToShow) {
                contentToShow.classList.remove('hidden');
            }

            // Activate selected button
            const buttonToActivate = document.querySelector(`.tab-btn[data-tab="${tabId}"]`);
            if (buttonToActivate) {
                buttonToActivate.classList.add('border-sky-400', 'text-white');
                buttonToActivate.classList.remove('border-transparent', 'text-slate-400');
            }
            
            currentTab = tabId;
        }

        function getAnalysisViewButtons() {
            return analysisViewControls ? analysisViewControls.querySelectorAll('.analysis-view-btn') : [];
        }

        function updateViewButtons(activeView) {
            const buttons = getAnalysisViewButtons();
            buttons.forEach(button => {
                if (button.dataset.view === activeView) {
                    button.classList.add('active');
                } else {
                    button.classList.remove('active');
                }
            });
        }

        function applyReportTheme(theme) {
            if (!analysisContainer) return;
            analysisContainer.classList.remove('theme-default', 'theme-club', 'theme-agency', 'theme-academy');
            const themeClass = theme && theme !== 'default' ? `theme-${theme}` : 'theme-default';
            analysisContainer.classList.add(themeClass);
        }

        function renderAnalysisVisuals() {
            if (!analysisVisuals) return;
            analysisVisuals.innerHTML = '';
            if (!singlePlayerImages.length) {
                analysisVisuals.innerHTML = '<p class="text-xs text-slate-500">Upload heatmaps or stat boards to preview them alongside the report.</p>';
                return;
            }

            singlePlayerImages.forEach((img, index) => {
                const card = document.createElement('div');
                card.classList.add('relative', 'overflow-hidden', 'rounded-lg', 'border', 'border-slate-800', 'bg-slate-900/80');

                const image = document.createElement('img');
                image.src = img.preview || `data:${img.mimeType};base64,${img.base64}`;
                image.classList.add('w-full', 'h-28', 'object-cover', 'transition', 'duration-200', 'hover:scale-105');
                card.appendChild(image);

                const caption = document.createElement('div');
                caption.classList.add('absolute', 'bottom-0', 'left-0', 'right-0', 'bg-slate-900/75', 'text-[0.65rem]', 'text-slate-100', 'py-1', 'text-center', 'tracking-wide');
                caption.textContent = `Asset ${index + 1}`;
                card.appendChild(caption);

                analysisVisuals.appendChild(card);
            });
        }

        function prepareAnalysisViews(html, markdown) {
            analysisViews = buildAnalysisSections(html, markdown);
            if (analysisDataView) {
                analysisDataView.innerHTML = analysisViews.data || '<p class="text-slate-500">No structured data tables detected.</p>';
            }
            showAnalysisView('summary');
            updateHighlights();
        }

        function getSectionPalette(title = '') {
            const lower = title.toLowerCase();
            if (lower.includes('strength')) {
                return { accent: '#14b8a6', text: '#5eead4', icon: 'â' };
            }
            if (lower.includes('weak')) {
                return { accent: '#f87171', text: '#fca5a5', icon: 'â ï¸' };
            }
            if (lower.includes('tactic')) {
                return { accent: '#6366f1', text: '#c7d2fe', icon: 'âï¸' };
            }
            if (lower.includes('position')) {
                return { accent: '#0ea5e9', text: '#bae6fd', icon: 'ð' };
            }
            if (lower.includes('action')) {
                return { accent: '#a855f7', text: '#e9d5ff', icon: 'ð¯' };
            }
            if (lower.includes('mentality')) {
                return { accent: '#f97316', text: '#fed7aa', icon: 'ð§ ' };
            }
            if (lower.includes('conclusion') || lower.includes('recommend')) {
                return { accent: '#22d3ee', text: '#bae6fd', icon: 'ð' };
            }
            if (lower.includes('similar')) {
                return { accent: '#22c55e', text: '#bbf7d0', icon: 'ð¤' };
            }
            if (lower.includes('development') || lower.includes('plan')) {
                return { accent: '#38bdf8', text: '#bae6fd', icon: 'ð' };
            }
            if (lower.includes('rating')) {
                return { accent: '#38bdf8', text: '#bae6fd', icon: 'â­' };
            }
            if (lower.includes('summary') || lower.includes('overview')) {
                return { accent: '#0ea5e9', text: '#bae6fd', icon: 'ð' };
            }
            return { accent: '#7dd3fc', text: '#e0f2fe', icon: 'ð' };
        }

        function buildAnalysisSections(html) {
            const views = { summary: '', detailed: html, tactical: '', data: '' };
            const parser = new DOMParser();
            const doc = parser.parseFromString(`<div>${html}</div>`, 'text/html');
            const container = doc.body.firstElementChild;
            if (!container) {
                views.summary = html;
                views.tactical = html;
                views.data = '<p class="text-slate-500">No structured data tables detected.</p>';
                return views;
            }

            const sections = [];
            const headings = container.querySelectorAll('h3');
            headings.forEach(heading => {
                const sectionContent = document.createElement('div');
                let next = heading.nextElementSibling;
                while (next && next.tagName !== 'H3') {
                    sectionContent.appendChild(next.cloneNode(true));
                    next = next.nextElementSibling;
                }
                sections.push({
                    title: heading.textContent || '',
                    html: sectionContent.innerHTML.trim()
                });
            });

            const tables = container.querySelectorAll('table');
            if (tables.length) {
                views.data = Array.from(tables).map(table => table.outerHTML).join('');
            } else {
                views.data = '<p class="text-slate-500">No structured data tables detected.</p>';
            }

            const renderCard = (section) => {
                const palette = getSectionPalette(section.title);
                const safeTitle = escapeHtml(section.title || 'Untitled Section');
                const body = section.html && section.html.trim()
                    ? section.html
                    : '<p class="text-slate-500 text-sm">No insights provided.</p>';
                return `
                    <article class="relative overflow-hidden rounded-2xl border border-slate-800 bg-slate-950/70 p-5 shadow-lg shadow-slate-900/30">
                        <span class="absolute inset-y-0 left-0 w-1.5" style="background:${palette.accent};"></span>
                        <div class="pl-4">
                            <div class="flex items-center gap-2">
                                <span class="text-base">${palette.icon || 'ð'}</span>
                                <h4 class="text-lg font-semibold" style="color:${palette.text};">${safeTitle}</h4>
                            </div>
                            <div class="mt-3 prose prose-sm prose-invert max-w-none leading-relaxed space-y-3">${body}</div>
                        </div>
                    </article>
                `;
            };

            const renderGrid = (list) => {
                if (!list.length) return '';
                return `<div class="grid gap-4 lg:grid-cols-2 auto-rows-fr">${list.map(renderCard).join('')}</div>`;
            };

            const summarySections = sections.filter(section => /summary|overview|highlights|rating|conclusion|recommendation/i.test(section.title));
            const tacticalSections = sections.filter(section => /tactic|position|positional|phase|action|mentality|role|structure/i.test(section.title));

            const summarySelection = summarySections.length ? summarySections : sections.slice(0, Math.min(sections.length, 3));
            const tacticalSelection = tacticalSections.length ? tacticalSections : sections.filter(section => /tactic|position|action|mentality|phase/i.test(section.title)).slice(0, 4);

            views.summary = summarySelection.length ? renderGrid(summarySelection) : html;
            views.tactical = tacticalSelection.length ? renderGrid(tacticalSelection) : (sections.length ? renderGrid(sections.slice(1, Math.min(sections.length, 4))) : html);
            views.detailed = sections.length ? renderGrid(sections) : html;

            return views;
        }

        function showAnalysisView(view) {
            currentAnalysisView = view;
            updateViewButtons(view);

            if (!analysisOutput) return;

            if (view === 'data') {
                analysisOutput.classList.add('hidden');
                if (analysisDataView) {
                    analysisDataView.innerHTML = analysisViews.data || '<p class="text-slate-500 text-sm">No structured data tables detected.</p>';
                    analysisDataView.classList.remove('hidden');
                }
            } else {
                analysisOutput.classList.remove('hidden');
                if (analysisDataView) analysisDataView.classList.add('hidden');
                const content = analysisViews[view] || '<p class="text-slate-400">Run an analysis to populate this view.</p>';
                analysisOutput.innerHTML = content;
            }
        }

        function updateHighlights() {
            if (!analysisSummary) return;
            const summaryHtml = analysisViews.summary;
            if (!summaryHtml) {
                analysisSummary.innerHTML = '<p class="text-xs text-slate-500">Generate a scouting report to see instant highlights.</p>';
                return;
            }

            const parser = new DOMParser();
            const doc = parser.parseFromString(`<div>${summaryHtml}</div>`, 'text/html');
            doc.querySelectorAll('[data-highlight-ignore]').forEach(node => node.remove());
            const bullets = Array.from(doc.querySelectorAll('li')).map(li => li.textContent.trim()).filter(Boolean);
            const paragraphs = Array.from(doc.querySelectorAll('p')).map(p => p.textContent.trim()).filter(Boolean);

            if (bullets.length) {
                const list = document.createElement('ul');
                list.classList.add('list-disc', 'pl-4', 'space-y-1');
                bullets.slice(0, 4).forEach(text => {
                    const item = document.createElement('li');
                    item.textContent = text;
                    list.appendChild(item);
                });
                analysisSummary.innerHTML = '';
                analysisSummary.appendChild(list);
            } else if (paragraphs.length) {
                analysisSummary.innerHTML = paragraphs.slice(0, 3).map(text => `<p>${text}</p>`).join('');
            } else {
                analysisSummary.innerHTML = '<p class="text-xs text-slate-500">Highlights will appear once the AI generates a report.</p>';
            }
        }

        function resetAnalysisViews() {
            analysisViews = { summary: '', detailed: '', tactical: '', data: '' };
            if (analysisOutput) {
                analysisOutput.innerHTML = '<p class="text-slate-400">Your analysis will appear here. Start by filling out the fields on the left and click "Analyze Player".</p>';
                analysisOutput.classList.remove('hidden');
            }
            if (analysisDataView) {
                analysisDataView.innerHTML = '<p class="text-slate-500 text-sm">Switch back after running an analysis to view data tables here.</p>';
                analysisDataView.classList.add('hidden');
            }
            if (analysisSummary) {
                analysisSummary.innerHTML = '<p class="text-xs text-slate-500">Highlights will appear once the AI generates a report.</p>';
            }
            updateViewButtons('summary');
            currentAnalysisView = 'summary';
        }

        function loadSavedReports() {
            if (typeof localStorage === 'undefined') {
                savedReports = [];
                renderSavedReports();
                return;
            }
            try {
                const stored = localStorage.getItem(LS_REPORT_KEY);
                savedReports = stored ? JSON.parse(stored) : [];
            } catch (error) {
                console.error('Failed to load saved reports', error);
                savedReports = [];
            }
            renderSavedReports();
        }

        function renderSavedReports() {
            if (!savedReportsList) return;

            savedReportsList.innerHTML = '';
            if (savedReportsGrid) savedReportsGrid.innerHTML = '';
            if (savedReportsEmptyState) savedReportsEmptyState.classList.add('hidden');

            if (!savedReports.length) {
                savedReportsList.innerHTML = '<p class="text-slate-400">No saved reports yet.</p>';
                if (savedReportsGrid) savedReportsGrid.innerHTML = '';
                if (savedReportsEmptyState) savedReportsEmptyState.classList.remove('hidden');
                if (typeof lucide !== 'undefined') lucide.createIcons();
                return;
            }

            savedReports.forEach(report => {
                const card = document.createElement('div');
                card.classList.add('bg-slate-900/80', 'border', 'border-slate-700', 'rounded-xl', 'p-4', 'flex', 'flex-col', 'gap-3');

                const header = document.createElement('div');
                header.classList.add('flex', 'items-center', 'justify-between');
                const title = document.createElement('p');
                title.classList.add('text-sm', 'font-semibold', 'text-white');
                title.textContent = report.playerName || 'Unnamed Player';
                const meta = document.createElement('span');
                meta.classList.add('text-xs', 'uppercase', 'tracking-wide', 'text-slate-500');
                meta.textContent = new Date(report.timestamp).toLocaleString();
                header.appendChild(title);
                header.appendChild(meta);

                const details = document.createElement('p');
                details.classList.add('text-xs', 'text-slate-400');
                details.textContent = `${report.reportType === 'pro' ? 'Pro Report' : 'Quick Report'} â¢ Theme: ${report.theme || 'default'}`;

                const actions = document.createElement('div');
                actions.classList.add('flex', 'items-center', 'gap-2');

                const loadBtn = document.createElement('button');
                loadBtn.classList.add('flex-1', 'bg-sky-500/90', 'hover:bg-sky-400', 'text-slate-900', 'font-semibold', 'px-3', 'py-2', 'rounded-lg', 'transition');
                loadBtn.dataset.loadReport = report.id;
                loadBtn.textContent = 'Load';

                const deleteBtn = document.createElement('button');
                deleteBtn.classList.add('flex-1', 'bg-slate-700', 'hover:bg-slate-600', 'text-white', 'font-semibold', 'px-3', 'py-2', 'rounded-lg', 'transition');
                deleteBtn.dataset.deleteReport = report.id;
                deleteBtn.textContent = 'Delete';

                actions.appendChild(loadBtn);
                actions.appendChild(deleteBtn);

                card.appendChild(header);
                card.appendChild(details);
                if (report.notes) {
                    const notes = document.createElement('p');
                    notes.classList.add('text-xs', 'text-slate-300');
                    notes.textContent = report.notes;
                    card.appendChild(notes);
                }
                card.appendChild(actions);

                savedReportsList.appendChild(card);

                if (savedReportsGrid) {
                    const gridCard = document.createElement('article');
                    gridCard.className = 'bg-slate-800/80 border border-slate-700 rounded-2xl shadow-lg p-5 flex flex-col gap-4 hover:border-sky-500/70 transition';

                    const gridHeader = document.createElement('div');
                    gridHeader.className = 'flex items-center justify-between';
                    const gridTitle = document.createElement('h3');
                    gridTitle.className = 'text-lg font-semibold text-white truncate';
                    gridTitle.textContent = report.playerName || 'Unnamed Player';
                    const gridBadge = document.createElement('span');
                    gridBadge.className = 'text-xs uppercase tracking-[0.2em] text-slate-500';
                    gridBadge.textContent = report.reportType === 'pro' ? 'Pro Report' : 'Quick Report';
                    gridHeader.appendChild(gridTitle);
                    gridHeader.appendChild(gridBadge);

                    const gridMeta = document.createElement('p');
                    gridMeta.className = 'text-xs text-slate-400';
                    gridMeta.textContent = `${new Date(report.timestamp).toLocaleString()} â¢ Theme: ${report.theme || 'default'}`;

                    const gridFooter = document.createElement('div');
                    gridFooter.className = 'flex items-center justify-between gap-2';

                    const loadAction = document.createElement('button');
                    loadAction.className = 'flex-1 inline-flex items-center justify-center gap-2 bg-sky-500/90 hover:bg-sky-400 text-slate-900 font-semibold px-3 py-2 rounded-xl transition';
                    loadAction.dataset.loadReport = report.id;
                    loadAction.innerHTML = '<i data-lucide="download" class="h-4 w-4"></i>Load';

                    const deleteAction = document.createElement('button');
                    deleteAction.className = 'flex items-center justify-center gap-2 bg-slate-900 border border-slate-700 hover:border-red-500 hover:text-red-300 text-slate-200 px-3 py-2 rounded-xl transition';
                    deleteAction.dataset.deleteReport = report.id;
                    deleteAction.innerHTML = '<i data-lucide="trash-2" class="h-4 w-4"></i>';

                    gridFooter.appendChild(loadAction);
                    gridFooter.appendChild(deleteAction);

                    gridCard.appendChild(gridHeader);
                    gridCard.appendChild(gridMeta);
                    gridCard.appendChild(gridFooter);

                    savedReportsGrid.appendChild(gridCard);
                }
            });

            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        function saveCurrentReport() {
            if (!analysisOutput || !analysisOutput.dataset.rawMarkdown) {
                showError('Generate a scouting report before saving.');
                return;
            }

            if (typeof localStorage === 'undefined') {
                showError('Saving reports is not supported in this environment.');
                return;
            }

            const report = {
                id: Date.now().toString(),
                playerName: playerName?.value?.trim() || 'Unnamed Player',
                age: playerAge?.value?.trim() || '',
                club: playerClub?.value?.trim() || '',
                league: playerLeague?.value?.trim() || '',
                positions: playerPositions?.value?.trim() || '',
                reportType: reportType?.value || 'quick',
                theme: reportTheme?.value || 'default',
                markdown: analysisOutput.dataset.rawMarkdown,
                timestamp: new Date().toISOString()
            };

            savedReports.unshift(report);
            localStorage.setItem(LS_REPORT_KEY, JSON.stringify(savedReports));
            renderSavedReports();

            if (saveReportBtn) {
                const original = saveReportBtn.innerHTML;
                saveReportBtn.innerHTML = '<i data-lucide="check" class="h-5 w-5"></i>Saved';
                if (typeof lucide !== 'undefined') lucide.createIcons();
                setTimeout(() => {
                    saveReportBtn.innerHTML = original;
                    if (typeof lucide !== 'undefined') lucide.createIcons();
                }, 2000);
            }
        }

        function loadReportById(id) {
            const report = savedReports.find(item => item.id === id);
            if (!report) return;

            if (playerName) playerName.value = report.playerName || '';
            if (playerAge) playerAge.value = report.age || '';
            if (playerClub) playerClub.value = report.club || '';
            if (playerLeague) playerLeague.value = report.league || '';
            if (playerPositions) playerPositions.value = report.positions || '';
            if (reportType) reportType.value = report.reportType || 'quick';
            if (reportTheme) reportTheme.value = report.theme || 'default';
            applyReportTheme(reportTheme.value);

            analysisOutput.dataset.rawMarkdown = report.markdown;
            displayResults(report.markdown, analysisOutput);
            updateWorkflowStage('summary');
            closeReportModal();
            showTab('singlePlayer');
        }

        function deleteReportById(id) {
            savedReports = savedReports.filter(report => report.id !== id);
            if (typeof localStorage !== 'undefined') {
                localStorage.setItem(LS_REPORT_KEY, JSON.stringify(savedReports));
            }
            renderSavedReports();
        }

        function openReportModal() {
            if (loadReportModal) loadReportModal.classList.remove('hidden');
        }

        function closeReportModal() {
            if (loadReportModal) loadReportModal.classList.add('hidden');
        }

        let activeNarrativeKey = null;

        function populateNarrativeVoices() {
            const voices = typeof window.speechSynthesis !== 'undefined'
                ? window.speechSynthesis.getVoices().filter(voice => voice.lang.startsWith('en'))
                : [];

            Object.values(narrativeBuilders).forEach(builder => {
                if (!builder?.voice) return;
                if (!voices.length) {
                    builder.voice.innerHTML = '<option value="">System Default</option>';
                    return;
                }
                builder.voice.innerHTML = voices.map(voice => `<option value="${voice.name}">${voice.name} (${voice.lang})</option>`).join('');
            });
        }

        function stopNarrativePlayback(builderKey = activeNarrativeKey) {
            if (typeof window.speechSynthesis !== 'undefined') {
                window.speechSynthesis.cancel();
            }
            speechUtterance = null;
            const builder = builderKey ? narrativeBuilders[builderKey] : null;
            if (builder?.stopBtn) {
                builder.stopBtn.classList.add('hidden');
            }
            activeNarrativeKey = null;
        }

        function speakNarrative(text, builderKey) {
            if (typeof window.speechSynthesis === 'undefined') return;
            stopNarrativePlayback();
            const builder = narrativeBuilders[builderKey];
            if (!builder) return;

            activeNarrativeKey = builderKey;
            speechUtterance = new SpeechSynthesisUtterance(text.replace(/[*_`]/g, ''));
            const duration = parseInt(builder.duration?.value || '60', 10);
            speechUtterance.rate = duration <= 45 ? 1.2 : duration >= 90 ? 0.9 : 1;

            if (builder.voice && builder.voice.value) {
                const targetVoice = window.speechSynthesis.getVoices().find(voice => voice.name === builder.voice.value);
                if (targetVoice) speechUtterance.voice = targetVoice;
            }

            speechUtterance.onend = () => {
                if (builder?.stopBtn) builder.stopBtn.classList.add('hidden');
                activeNarrativeKey = null;
            };

            window.speechSynthesis.speak(speechUtterance);
            if (builder?.stopBtn) builder.stopBtn.classList.remove('hidden');
        }

        function renderNarrativeStoryboard(rawText = '', builderKey) {
            const builder = narrativeBuilders[builderKey];
            if (!builder?.storyboard) return;

            const config = builderKey === 'player'
                ? {
                    voice: 'Voice-Over Script',
                    prompts: 'On-Screen Prompts',
                    visuals: 'Recommended B-Roll',
                    labels: ['Voice-Over Beats', 'On-Screen Prompts', 'B-Roll Ideas']
                }
                : {
                    voice: 'Briefing Script',
                    prompts: 'Key Slides',
                    visuals: 'Final Reminder',
                    labels: ['Briefing Beats', 'Slide Prompts', 'Closing Reminders']
                };

            const extractSection = (heading) => {
                if (!rawText) return '';
                const regex = new RegExp(`##\\s*${heading}[\\s\\S]*?(?=\\n##|$)`, 'i');
                const match = rawText.match(regex);
                if (!match) return '';
                return match[0].replace(/##[^\n]*\n?/, '').trim();
            };

            const cleanLine = (line) => escapeHtml(line.replace(/^[*-]\s*/, '').replace(/[*_`]/g, '').trim());
            const toItems = (block) => block
                .split(/\n+/)
                .map(cleanLine)
                .filter(Boolean);

            const voiceItems = toItems(extractSection(config.voice));
            const promptItems = toItems(extractSection(config.prompts));
            const visualItems = toItems(extractSection(config.visuals));

            const buildList = (items, ordered = false) => {
                if (!items.length) {
                    return '<p class="text-xs text-slate-500">Will populate after generation.</p>';
                }
                const listTag = ordered ? 'ol' : 'ul';
                const listClass = ordered ? 'list-decimal' : 'list-disc';
                return `<${listTag} class="${listClass} pl-4 space-y-2 text-sm text-slate-200">${items.map(item => `<li>${item}</li>`).join('')}</${listTag}>`;
            };

            builder.storyboard.innerHTML = `
                <div class="grid gap-3 lg:grid-cols-3">
                    <div class="rounded-lg border border-slate-800 bg-slate-950/60 p-3">
                        <h4 class="text-xs uppercase tracking-[0.25em] text-slate-500 mb-2">${config.labels[0]}</h4>
                        ${buildList(voiceItems, true)}
                    </div>
                    <div class="rounded-lg border border-slate-800 bg-slate-950/60 p-3">
                        <h4 class="text-xs uppercase tracking-[0.25em] text-slate-500 mb-2">${config.labels[1]}</h4>
                        ${buildList(promptItems)}
                    </div>
                    <div class="rounded-lg border border-slate-800 bg-slate-950/60 p-3">
                        <h4 class="text-xs uppercase tracking-[0.25em] text-slate-500 mb-2">${config.labels[2]}</h4>
                        ${buildList(visualItems)}
                    </div>
                </div>
            `;
        }

        async function generateNarrativeVideo(builderKey) {
            const builder = narrativeBuilders[builderKey];
            if (!builder) return;

            const duration = builder.duration?.value || '60';
            const tone = builder.tone?.value || 'analytical';

            if (builderKey === 'player') {
                if (!analysisOutput || !analysisOutput.dataset.rawMarkdown) {
                    showError('Generate a scouting report before building the narrative.');
                    return;
                }

                const theme = reportTheme?.value || 'default';
                showLoading('Generating narrative storyboard...', 'analysis');
                if (builder.storyboard) {
                    builder.storyboard.innerHTML = '<p class="text-xs text-slate-500">Drafting storyboard beats...</p>';
                }

                const prompt = `You are a creative football storyteller. Using the following scouting report, craft a ${duration}-second voice-over script with scene cues. Tone: ${tone}. Theme: ${theme}.\n\nReport:\n${analysisOutput.dataset.rawMarkdown}\n\nReturn Markdown with sections: \n## Voice-Over Script (2-3 paragraphs)\n## On-Screen Prompts (bullet list)\n## Recommended B-Roll (bullet list).`;

                try {
                    const narrative = await callGeminiApi([{ text: prompt }], false);
                    const formatted = formatChatText(narrative);
                    if (builder.script) {
                        builder.script.innerHTML = formatted;
                    }
                    renderNarrativeStoryboard(narrative, builderKey);
                    speakNarrative(narrative, builderKey);
                    updateWorkflowStage('summary');
                } catch (error) {
                    showError(`Failed to build narrative: ${error.message}`);
                } finally {
                    hideLoading();
                }
            } else if (builderKey === 'opponent') {
                const opponentContent = analysisOutputOpponent?.innerText?.trim();
                if (!opponentContent) {
                    showError('Generate an opposition report before building the briefing.');
                    return;
                }

                showLoading('Drafting opposition briefing...', 'analysis');
                if (builder.storyboard) {
                    builder.storyboard.innerHTML = '<p class="text-xs text-slate-500">Drafting storyboard beats...</p>';
                }

                const prompt = `You are an elite tactical presenter. Summarize the following opposition scouting report into a ${duration}-second voice-over script with actionable cues. Tone: ${tone}.\n\nReport:\n${opponentContent}\n\nReturn Markdown with sections: \n## Briefing Script (2-3 paragraphs)\n## Key Slides (bullet list)\n## Final Reminder (1-2 bullet points).`;

                try {
                    const narrative = await callGeminiApi([{ text: prompt }], false);
                    const formatted = formatChatText(narrative);
                    if (builder.script) {
                        builder.script.innerHTML = formatted;
                    }
                    renderNarrativeStoryboard(narrative, builderKey);
                    speakNarrative(narrative, builderKey);
                    updateWorkflowStage('summary');
                } catch (error) {
                    showError(`Failed to build briefing narrative: ${error.message}`);
                } finally {
                    hideLoading();
                }
            }
        }

        // --- Image Upload Handling ---
        
        function setupUploadListeners(dropZone, fileInput, previewEl, imageArray) {
            if (!dropZone || !fileInput) return;

            // Click to upload
            dropZone.addEventListener('click', () => fileInput.click());
            
            // Drag and Drop
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('border-sky-500', 'bg-slate-700');
            });
            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('border-sky-500', 'bg-slate-700');
            });
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('border-sky-500', 'bg-slate-700');
                handleFiles(e.dataTransfer.files, previewEl, imageArray);
            });
            
            // File input change
            fileInput.addEventListener('change', (e) => {
                handleFiles(e.target.files, previewEl, imageArray);
            });

            // Paste
            dropZone.addEventListener('paste', (e) => {
                handlePaste(e, previewEl, imageArray);
            });
        }
        
        function handlePaste(e, previewEl, imageArray) {
            e.preventDefault(); // Prevent browser from opening pasted image
            const items = (e.clipboardData || e.originalEvent.clipboardData).items;
            if (!items) return;

            for (let i = 0; i < items.length; i++) {
                if (items[i].kind === 'file' && items[i].type.indexOf('image') !== -1) {
                    const blob = items[i].getAsFile();
                    if (blob) {
                        processFile(blob, previewEl, imageArray);
                    }
                }
            }
        }

        function handleFiles(files, previewEl, imageArray) {
            if (!files) return;
            for (const file of files) {
                if (file.type.startsWith('image/')) {
                    processFile(file, previewEl, imageArray);
                }
            }
        }

        function processFile(file, previewEl, imageArray) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const base64 = e.target.result;
                const mimeType = file.type;

                // Store base64 string without data prefix for the API
                const apiData = {
                    base64: base64.split(',')[1],
                    mimeType: mimeType,
                    preview: base64
                };
                imageArray.push(apiData);

                // Update preview
                updateImagePreviews(previewEl, imageArray);
            };
            reader.readAsDataURL(file);
        }

        function updateImagePreviews(previewEl, imageArray) {
            if (!previewEl) return;
            previewEl.innerHTML = '';

            imageArray.forEach((item, index) => {
                const div = document.createElement('div');
                div.classList.add('relative', 'group');

                const img = document.createElement('img');
                const src = item.preview || `data:${item.mimeType};base64,${item.base64}`;
                img.src = src;
                img.classList.add('w-full', 'h-24', 'object-cover', 'rounded-lg', 'shadow-md');
                div.appendChild(img);

                const removeBtn = document.createElement('button');
                removeBtn.innerHTML = '&times;';
                removeBtn.classList.add('absolute', 'top-1', 'right-1', 'bg-red-600', 'text-white', 'rounded-full', 'w-5', 'h-5', 'flex', 'items-center', 'justify-center', 'text-xs', 'font-bold', 'opacity-0', 'group-hover:opacity-100', 'transition-opacity');
                removeBtn.onclick = () => {
                    imageArray.splice(index, 1);
                    updateImagePreviews(previewEl, imageArray);
                };
                div.appendChild(removeBtn);

                previewEl.appendChild(div);
            });

            if (previewEl === imagePreviewSingle) {
                renderAnalysisVisuals();
            }
        }


        // --- Clear Inputs Functions ---
        function clearSinglePlayerInputs() {
            if(playerName) playerName.value = '';
            if(playerAge) playerAge.value = '';
            if(playerClub) playerClub.value = '';
            if(playerLeague) playerLeague.value = '';
            if(playerPositions) playerPositions.value = '';
            if(matchContext) matchContext.value = '';
            if(reportType) reportType.value = 'quick';
            if(reportTheme) {
                reportTheme.value = 'default';
                applyReportTheme('default');
            }
            if(imagePreviewSingle) imagePreviewSingle.innerHTML = '';
            singlePlayerImages = [];
            if(textStatsSingle) textStatsSingle.value = '';
            if(analysisOutput) delete analysisOutput.dataset.rawMarkdown;
            resetAnalysisViews();
            renderAnalysisVisuals();
            stopNarrativePlayback();
            if(narrativeScript) narrativeScript.innerHTML = '<p class="text-xs text-slate-500">Run a report to generate a narrative storyboard.</p>';
            if (statsChart) {
                statsChart.destroy();
                statsChart = null;
            }
            if(visualizeStatsBtn) visualizeStatsBtn.disabled = true;
            if(exportButtons) exportButtons.classList.add('hidden');
            updateWorkflowStage('upload');
        }

        function clearCompareInputs() {
            if(p1Name) p1Name.value = '';
            if(p1Age) p1Age.value = '';
            if(p1Club) p1Club.value = '';
            if(p1League) p1League.value = '';
            if(p2Name) p2Name.value = '';
            if(p2Age) p2Age.value = '';
            if(p2Club) p2Club.value = '';
            if(p2League) p2League.value = '';
            if(imagePreviewCompare1) imagePreviewCompare1.innerHTML = '';
            compare1Images = [];
            if(textStatsCompare1) textStatsCompare1.value = '';
            if(imagePreviewCompare2) imagePreviewCompare2.innerHTML = '';
            compare2Images = [];
            if(textStatsCompare2) textStatsCompare2.value = '';
            if(analysisOutputCompare) analysisOutputCompare.innerHTML = '<p class="text-slate-400">Comparison cleared.</p>';
        }

        function clearOpponentInputs() {
            if(opponentName) opponentName.value = '';
            if(imagePreviewOpponent) imagePreviewOpponent.innerHTML = '';
            opponentImages = [];
            if(textStatsOpponent) textStatsOpponent.value = '';
            if(analysisOutputOpponent) analysisOutputOpponent.innerHTML = '<p class="text-slate-400">Opposition analysis cleared.</p>';
        }

        function clearSearchInputs() {
             if(searchPosition) searchPosition.value = '';
            if(searchAge) searchAge.value = '';
            if(searchNationality) searchNationality.value = '';
            if(searchMarketValue) searchMarketValue.value = '';
            if(searchContract) searchContract.value = '';
            if(searchMatches) searchMatches.value = '';
            if(searchLeague) searchLeague.value = '';
            if(searchClub) searchClub.value = '';
            if(searchStats) searchStats.value = '';
            if(searchSimilar) searchSimilar.value = '';
            if(suggestStatsBtn) suggestStatsBtn.disabled = true;
            if(searchResults) searchResults.innerHTML = '<p class="text-slate-400">Your search results will appear here.</p>';
            if(searchError) searchError.classList.add('hidden');
            if(downloadCsvBtn) downloadCsvBtn.classList.add('hidden');
        }

        async function invokeGemini(payload) {
            let response;
            try {
                response = await fetch(GEMINI_PROXY_ENDPOINT, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
            } catch (networkError) {
                console.error('Network error contacting Gemini proxy:', networkError);
                const error = new Error('Network error contacting AI service.');
                error.isNetworkError = true;
                throw error;
            }

            if (!response.ok) {
                let errorBody;
                try {
                    errorBody = await response.json();
                } catch (_) {
                    // ignore parse error
                }
                const message = errorBody?.error || errorBody?.details?.error?.message || `Gemini proxy error (${response.status})`;
                const error = new Error(message);
                error.status = response.status;
                error.details = errorBody;
                throw error;
            }

            try {
                return await response.json();
            } catch (parseError) {
                console.error('Failed to parse Gemini proxy response:', parseError);
                const error = new Error('Failed to parse AI response.');
                error.isParseError = true;
                throw error;
            }
        }

        // --- Main Analysis Logic ---
        
        /**
         * Calls the Gemini API.
         * @param {Array<Object>} parts - The content parts (text and images).
         * @param {boolean} useGrounding - Whether to enable Google Search.
         * @returns {Promise<string>} - The generated text response.
         */
        async function callGeminiApi(parts, useGrounding = false) {
            const payload = {
                contents: [{
                    role: "user",
                    parts: parts
                }],
                generationConfig: {
                    temperature: 0.3,
                    topP: 0.9,
                    topK: 10,
                }
            };

            if (useGrounding) {
                payload.tools = [{ "google_search": {} }];
            }

            let attempt = 0;
            const maxAttempts = 5;
            const baseDelay = 1000; // 1 second
            let lastError = null;

            while (attempt < maxAttempts) {
                try {
                    const result = await invokeGemini(payload);

                    if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts) {
                        return result.candidates[0].content.parts[0].text;
                    } else if (result.candidates && result.candidates[0].finishReason === "SAFETY") {
                        throw new Error("Analysis blocked by safety settings. The provided images or text may be sensitive.");
                    } else {
                        console.warn("Unexpected API response structure:", result);
                        throw new Error("Could not parse the AI's response.");
                    }

                } catch (error) {
                    lastError = error;
                    attempt++;
                    const retriable = (error.status && (error.status === 429 || error.status >= 500)) || error.isNetworkError;
                    if (retriable && attempt < maxAttempts) {
                        const delay = baseDelay * Math.pow(2, attempt) + Math.random() * 1000;
                        console.warn(`AI service error, retrying in ${Math.round(delay/1000)}s... (Attempt ${attempt}/${maxAttempts})`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                    } else {
                        console.error("Failed to call Gemini API:", error);
                        throw error;
                    }
                }
            }
            throw lastError || new Error("Failed to get a response from the AI after multiple attempts.");
        }
        
        /**
         * Calls the Gemini Vision API to scan stats from images.
         */
        async function scanStatsFromImage() {
            if (singlePlayerImages.length === 0) {
                showError("Please upload at least one image to scan for stats.");
                return;
            }

            showLoading("Scanning images for stats...");

            const parts = [
                { text: "Analyze the provided image(s). Extract any player statistics visible (e.g., Goals, Assists, Tackles, Pass Accuracy, etc.). Format them as a simple key-value list, like 'Goals: 1\nTackles: 3/4\nPass Accuracy: 88%'. Only return the extracted stats." }
            ];

            singlePlayerImages.forEach(img => {
                parts.push({
                    inlineData: {
                        mimeType: img.mimeType,
                        data: img.base64
                    }
                });
            });

            try {
                const extractedStats = await callGeminiApi(parts);
                textStatsSingle.value += (textStatsSingle.value ? '\n' : '') + extractedStats;
                if(visualizeStatsBtn) visualizeStatsBtn.disabled = false; // Enable visualization
            } catch (error) {
                showError(`Failed to scan stats: ${error.message}`);
            } finally {
                hideLoading();
            }
        }


        async function analyzeSinglePlayer() {
            updateWorkflowStage('analysis');
            showLoading(null, 'analysis');
            if(analysisOutput) {
                analysisOutput.innerHTML = '';
                delete analysisOutput.dataset.rawMarkdown;
            }
            if(exportButtons) exportButtons.classList.add('hidden');

            const parts = [];
            const info = {
                name: playerName.value.trim(),
                age: playerAge.value.trim(),
                club: playerClub.value.trim(),
                league: playerLeague.value.trim(),
                positions: playerPositions.value.trim(),
                match: matchContext.value.trim(),
            };
            
            // --- Build the Prompt ---
            let prompt = "You are a world-class professional football scout. Analyze the provided data to create a scouting report.\n\n";
            prompt += "--- Player Information ---\n";
            prompt += `Name: ${info.name || 'N/A'}\n`;
            prompt += `Age: ${info.age || 'N/A'}\n`;
            prompt += `Club: ${info.club || 'N/A'}\n`;
            prompt += `League: ${info.league || 'N/A'}\n`;
            prompt += `Stated Position(s): ${info.positions || 'N/A'}\n`;
            prompt += `Match Context: ${info.match || 'N/A'}\n\n`;
            
            prompt += "--- Provided Stats (Text) ---\n";
            prompt += `${textStatsSingle.value.trim() || 'No text stats provided.'}\n\n`;
            
            prompt += "--- INSTRUCTIONS ---\n";
            prompt += "Analyze the heatmap images, stats images, and text data.\n";
            prompt += "Immediately after Section 1, include a markdown table with columns | Category | Grade | Comment | covering at minimum Defensive Ability, Attacking Impact, and Tactical Fit. Use letter grades (A+ to F).\n";

            if (reportType.value === 'quick') {
                prompt += "Generate a 'Quick Report' using the following 7-point template. Be detailed and insightful for each section. Use markdown headers (e.g., '## 1. Title') and '---' separators.\n";
                prompt += "## 1. AI-Calculated Performance Rating\n(Provide a rating (e.g., B+, 7.5/10) and 1-2 sentences justifying it based on the data. Follow this section with the required Category/Grade/Comment table.)\n\n---\n\n";
                prompt += "## 2. Likely Position(s) & Role\n(Based on the heatmap and stats, what is their most likely position and tactical role? e.g., 'Deep-Lying Playmaker', 'Inverted Winger')\n\n---\n\n";
                prompt += "## 3. Key Duties & Playstyle\n(Describe their main actions and style. e.g., 'Controls tempo, progressive passer, avoids 1v1 duels.')\n\n---\n\n";
                prompt += "## 4. Key Strengths (Pros)\n(List 3-4 bullet points based on the data.)\n\n---\n\n";
                prompt += "## 5. Key Weaknesses (Cons)\n(List 2-3 bullet points based on the data.)\n\n---\n\n";
                prompt += "## 6. Suggested Similar Player\n(Suggest ONE well-known player with a similar playstyle and justify it.)\n\n---\n\n";
                prompt += "## 7. Suggested Development Plan\n(Based on the 'Cons', suggest 2-3 actionable development points.)\n";
            } else {
                prompt += "Generate a 'Pro Scout Report' using the following 8-point professional template. Be extremely detailed, analytical, and use scouting terminology. Use markdown headers (e.g., '## 1. Title') and '---' separators between sections.\n\n";
                prompt += "## 1. AI-Calculated Performance Rating\n(Provide a rating (e.g., 'A-' or '8.0/10') and a 1-2 sentence justification based *only* on the provided match data. Follow this section with the required Category/Grade/Comment table.)\n\n---\n\n";
                prompt += "## 2. Summary (Overview)\n(A brief overview of the player's performance, role, key strengths, and areas for improvement.)\n\n---\n\n";
                prompt += "## 3. Positional Play\n(Analyze positioning in Offensive, Defensive, and Transition phases based on the heatmap and stats.)\n\n---\n\n";
                prompt += "## 4. Key Actions (PMDS Framework)\n(Break down their most critical actions using PMDS: Position, Moment, Direction, Speed. e.g., 'Pressing: Showed good speed to close down, but his direction was poor, opening a passing lane.')\n\n---\n\n";
                prompt += "## 5. Tactical Awareness (Four Phases)\n(Assess their decision-making. Communication: Did they scan? Decision (What): Pass, dribble, shoot? Decision (How): Type of pass/dribble? Execution: Technical outcome.)\n\n---\n\n";
                prompt += "## 6. Mentality\n(Infer qualities from the data. Work rate (from heatmap), Composure (from pass % under pressure), Leadership, etc.)\n\n---\n\n";
                prompt += "## 7. Conclusion & Recommendation\n(Summarize potential, system suitability (e.g., 'Suits a high-press system'), and a final recommendation (e.g., 'Monitor', 'Sign').)\n\n---\n\n";
                prompt += "## 8. Similar Player Matrix\n(Provide 4 player comparisons in a markdown table:\n- **Top 5 League:** [Player Name] (e.g., Premier League, La Liga)\n- **Mid-Tier League:** [Player Name] (e.g., Eredivisie, MLS, Championship)\n- **Current League:** [Player Name] (A top player in their *current* league)\n- **Historical:** [Player Name] (A retired player))\n";
            }
            
            parts.push({ text: prompt });

            // Add images
            if (singlePlayerImages.length === 0) {
                showError("Please upload at least one image for analysis.");
                hideLoading();
                return;
            }
            singlePlayerImages.forEach(img => {
                parts.push({
                    inlineData: {
                        mimeType: img.mimeType,
                        data: img.base64
                    }
                });
            });

            try {
                const resultText = await callGeminiApi(parts);
                displayResults(resultText, analysisOutput);
                if(exportButtons) exportButtons.classList.remove('hidden');
                updateWorkflowStage('summary');
            } catch (error) {
                showError(`Analysis failed: ${error.message}`);
            } finally {
                hideLoading();
            }
        }
        
        async function analyzeComparison() {
            showLoading(); // Show random funny message
            if(analysisOutputCompare) analysisOutputCompare.innerHTML = '';

            const parts = [];
            
            const p1Info = `Player 1: ${p1Name.value || 'P1'} (Age: ${p1Age.value || 'N/A'}, Club: ${p1Club.value || 'N/A'}, League: ${p1League.value || 'N/A'})`;
            const p2Info = `Player 2: ${p2Name.value || 'P2'} (Age: ${p2Age.value || 'N/A'}, Club: ${p2Club.value || 'N/A'}, League: ${p2League.value || 'N/A'})`;
            
            let prompt = `You are a professional scout. Create a Head-to-Head analysis of two players.\n\n${p1Info}\n${p2Info}\n\n--- INSTRUCTIONS ---\n`;
            prompt += "Analyze all the provided data for both players. Create a detailed comparison using the following template. Use markdown headers (e.g., '## 1. Title') and '---' separators.\n\n";
            prompt += "## 1. Role & Playstyle Comparison\n(Describe and contrast their tactical roles and style of play.)\n\n---\n\n";
            prompt += "## 2. Head-to-Head: Key Strengths\n(Compare their pros in a side-by-side manner.)\n\n---\n\n";
            prompt += "## 3. Head-to-Head: Key Weaknesses\n(Compare their cons in a side-by-side manner.)\n\n---\n\n";
            prompt += "## 4. Statistical Standout\n(Which player has the more impressive statistical profile and why?)\n\n---\n\n";
            prompt += "## 5. Verdict & Recommendation\n(Conclude with a final summary of who is the better prospect or a better fit for a specific tactical system.)\n\n";
            
            prompt += "--- Player 1 Data ---\n";
            prompt += `Stats: ${textStatsCompare1.value.trim() || 'N/A'}\n\n`;
            prompt += "Player 1 Images (Heatmaps, Stats):\n";
            
            parts.push({ text: prompt });
            if (compare1Images.length === 0) parts.push({ text: "No images provided for Player 1."});
            compare1Images.forEach(img => {
                parts.push({ inlineData: { mimeType: img.mimeType, data: img.base64 } });
            });
            
            prompt = "\n--- Player 2 Data ---\n";
            prompt += `Stats: ${textStatsCompare2.value.trim() || 'N/A'}\n\n`;
            prompt += "Player 2 Images (Heatmaps, Stats):\n";
            
            parts.push({ text: prompt });
            if (compare2Images.length === 0) parts.push({ text: "No images provided for Player 2."});
            compare2Images.forEach(img => {
                parts.push({ inlineData: { mimeType: img.mimeType, data: img.base64 } });
            });

            try {
                const resultText = await callGeminiApi(parts);
                displayResults(resultText, analysisOutputCompare);
            } catch (error) {
                showError(`Comparison failed: ${error.message}`);
            } finally {
                hideLoading();
            }
        }
        
        async function analyzeOpposition() {
            showLoading(); // Show random funny message
            if(analysisOutputOpponent) analysisOutputOpponent.innerHTML = '';
            
            const parts = [];
            const oppName = opponentName.value.trim();
            const oppStats = textStatsOpponent.value.trim();
            const nameOnly = oppName && !oppStats && opponentImages.length === 0;
            
            let prompt = `You are a professional tactical analyst. Create an opposition scouting report for ${oppName || 'the opponent'}.\n\n`;
            
            if (nameOnly) {
                prompt += "--- INSTRUCTIONS ---\n";
                prompt += "You have *only* been given the opponent's name. Use Google Search to find public information about their recent tactical setup, playstyle, strengths, and weaknesses.\n";
                prompt += "Then, generate a concise tactical report using this template. Use markdown headers (e.g., '## 1. Title') and '---' separators.\n\n";
                prompt += `If you cannot find *any* useful tactical information on "${oppName}", please return *only* a funny, lighthearted message. For example: 'Sorry, boss, my scouts came up empty on ${oppName}. They must be using invisible ink for their tactics!' or 'Couldn't find any data on ${oppName}. Are we sure they're not a U-12 team?'\n\n`;
            } else {
                 prompt += "--- Provided Data ---\n";
                prompt += `Stats/Notes: ${oppStats || 'N/A'}\n\n`;
                prompt += "--- INSTRUCTIONS ---\n";
                prompt += "Analyze the provided images (formations, heatmaps) and text notes. \n";
            }
            
            prompt += "## 1. Tactical Setup & Playstyle\n(Describe their likely formation, style in possession, and defensive structure.)\n\n---\n\n";
            prompt += "## 2. Key Strengths & Threats\n(List 3-4 key tactical strengths or dangerous players.)\n\n---\n\n";
            prompt += "## 3. Key Weaknesses & Vulnerabilities\n(List 2-3 exploitable weaknesses in their system or personnel.)\n\n---\n\n";
            prompt += "## 4. Suggested Exploitation Plan\n(Provide actionable advice on how to beat this team. e.g., 'Exploit high press with balls over the top', 'Target their weak left-back in 2v1 situations'.)\n";
            
            parts.push({ text: prompt });
            
            if (!nameOnly) {
                if (opponentImages.length === 0) parts.push({ text: "No images provided."});
                opponentImages.forEach(img => {
                    parts.push({ inlineData: { mimeType: img.mimeType, data: img.base64 } });
                });
            }
            
            try {
                const resultText = await callGeminiApi(parts, nameOnly); // Use grounding if nameOnly is true
                displayResults(resultText, analysisOutputOpponent);
            } catch (error) {
                showError(`Opposition analysis failed: ${error.message}`);
            } finally {
                hideLoading();
            }
        }
        
        async function handleSearch() {
            showLoading("Searching for players...");
            if(searchError) searchError.classList.add('hidden');
            if(searchResults) searchResults.innerHTML = '<p class="text-slate-400">Searching...</p>';
            if(downloadCsvBtn) downloadCsvBtn.classList.add('hidden');
            
            const queryParts = [];
            if (searchPosition.value.trim()) queryParts.push(`Position: ${searchPosition.value.trim()}`);
            if (searchAge.value.trim()) queryParts.push(`Age: ${searchAge.value.trim()}`);
            if (searchNationality.value.trim()) queryParts.push(`Nationality/Passport: ${searchNationality.value.trim()}`);
            if (searchMarketValue.value.trim()) queryParts.push(`Market Value: ${searchMarketValue.value.trim()}`);
            if (searchContract.value.trim()) queryParts.push(`Contract Expires: ${searchContract.value.trim()}`);
            if (searchStats.value.trim()) queryParts.push(`Specific Stats: ${searchStats.value.trim()}`);
            if (searchMatches.value.trim()) queryParts.push(`Matches/Minutes: ${searchMatches.value.trim()}`);
            if (searchLeague.value.trim()) queryParts.push(`Has the potential quality or playstyle suitable for: ${searchLeague.value.trim()} (This is a scout assessment, they don't have to be playing in that league currently).`);
            if (searchClub.value.trim()) queryParts.push(`Has the potential quality or playstyle suitable for: ${searchClub.value.trim()} (This is a scout assessment of tactical fit).`);
            if (searchSimilar && searchSimilar.value.trim()) queryParts.push(`Search for players stylistically similar to: ${searchSimilar.value.trim()}`);
            
            if (queryParts.length === 0) {
                showSearchError("Please enter at least one search criterion.");
                return;
            }
            
            const fullQuery = `
Based on publicly available data and tactical analysis from Google Search, find up to 25 football players who match the following criteria:
- ${queryParts.join('\n- ')}

One key criterion is "Suitable for League/Club." This means you should assess if the player's *potential* and *playstyle* match that league/club, not just if they *currently* play in it.

For each player, find their latest news headline (e.g., transfer rumors, injury update, recent performance).

Format the result as a simple HTML table (no classes) with columns: 
Name, Age, Club, Nationality, Position, Market Value (Est.), Contract Expires, Latest News (1 Headline)

If a value is unknown, use "N/A".
Do not include any text before or after the HTML table.
`;
            
            if(searchButton) searchButton.disabled = true;
            try {
                const resultHtml = await callGeminiApi([{ text: fullQuery }], true); // Use grounding
                
                // Style the HTML table with Tailwind
                let styledHtml = resultHtml
                    .replace(/<table>/g, '<table class="w-full text-left border-collapse">')
                    .replace(/<thead>/g, '<thead class="bg-slate-700">')
                    .replace(/<th>/g, '<th class="p-3 border-b border-slate-600 text-sm font-semibold text-white">')
                    .replace(/<tbody>/g, '<tbody class="divide-y divide-slate-700">')
                    .replace(/<tr>/g, '<tr class="hover:bg-slate-800">')
                    .replace(/<td>/g, '<td class="p-3 border-b border-slate-700 text-sm">');
                
                if(searchResults) searchResults.innerHTML = styledHtml;
                
                // Prepare CSV content
                csvContent = "Name,Age,Club,Nationality,Position,Market Value (Est.),Contract Expires,Latest News\n";
                const table = new DOMParser().parseFromString(resultHtml, 'text/html').querySelector('table');
                if (table) {
                    table.querySelectorAll('tbody tr').forEach(row => {
                        const rowData = [];
                        row.querySelectorAll('td').forEach(cell => {
                            rowData.push(`"${cell.textContent.trim().replace(/"/g, '""')}"`);
                        });
                        csvContent += rowData.join(',') + '\n';
                    });
                    if(downloadCsvBtn) downloadCsvBtn.classList.remove('hidden');
                }

            } catch (error) {
                showSearchError(`Search failed: ${error.message}`);
            } finally {
                hideLoading();
                if(searchButton) searchButton.disabled = false;
            }
        }

        async function suggestStats() {
            const position = searchPosition.value.trim();
            if (!position) {
                showError("Please enter a position first to get stat suggestions.");
                return;
            }

            showLoading("Suggesting stats...");
            if(suggestStatsBtn) suggestStatsBtn.disabled = true;

            const prompt = `You are a professional football scout. Based on the position(s) "${position}", suggest 5-7 key statistics (both basic and advanced) a scout should look for.
            Format the answer as a simple, comma-separated list.
            Example: Goals, Assists, Pass Accuracy, Progressive Passes, Tackles Won
            
            Do not add any other text, just the comma-separated list.`;

            try {
                const statsList = await callGeminiApi([{ text: prompt }], false); // No grounding needed
                
                if (searchStats.value.trim().length > 0 && !searchStats.value.endsWith(',')) {
                    searchStats.value += ', ';
                }
                searchStats.value += statsList.trim();
                
            } catch (error) {
                showError(`Failed to suggest stats: ${error.message}`);
            } finally {
                hideLoading();
                if(suggestStatsBtn) suggestStatsBtn.disabled = false;
            }
        }
        
        function showSearchError(message) {
            if(searchError) {
                searchError.textContent = message;
                searchError.classList.remove('hidden');
            }
            if(searchResults) searchResults.innerHTML = '<p class="text-slate-400">Search failed. Please try again.</p>';
            hideLoading();
        }
        
        function downloadCSV() {
            if (!csvContent) return;
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'player_search_results.csv';
            link.click();
            URL.revokeObjectURL(link.href);
        }

        async function handleChat() {
            const userText = chatInput.value.trim();
            if (!userText) return;

            // Add user message to UI
            addChatMessage('User', userText);
            chatInput.value = '';
            chatInput.disabled = true;
            chatSendBtn.disabled = true;

            // Add user message to history
            chatHistory.push({ role: 'user', parts: [{ text: userText }] });

            // Add loading indicator
            const loadingEl = addChatMessage('Scout AI', '...');

            try {
                const resultText = await callChatbotApi();
                
                // Add model message to history
                chatHistory.push({ role: 'model', parts: [{ text: resultText }] });

                // Update loading message with real response
                if(loadingEl) loadingEl.querySelector('.chat-content').innerHTML = formatChatText(resultText);

            } catch (error) {
                if(loadingEl) loadingEl.querySelector('.chat-content').innerHTML = `<p class="text-red-400">Error: ${error.message}</p>`;
            } finally {
                chatInput.disabled = false;
                chatSendBtn.disabled = false;
                chatInput.focus();
                chatWindow.scrollTop = chatWindow.scrollHeight;
            }
        }

        async function callChatbotApi() {
            const payload = {
                contents: chatHistory, // Send the whole history
                tools: [{ "google_search": {} }], // Use grounding
                systemInstruction: {
                    parts: [{ text: "You are a professional football scout and tactical analyst. Answer the user's questions with this persona. Use Google Search to find up-to-date information. Format your answers clearly with headings, lists, and bold text." }]
                }
            };

            let result;
            try {
                result = await invokeGemini(payload);
            } catch (error) {
                console.error('Chatbot request failed:', error);
                throw new Error(error.message || 'Failed to contact the AI service.');
            }

            if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts) {
                return result.candidates[0].content.parts[0].text;
            } else if (result.candidates && result.candidates[0].finishReason === "SAFETY") {
                throw new Error("Response blocked by safety settings.");
            } else {
                console.warn("Unexpected API response structure:", result);
                throw new Error("Could not parse the AI's response.");
            }
        }

        function addChatMessage(sender, text) {
            const senderClass = sender === 'User' ? 'bg-slate-800 self-end' : 'bg-slate-700 self-start';
            const senderNameClass = sender === 'User' ? 'text-teal-300' : 'text-sky-300';

            const messageEl = document.createElement('div');
            messageEl.classList.add('p-3', 'rounded-lg', 'max-w-3/4', 'w-fit', ...senderClass.split(' '));
            messageEl.innerHTML = `
                <p class="font-semibold ${senderNameClass} mb-1">${sender}</p>
                <div class="chat-content prose prose-sm prose-invert max-w-none">${formatChatText(text)}</div>
            `;
            if(chatWindow) {
                chatWindow.appendChild(messageEl);
                chatWindow.scrollTop = chatWindow.scrollHeight;
            }
            return messageEl;
        }

        function formatChatText(text) {
             // Basic markdown-to-HTML
            return text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') // Bold
                .replace(/\*(.*?)\*/g, '<em>$1</em>') // Italics
                .replace(/^# (.*)/gm, '<h3 class="text-xl font-semibold text-white mt-3 mb-2">$1</h3>') // H1 -> H3
                .replace(/^## (.*)/gm, '<h4 class="text-lg font-semibold text-white mt-3 mb-2">$1</h4>') // H2 -> H4
                .replace(/^### (.*)/gm, '<h5 class="text-md font-semibold text-white mt-3 mb-2">$1</h5>') // H3 -> H5
                .replace(/^- (.*)/gm, '<li class="ml-4">$1</li>') // List items
                .replace(/(<li>.*<\/li>)/gs, '<ul>$1</ul>') // Wrap lists
                .replace(/\n/g, '<br>'); // Newlines
        }

        function newChat() {
            chatHistory = [];
            if(chatWindow) chatWindow.innerHTML = '';
            addChatMessage('Scout AI', 'Hi! Ask me anything, like "What is the tactical style of Brighton?" or "Summarize Lamine Yamal\'s stats this season."');
        }


        // --- Output Formatting ---
        function displayResults(text, element) {
            if (!element) return;

            const rawText = text;
            let processedText = rawText;

            // Handle markdown tables
            processedText = processedText.replace(/\|(.*?)\|/g, (match, content) => `|${content.trim()}|`); // Trim whitespace inside cells
            processedText = processedText.replace(/(\|(?:[^\r\n\|]+\|)+)\r?\n\|(?: *\:?\-+\:? *\|)+/g, (match, headerRow) => {
                let header = `<thead><tr class="bg-slate-700">`;
                headerRow.split('|').filter(Boolean).forEach(h => {
                    header += `<th class="p-2 border border-slate-600">${h.trim()}</th>`;
                });
                header += `</tr></thead>`;
                return header;
            });
            processedText = processedText.replace(/^\|(.*?)\|$/gm, (match, rowContent) => {
                let row = `<tr>`;
                rowContent.split('|').filter(Boolean).forEach(cell => {
                    row += `<td class="p-2 border border-slate-600">${cell.trim()}</td>`;
                });
                row += `</tr>`;
                return row;
            });
            processedText = processedText.replace(/(<thead>(?:.|\n)*?<\/thead>)((?:<tr>(?:.|\n)*?<\/tr>)+)/g, '<table class="w-full text-left border-collapse border border-slate-600 my-4">$1<tbody>$2</tbody></table>');


            let html = processedText
                .replace(/^#+ 1\. (.*)/gm, '<h3 class="text-xl font-semibold text-sky-300 mt-4 mb-2">$1</h3>')
                .replace(/^#+ 2\. (.*)/gm, '<h3 class="text-xl font-semibold text-sky-300 mt-4 mb-2">$1</h3>')
                .replace(/^#+ 3\. (.*)/gm, '<h3 class="text-xl font-semibold text-sky-300 mt-4 mb-2">$1</h3>')
                .replace(/^#+ 4\. (.*)/gm, '<h3 class="text-xl font-semibold text-sky-300 mt-4 mb-2">$1</h3>')
                .replace(/^#+ 5\. (.*)/gm, '<h3 class="text-xl font-semibold text-sky-300 mt-4 mb-2">$1</h3>')
                .replace(/^#+ 6\. (.*)/gm, '<h3 class="text-xl font-semibold text-sky-300 mt-4 mb-2">$1</h3>')
                .replace(/^#+ 7\. (.*)/gm, '<h3 class="text-xl font-semibold text-sky-300 mt-4 mb-2">$1</h3>')
                .replace(/^#+ 8\. (.*)/gm, '<h3 class="text-xl font-semibold text-sky-300 mt-4 mb-2">$1</h3>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/^- (.*)/gm, '<li class="ml-4">$1</li>')
                .replace(/^(?!<h3|<li|<table|<thead|<tbody|<tr)(.*)/gm, '<p>$1</p>') // Wrap non-header/list/table lines in <p>
                .replace(/<p><\/p>/g, '') // Remove empty paragraphs
                .replace(/<\/li><p>/g, '</li>') // Fix spacing
                .replace(/<\/p><p>/g, '</p><p class="mt-2">')
                .replace(/---/g, '<hr class="border-slate-700 my-4">'); // Add horizontal rules

            element.dataset.rawMarkdown = rawText;

            if (element.id === 'analysisOutput') {
                prepareAnalysisViews(html, rawText);
            } else {
                element.innerHTML = html;
            }
        }

        function copyToClipboard() {
            if (!analysisOutput) return;
            const reportText = currentAnalysisView === 'data' && analysisDataView
                ? analysisDataView.innerText
                : analysisOutput.innerText;
            navigator.clipboard.writeText(reportText).then(() => {
                copyBtn.innerHTML = '<i data-lucide="check" class="h-5 w-5 mr-2"></i>Copied!';
                if (typeof lucide !== 'undefined') lucide.createIcons();
                setTimeout(() => {
                    copyBtn.innerHTML = '<i data-lucide="clipboard" class="h-5 w-5 mr-2"></i>Copy';
                    if (typeof lucide !== 'undefined') lucide.createIcons();
                }, 2000);
            }).catch(err => {
                showError('Failed to copy to clipboard.');
            });
        }
        
        function findVideos() {
            const name = playerName.value.trim();
            if (!name) {
                showError("Please enter a player's name first.");
                return;
            }
            // Switch to chatbot tab
            showTab('chatbot');
            // Auto-fill and send query
            const query = `Find recent match highlights and performance videos for ${name}`;
            chatInput.value = query;
            handleChat();
        }

        // --- Stats Visualization ---
        function visualizeStats() {
            if (!textStatsSingle) return;
            const text = textStatsSingle.value;
            const lines = text.split('\n');
            const data = {
                labels: [],
                values: []
            };

            const regex = /([\w\s\/]+):\s*([\d\.]+)[\/\s]*([\d\.]+)?/;

            lines.forEach(line => {
                const match = line.match(regex);
                if (match) {
                    const label = match[1].trim();
                    const value1 = parseFloat(match[2]);
                    const value2 = parseFloat(match[3]);

                    if (!isNaN(value2)) {
                        // Handle fractional stats like "Tackles: 3/4"
                        data.labels.push(`${label} (Success)`);
                        data.values.push(value1);
                        data.labels.push(`${label} (Failed)`);
                        data.values.push(value2 - value1);
                    } else if (!isNaN(value1)) {
                        // Handle simple stats like "Goals: 1"
                        data.labels.push(label);
                        data.values.push(value1);
                    }
                }
            });

            if (data.labels.length === 0) {
                showError("Could not find any stats to visualize. Make sure they are in 'Stat: Value' format (e.g., 'Goals: 1' or 'Tackles: 3/4').");
                return;
            }

            if (statsChart) {
                statsChart.destroy();
            }

            if (typeof Chart === 'undefined') {
                showError("Chart.js library is not loaded.");
                return;
            }

            statsChart = new Chart(statsChartCanvas, {
                type: 'bar',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: 'Stats',
                        data: data.values,
                        backgroundColor: 'rgba(56, 189, 248, 0.6)', // sky-400
                        borderColor: 'rgba(56, 189, 248, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y', // Horizontal bar chart
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: 'Stats Visualization',
                            color: '#e2e8f0' // slate-200
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#94a3b8' }, // slate-400
                            grid: { color: '#334155' } // slate-700
                        },
                        y: {
                            ticks: { color: '#94a3b8' }, // slate-400
                            grid: { display: false }
                        }
                    }
                }
            });
        }
        
        // --- PDF Generation ---
        
        function escapeHtml(str = '') {
            return str
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function convertInlineMarkdown(text = '') {
            return escapeHtml(text)
                .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                .replace(/_(.+?)_/g, '<em>$1</em>');
        }

        function buildPdfTableHtml(lines) {
            if (!lines.length) return '';
            const headerCells = lines[0].split('|').filter(Boolean).map(cell => convertInlineMarkdown(cell.trim()));
            const bodyRows = [];
            for (let i = 1; i < lines.length; i++) {
                const row = lines[i].trim();
                if (!row.startsWith('|')) break;
                if (/^\|\s*:?-+\s*:?(\|\s*:?-+\s*:?)*\|?$/.test(row)) continue;
                const cells = row.split('|').filter(Boolean).map(cell => convertInlineMarkdown(cell.trim()));
                if (cells.length) bodyRows.push(`<tr>${cells.map(cell => `<td>${cell}</td>`).join('')}</tr>`);
            }
            if (!bodyRows.length) return '';
            const headerHtml = `<thead><tr>${headerCells.map(cell => `<th>${cell}</th>`).join('')}</tr></thead>`;
            return `<table>${headerHtml}<tbody>${bodyRows.join('')}</tbody></table>`;
        }

        function formatMarkdownForPdf(markdown = '') {
            if (!markdown.trim()) return '<p class="pdf-empty">N/A</p>';
            const lines = markdown.replace(/\r\n?/g, '\n').split('\n');
            const htmlParts = [];
            let buffer = [];

            const flushParagraph = () => {
                if (!buffer.length) return;
                htmlParts.push(`<p>${convertInlineMarkdown(buffer.join(' ').trim())}</p>`);
                buffer = [];
            };

            for (let i = 0; i < lines.length; i++) {
                const raw = lines[i].trim();
                if (!raw) {
                    flushParagraph();
                    continue;
                }

                if (raw === '---') {
                    flushParagraph();
                    htmlParts.push('<div class="pdf-divider"></div>');
                    continue;
                }

                if (raw.startsWith('|')) {
                    flushParagraph();
                    const tableLines = [];
                    while (i < lines.length && lines[i].trim().startsWith('|')) {
                        tableLines.push(lines[i].trim());
                        i++;
                    }
                    i--;
                    const tableHtml = buildPdfTableHtml(tableLines);
                    if (tableHtml) htmlParts.push(tableHtml);
                    continue;
                }

                if (raw.startsWith('- ')) {
                    flushParagraph();
                    const listItems = [];
                    while (i < lines.length && lines[i].trim().startsWith('- ')) {
                        listItems.push(`<li>${convertInlineMarkdown(lines[i].trim().slice(2))}</li>`);
                        i++;
                    }
                    i--;
                    if (listItems.length) htmlParts.push(`<ul>${listItems.join('')}</ul>`);
                    continue;
                }

                buffer.push(raw);
            }

            flushParagraph();
            return htmlParts.join('');
        }

        function extractCategoryGrades(markdown = '') {
            const rows = [];
            const lines = markdown.split('\n');
            let capture = false;
            for (const line of lines) {
                const trimmed = line.trim();
                if (!capture && /\|\s*Category\s*\|\s*Grade\s*\|\s*Comment\s*\|/i.test(trimmed)) {
                    capture = true;
                    continue;
                }
                if (capture) {
                    if (!trimmed.startsWith('|') || !trimmed.includes('|')) {
                        capture = false;
                        continue;
                    }
                    if (/^\|\s*:?-+\s*:?(\|\s*:?-+\s*:?)*\|?$/.test(trimmed)) {
                        continue;
                    }
                    const cells = trimmed.split('|').map(cell => cell.trim()).filter(Boolean);
                    if (cells.length >= 3) {
                        rows.push({
                            category: cells[0],
                            grade: cells[1],
                            comment: cells.slice(2).join(' | ')
                        });
                    }
                }
            }
            return rows;
        }

        function gradeToScore(grade = '') {
            const scale = {
                'A+': 100, 'A': 95, 'A-': 90,
                'B+': 85, 'B': 80, 'B-': 75,
                'C+': 70, 'C': 65, 'C-': 60,
                'D+': 55, 'D': 50, 'D-': 45,
                'E': 40, 'F': 30
            };
            const cleaned = grade.trim().toUpperCase();
            if (scale[cleaned] !== undefined) return scale[cleaned];
            const numeric = parseFloat(cleaned);
            if (!Number.isNaN(numeric)) {
                return Math.max(0, Math.min(100, (numeric / 10) * 100));
            }
            return 60;
        }

        function parseKeyAttributes(statsText = '', ratingSection = '') {
            const base = [
                { icon: 'â½', label: 'Goals', value: 'â' },
                { icon: 'ð¯', label: 'Assists', value: 'â' },
                { icon: 'ð¡ï¸', label: 'Tackles', value: 'â' },
                { icon: 'ð', label: 'Rating', value: 'â' }
            ];

            const extractValue = (text, keywords) => {
                const pattern = new RegExp(`(?:${keywords.join('|')})\\s*[:\u2013\-]?\\s*(\\d+(?:\\.\\d+)?)\\s*(?:/\\s*(\\d+(?:\\.\\d+)?))?`, 'i');
                const match = text.match(pattern);
                if (!match) return null;
                if (match[2]) {
                    return `${match[1]} / ${match[2]}`;
                }
                return match[1];
            };

            const normalizedStats = statsText.replace(/,/g, '\n');
            const goals = extractValue(normalizedStats, ['goals?', 'scored']);
            const assists = extractValue(normalizedStats, ['assists?', 'created']);
            const tackles = extractValue(normalizedStats, ['tackles?', 'duels']);
            const ratingMatch = ratingSection.match(/([A-F][+\-]?|\d+(?:\.\d+)?\s*\/\s*10|\d+(?:\.\d+)?)/);

            if (goals) base[0].value = goals;
            if (assists) base[1].value = assists;
            if (tackles) base[2].value = tackles;
            if (ratingMatch) base[3].value = ratingMatch[0].replace(/\s+/g, '');

            return base;
        }

        async function generatePDF() {
            if (typeof window.jspdf === 'undefined') {
                showError("jsPDF library is not loaded.");
                return;
            }
            if (typeof html2canvas === 'undefined') {
                showError("html2canvas library is not loaded.");
                return;
            }
            if (!pdfContent) {
                showError("PDF export container is missing. Please refresh and try again.");
                return;
            }

            const { jsPDF } = window.jspdf;
            showLoading("Generating PDF preview...", 'download');

            let wasHidden = false;
            let previousInlineStyles = null;

            try {
                const rawReportText = analysisOutput?.dataset?.rawMarkdown || '';

                if (!rawReportText.trim()) {
                    showError("Error generating PDF preview: No scouting report available to export. Please run an analysis first.");
                    return;
                }

                const isProReport = reportType.value === 'pro';
                const reportData = isProReport ? parseProReport(rawReportText) : parseQuickReport(rawReportText);

                if (!reportData) {
                    const errorCopy = isProReport
                        ? "Error generating PDF preview: Could not parse Pro Scout Report. AI response was incomplete. Please try again."
                        : "Error generating PDF preview: Could not parse Quick Report. AI response was incomplete. Please try again.";
                    showError(errorCopy);
                    return;
                }

                const categories = extractCategoryGrades(rawReportText);
                let developmentPlanContent = reportData.development;
                if ((!developmentPlanContent || developmentPlanContent === 'N/A') && categories.length) {
                    const improvementAreas = categories
                        .map(category => ({
                            ...category,
                            score: gradeToScore(category.grade)
                        }))
                        .filter(category => category.score < 85)
                        .slice(0, 3)
                        .map(category => {
                            const focus = category.comment && category.comment !== 'N/A'
                                ? category.comment
                                : `Elevate ${category.category.toLowerCase()} to lift the current ${category.grade || 'score'}.`;
                            return `- ${category.category}: ${focus}`;
                        });
                    if (improvementAreas.length) {
                        developmentPlanContent = `Focus on the following development priorities:\n\n${improvementAreas.join('\n')}`;
                    }
                }

                const hasDevelopmentPlan = Boolean(developmentPlanContent && developmentPlanContent.trim() !== '' && developmentPlanContent !== 'N/A');

                const attributes = parseKeyAttributes(textStatsSingle?.value || '', reportData.rating || rawReportText);
                const statsChartImage = statsChart ? statsChart.toBase64Image() : '';
                const galleryImages = singlePlayerImages.slice(0, 3).map((img, index) => {
                    const src = img.preview || `data:${img.mimeType};base64,${img.base64}`;
                    return `<figure class="pdf-visual"><img src="${src}" alt="Analysis visual ${index + 1}"><figcaption>Visual ${index + 1}</figcaption></figure>`;
                }).join('');

                const sections = isProReport ? [
                    { title: 'AI Performance Rating', content: reportData.rating, accent: '#38bdf8' },
                    { title: 'Summary', content: reportData.summary, accent: '#0ea5e9' },
                    { title: 'Positional Play', content: reportData.positional, accent: '#6366f1' },
                    { title: 'Key Actions (PMDS)', content: reportData.actions, accent: '#8b5cf6' },
                    { title: 'Tactical Awareness (Four Phases)', content: reportData.tactical, accent: '#14b8a6' },
                    { title: 'Mentality', content: reportData.mentality, accent: '#f97316' },
                    ...(hasDevelopmentPlan ? [{ title: 'Suggested Development Plan', content: developmentPlanContent, accent: '#38bdf8' }] : []),
                    { title: 'Conclusion & Recommendation', content: reportData.conclusion, accent: '#38bdf8' },
                    { title: 'Similar Player Matrix', content: reportData.similar, accent: '#22d3ee' }
                ] : [
                    { title: 'AI Performance Rating', content: reportData.rating, accent: '#38bdf8' },
                    { title: 'Likely Position(s) & Role', content: reportData.position, accent: '#6366f1' },
                    { title: 'Key Duties & Playstyle', content: reportData.playstyle, accent: '#14b8a6' },
                    { title: 'Key Strengths (Pros)', content: reportData.pros, accent: '#0ea5e9' },
                    { title: 'Key Weaknesses (Cons)', content: reportData.cons, accent: '#ef4444' },
                    { title: 'Suggested Similar Player', content: reportData.similar, accent: '#f59e0b' },
                    { title: 'Suggested Development Plan', content: hasDevelopmentPlan ? developmentPlanContent : 'No development plan was generated. Translate the identified weaknesses into 2-3 actionable steps before sharing.', accent: '#38bdf8' }
                ];

                const sectionsHtml = sections.map(section => {
                    const isDevelopmentPlan = section.title.toLowerCase().includes('development plan');
                    return `
                    <section class="pdf-section${isDevelopmentPlan ? ' pdf-section--plan' : ''}" style="--accent:${section.accent}">
                        <h3>${escapeHtml(section.title)}</h3>
                        <div class="pdf-section-body">${formatMarkdownForPdf(section.content)}</div>
                    </section>
                `;
                }).join('');

                const performanceHtml = categories.length ? categories.map(category => {
                    const score = gradeToScore(category.grade);
                    return `
                        <div class="performance-row">
                            <div class="performance-label">${escapeHtml(category.category)}</div>
                            <div class="performance-bar">
                                <div class="performance-fill" style="width:${score}%"></div>
                            </div>
                            <div class="performance-grade">${escapeHtml(category.grade || 'â')}</div>
                        </div>
                        <p class="performance-comment">${escapeHtml(category.comment || '')}</p>
                    `;
                }).join('') : '<p class="pdf-empty">No category grades supplied.</p>';

                const attributesHtml = attributes.map(attr => `
                    <div class="attribute-chip">
                        <span class="attribute-icon">${attr.icon}</span>
                        <div class="attribute-text">
                            <span class="attribute-label">${escapeHtml(attr.label)}</span>
                            <span class="attribute-value">${escapeHtml(attr.value)}</span>
                        </div>
                    </div>
                `).join('');

                const heroImage = singlePlayerImages[0] ? (singlePlayerImages[0].preview || `data:${singlePlayerImages[0].mimeType};base64,${singlePlayerImages[0].base64}`) : '';

                const pdfHtml = `
                    <style>
                        * { box-sizing: border-box; }
                        .pdf-wrapper { width: 100%; background: #f8fafc; padding: 32px; font-family: 'Inter', 'Poppins', sans-serif; color: #0f172a; }
                        .pdf-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
                        .pdf-brand { font-size: 14px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.25em; color: #38bdf8; }
                        .pdf-title { font-family: 'Poppins', sans-serif; font-size: 26px; font-weight: 600; color: #0b1120; margin: 0; }
                        .pdf-meta { font-size: 12px; color: #334155; margin-top: 6px; }
                        .pdf-columns { display: flex; flex-direction: column; gap: 20px; }
                        .pdf-left { width: 100%; display: flex; flex-direction: column; gap: 16px; }
                        .pdf-right { width: 100%; display: flex; flex-direction: column; gap: 16px; }
                        .pdf-card { background: #ffffff; border-radius: 18px; padding: 18px; border: 1px solid rgba(15, 23, 42, 0.08); box-shadow: 0 18px 38px rgba(15, 23, 42, 0.08); }
                        .pdf-card, .pdf-section { break-inside: avoid; page-break-inside: avoid; -webkit-column-break-inside: avoid; }
                        .player-hero { width: 100%; border-radius: 14px; aspect-ratio: 4/3; object-fit: cover; border: 1px solid rgba(148, 163, 184, 0.25); }
                        .player-hero--placeholder { display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, rgba(148, 163, 184, 0.15), rgba(148, 163, 184, 0.05)); color: #475569; font-weight: 500; }
                        .player-info { display: grid; gap: 4px; font-size: 12px; margin-top: 12px; }
                        .player-info span { display: block; }
                        .attribute-board { display: grid; gap: 10px; }
                        .attribute-chip { display: flex; gap: 12px; align-items: center; background: rgba(56, 189, 248, 0.08); border-radius: 14px; padding: 10px 12px; border: 1px solid rgba(14, 165, 233, 0.15); }
                        .attribute-icon { font-size: 18px; }
                        .attribute-label { font-size: 11px; text-transform: uppercase; letter-spacing: 0.18em; color: #475569; }
                        .attribute-value { font-size: 14px; font-weight: 600; color: #0b1120; }
                        .performance-board { display: flex; flex-direction: column; gap: 12px; }
                        .performance-row { display: grid; grid-template-columns: 1fr 2fr auto; gap: 10px; align-items: center; }
                        .performance-label { font-size: 12px; font-weight: 600; color: #0b1120; }
                        .performance-bar { height: 8px; background: rgba(148, 163, 184, 0.25); border-radius: 999px; overflow: hidden; }
                        .performance-fill { height: 100%; background: linear-gradient(90deg, #22d3ee, #0ea5e9); }
                        .performance-grade { font-size: 12px; font-weight: 600; color: #0b1120; }
                        .performance-comment { font-size: 11px; color: #475569; margin: 0 0 6px 0; }
                        .pdf-visuals { display: flex; flex-direction: column; gap: 12px; }
                        .pdf-visuals img { width: 100%; border-radius: 14px; border: 1px solid rgba(148, 163, 184, 0.25); }
                        .pdf-visuals figure { margin: 0; }
                        .pdf-visuals figcaption { margin-top: 4px; font-size: 11px; color: #475569; text-align: center; }
                        .pdf-section { position: relative; padding: 20px 24px; border-radius: 18px; background: #ffffff; border: 1px solid rgba(15, 23, 42, 0.08); box-shadow: 0 18px 38px rgba(15, 23, 42, 0.08); }
                        .pdf-section--plan { background: #0ea5e9; color: #0f172a; border-color: rgba(14, 165, 233, 0.35); box-shadow: 0 20px 44px rgba(14, 165, 233, 0.25); }
                        .pdf-section--plan::before { background: rgba(15, 23, 42, 0.2); }
                        .pdf-section--plan h3 { color: #0f172a; }
                        .pdf-section--plan .pdf-section-body p,
                        .pdf-section--plan .pdf-section-body li,
                        .pdf-section--plan .pdf-section-body ul,
                        .pdf-section--plan .pdf-section-body strong,
                        .pdf-section--plan .pdf-section-body a { color: #0f172a; }
                        .pdf-section::before { content: ''; position: absolute; top: 0; left: 0; width: 8px; height: 100%; border-radius: 18px 0 0 18px; background: var(--accent, #38bdf8); }
                        .pdf-section h3 { margin: 0 0 12px 0; font-size: 16px; font-family: 'Poppins', sans-serif; font-weight: 600; color: #0b1120; }
                        .pdf-section-body p { margin: 0 0 8px 0; font-size: 12px; line-height: 1.5; color: #1e293b; }
                        .pdf-section-body ul { margin: 0 0 10px 18px; padding: 0; color: #1e293b; font-size: 12px; }
                        .pdf-section-body li { margin-bottom: 4px; }
                        .pdf-section-body table { width: 100%; border-collapse: collapse; margin-bottom: 12px; font-size: 12px; }
                        .pdf-section-body thead th { background: rgba(14, 165, 233, 0.12); color: #0b1120; text-transform: uppercase; font-size: 11px; padding: 8px; }
                        .pdf-section-body td { border: 1px solid rgba(148, 163, 184, 0.4); padding: 8px; color: #1e293b; }
                        .pdf-section-body hr, .pdf-divider { border: none; height: 1px; background: rgba(148, 163, 184, 0.4); margin: 12px 0; }
                        .pdf-empty { font-size: 12px; color: #94a3b8; margin: 0; }
                    </style>
                    <div class="pdf-wrapper">
                        <div class="pdf-header">
                            <div>
                                <div class="pdf-brand">Pro Scout AI</div>
                                <h1 class="pdf-title">${escapeHtml(playerName?.value || 'Unnamed Player')}</h1>
                                <div class="pdf-meta">Age ${escapeHtml(playerAge?.value || 'N/A')} â¢ ${escapeHtml(playerClub?.value || 'Club N/A')} â¢ ${escapeHtml(playerLeague?.value || 'League N/A')}</div>
                            </div>
                            <div class="pdf-meta">
                                ${escapeHtml(new Date().toLocaleString())}
                            </div>
                        </div>
                        <div class="pdf-columns">
                            <aside class="pdf-left">
                                <div class="pdf-card">
                                    ${heroImage ? `<img src="${heroImage}" alt="Player visual" class="player-hero">` : `<div class="player-hero player-hero--placeholder">Add visuals for richer exports</div>`}
                                    <div class="player-info">
                                        <span><strong>Positions:</strong> ${escapeHtml(playerPositions?.value || 'N/A')}</span>
                                        <span><strong>Match Context:</strong> ${escapeHtml(matchContext?.value || 'N/A')}</span>
                                        <span><strong>Report Type:</strong> ${reportType?.value === 'pro' ? 'Pro Scout' : 'Quick Report'}</span>
                                    </div>
                                </div>
                                <div class="pdf-card attribute-board">
                                    ${attributesHtml}
                                </div>
                                <div class="pdf-card">
                                    <h3 style="font-size:14px;font-family:'Poppins',sans-serif;margin-top:0;margin-bottom:12px;color:#0b1120;">Performance Profile</h3>
                                    <div class="performance-board">${performanceHtml}</div>
                                </div>
                                <div class="pdf-card pdf-visuals">
                                    ${statsChartImage ? `<figure><img src="${statsChartImage}" alt="Stats visualization"><figcaption>Stats Breakdown</figcaption></figure>` : ''}
                                    ${galleryImages || '<p class="pdf-empty">Upload heatmaps or stat boards to showcase visuals.</p>'}
                                </div>
                            </aside>
                            <section class="pdf-right">
                                ${sectionsHtml}
                            </section>
                        </div>
                    </div>
                `;

                wasHidden = pdfContent.classList.contains('hidden');
                const styleRef = pdfContent.style;
                previousInlineStyles = {
                    position: styleRef.position,
                    left: styleRef.left,
                    top: styleRef.top,
                    width: styleRef.width,
                    maxWidth: styleRef.maxWidth,
                    visibility: styleRef.visibility,
                    pointerEvents: styleRef.pointerEvents,
                    zIndex: styleRef.zIndex,
                    display: styleRef.display,
                    opacity: styleRef.opacity
                };

                if (wasHidden) {
                    pdfContent.classList.remove('hidden');
                }

                Object.assign(styleRef, {
                    position: 'fixed',
                    top: '0',
                    left: '-10000px',
                    width: '794px',
                    maxWidth: '794px',
                    display: 'block',
                    visibility: 'visible',
                    opacity: '1',
                    pointerEvents: 'none',
                    zIndex: '-1'
                });

                pdfContent.innerHTML = pdfHtml;
                await new Promise(resolve => setTimeout(resolve, 50));

                const canvas = await html2canvas(pdfContent, {
                    scale: 2,
                    useCORS: true,
                    allowTaint: true,
                    backgroundColor: '#f8fafc'
                });
                const imgData = canvas.toDataURL('image/jpeg', 0.95);

                const pdf = new jsPDF('p', 'mm', 'a4');
                const pageWidth = pdf.internal.pageSize.getWidth();
                const pageHeight = pdf.internal.pageSize.getHeight();
                const margin = 10;
                const usablePageWidth = Math.max(pageWidth - margin * 2, pageWidth * 0.8);
                const usablePageHeight = Math.max(pageHeight - margin * 2, pageHeight * 0.8);
                const imgWidth = usablePageWidth;
                const imgHeight = canvas.height * imgWidth / canvas.width;
                let heightLeft = imgHeight;
                let pageIndex = 0;

                pdf.addImage(imgData, 'JPEG', margin, margin, imgWidth, imgHeight);
                heightLeft -= usablePageHeight;
                pageIndex++;

                while (heightLeft > 0) {
                    const position = margin - pageIndex * usablePageHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'JPEG', margin, position, imgWidth, imgHeight);
                    heightLeft -= usablePageHeight;
                    pageIndex++;
                }

                const pdfBlob = pdf.output('blob');
                generatedPdfBlobUrl = URL.createObjectURL(pdfBlob);
                pdfPreviewFrame.src = generatedPdfBlobUrl;

                showPdfPreview();

            } catch (e) {
                console.error("PDF Generation Failed:", e);
                showError(`Error generating PDF: ${e.message}`);
            } finally {
                if (previousInlineStyles) {
                    Object.assign(pdfContent.style, {
                        position: previousInlineStyles.position,
                        left: previousInlineStyles.left,
                        top: previousInlineStyles.top,
                        width: previousInlineStyles.width,
                        maxWidth: previousInlineStyles.maxWidth,
                        visibility: previousInlineStyles.visibility,
                        pointerEvents: previousInlineStyles.pointerEvents,
                    zIndex: previousInlineStyles.zIndex,
                    display: previousInlineStyles.display,
                    opacity: previousInlineStyles.opacity
                });
                }
                if (wasHidden) {
                    pdfContent.classList.add('hidden');
                }
                pdfContent.innerHTML = '';
                hideLoading();
            }
        }

        function parseProReport(text) {
            try {
                if (!text) return null;

                const normalized = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n');

                const getSection = (regex) => {
                    const match = normalized.match(regex);
                    return match?.[1]?.trim() ?? 'N/A';
                };

                const report = {
                    rating: getSection(/#+\s*1\. AI-Calculated Performance Rating[\s\S]*?\n+([\s\S]*?)(?=\n#+\s*2\.|\n---\n|\n$)/),
                    summary: getSection(/#+\s*2\. Summary[\s\S]*?\n+([\s\S]*?)(?=\n#+\s*3\.|\n---\n|\n$)/),
                    positional: getSection(/#+\s*3\. Positional Play[\s\S]*?\n+([\s\S]*?)(?=\n#+\s*4\.|\n---\n|\n$)/),
                    actions: getSection(/#+\s*4\. Key Actions[\s\S]*?\n+([\s\S]*?)(?=\n#+\s*5\.|\n---\n|\n$)/),
                    tactical: getSection(/#+\s*5\. Tactical Awareness[\s\S]*?\n+([\s\S]*?)(?=\n#+\s*6\.|\n---\n|\n$)/),
                    mentality: getSection(/#+\s*6\. Mentality[\s\S]*?\n+([\s\S]*?)(?=\n#+\s*7\.|\n---\n|\n$)/),
                    development: getSection(/#+\s*(?:\d+\.\s*)?Suggested Development Plan[\s\S]*?\n+([\s\S]*?)(?=\n#+\s*\d+\.|\n---|\n$)/),
                    conclusion: getSection(/#+\s*7\. Conclusion & Recommendation[\s\S]*?\n+([\s\S]*?)(?=\n#+\s*8\.|\n---\n|\n$)/),
                    similar: getSection(/#+\s*8\. Similar Player Matrix[\s\S]*?\n+([\s\S]*?)(?=\n---|\n$)/)
                };

                if (Object.values(report).every(val => val === 'N/A')) {
                    throw new Error("All sections parsed as N/A.");
                }

                return report;
            } catch (e) {
                console.error("Failed to parse pro report:", e.message, "\nRaw text:", text);
                return null;
            }
        }

        function parseQuickReport(text) {
            try {
                if (!text) return null;

                const normalized = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n');

                const getSection = (regex) => {
                    const match = normalized.match(regex);
                    return match?.[1]?.trim() ?? 'N/A';
                };

                const report = {
                    rating: getSection(/#+\s*1\. AI-Calculated Performance Rating[\s\S]*?\n+([\s\S]*?)(?=\n#+\s*2\.|\n---\n|\n$)/),
                    position: getSection(/#+\s*2\. Likely Position\(s\) & Role[\s\S]*?\n+([\s\S]*?)(?=\n#+\s*3\.|\n---\n|\n$)/),
                    playstyle: getSection(/#+\s*3\. Key Duties & Playstyle[\s\S]*?\n+([\s\S]*?)(?=\n#+\s*4\.|\n---\n|\n$)/),
                    pros: getSection(/#+\s*4\. Key Strengths \(Pros\)[\s\S]*?\n+([\s\S]*?)(?=\n#+\s*5\.|\n---\n|\n$)/),
                    cons: getSection(/#+\s*5\. Key Weaknesses \(Cons\)[\s\S]*?\n+([\s\S]*?)(?=\n#+\s*6\.|\n---\n|\n$)/),
                    similar: getSection(/#+\s*6\. Suggested Similar Player[\s\S]*?\n+([\s\S]*?)(?=\n#+\s*7\.|\n---\n|\n$)/),
                    development: getSection(/#+\s*7\. Suggested Development Plan[\s\S]*?\n+([\s\S]*?)(?=\n---|\n$)/)
                };

                if (Object.values(report).every(val => val === 'N/A')) {
                    throw new Error("All sections parsed as N/A.");
                }

                return report;
            } catch (e) {
                console.error("Failed to parse quick report:", e.message, "\nRaw text:", text);
                return null;
            }
        }

        // --- Opponent Analysis Save/Load ---
        const LS_OPPONENT_KEY = 'savedOpponentAnalyses';

        function getSavedOpponentAnalyses() {
            try {
                return JSON.parse(localStorage.getItem(LS_OPPONENT_KEY)) || [];
            } catch (e) {
                console.error("Could not parse saved analyses:", e);
                return [];
            }
        }

        function saveOpponentAnalysis() {
            const name = opponentName.value.trim();
            const content = analysisOutputOpponent.innerHTML;
            if (!name) {
                showError("Please enter an opponent name to save the analysis.");
                return;
            }
            if (!content || content.includes("Your opposition analysis will appear here")) {
                showError("There is no analysis to save.");
                return;
            }

            try {
                let analyses = getSavedOpponentAnalyses();
                const existingIndex = analyses.findIndex(a => a.name === name);
                
                const analysisData = { name, content, savedAt: new Date().toISOString() };

                if (existingIndex > -1) {
                    // Update existing
                    analyses[existingIndex] = analysisData;
                } else {
                    // Add new
                    analyses.push(analysisData);
                }

                localStorage.setItem(LS_OPPONENT_KEY, JSON.stringify(analyses));
                
                // Show simple feedback
                saveOpponentAnalysisBtn.innerHTML = '<i data-lucide="check" class="h-5 w-5 mr-2"></i>Saved!';
                if (typeof lucide !== 'undefined') lucide.createIcons();
                setTimeout(() => {
                    saveOpponentAnalysisBtn.innerHTML = '<i data-lucide="save" class="h-5 w-5 mr-2"></i>Save';
                    if (typeof lucide !== 'undefined') lucide.createIcons();
                }, 2000);

            } catch (e) {
                console.error("Failed to save analysis to LocalStorage:", e);
                showError("Failed to save analysis. LocalStorage might be full or disabled.");
            }
        }

        function loadOpponentAnalyses() {
            const analyses = getSavedOpponentAnalyses();
            loadOpponentList.innerHTML = ''; // Clear list

            if (analyses.length === 0) {
                loadOpponentList.innerHTML = '<p class="text-slate-400">No saved analyses found.</p>';
                return;
            }

            analyses.sort((a, b) => new Date(b.savedAt) - new Date(a.savedAt)); // Show newest first

            analyses.forEach(analysis => {
                const item = document.createElement('div');
                item.classList.add('flex', 'justify-between', 'items-center', 'p-3', 'bg-slate-700', 'rounded-lg', 'hover:bg-slate-600');
                
                const info = document.createElement('div');
                info.classList.add('flex-1', 'min-w-0'); // Fix for text overflow
                
                const nameEl = document.createElement('p');
                nameEl.classList.add('text-white', 'font-semibold', 'truncate');
                nameEl.textContent = analysis.name;
                info.appendChild(nameEl);
                
                const dateEl = document.createElement('p');
                dateEl.classList.add('text-xs', 'text-slate-400');
                dateEl.textContent = `Saved: ${new Date(analysis.savedAt).toLocaleString()}`;
                info.appendChild(dateEl);
                
                item.appendChild(info);
                
                const buttons = document.createElement('div');
                buttons.classList.add('flex', 'space-x-2', 'ml-2');

                const loadBtn = document.createElement('button');
                loadBtn.classList.add('p-2', 'bg-sky-500', 'hover:bg-sky-600', 'rounded-lg', 'text-white');
                loadBtn.innerHTML = '<i data-lucide="folder-down" class="h-5 w-5"></i>';
                loadBtn.title = `Load "${analysis.name}"`;
                loadBtn.onclick = () => renderOpponentAnalysis(analysis.name);
                buttons.appendChild(loadBtn);

                const deleteBtn = document.createElement('button');
                deleteBtn.classList.add('p-2', 'bg-red-500', 'hover:bg-red-600', 'rounded-lg', 'text-white');
                deleteBtn.innerHTML = '<i data-lucide="trash-2" class="h-5 w-5"></i>';
                deleteBtn.title = `Delete "${analysis.name}"`;
                deleteBtn.onclick = () => deleteOpponentAnalysis(analysis.name);
                buttons.appendChild(deleteBtn);
                
                item.appendChild(buttons);
                loadOpponentList.appendChild(item);
            });
            
            if (typeof lucide !== 'undefined') lucide.createIcons();
            showLoadOpponentModal();
        }

        function renderOpponentAnalysis(name) {
            const analyses = getSavedOpponentAnalyses();
            const analysis = analyses.find(a => a.name === name);
            if (analysis) {
                opponentName.value = analysis.name;
                analysisOutputOpponent.innerHTML = analysis.content;
                closeLoadOpponentModal();
            } else {
                showError("Could not find the saved analysis to load.");
            }
        }

        function deleteOpponentAnalysis(name) {
            try {
                let analyses = getSavedOpponentAnalyses();
                const filteredAnalyses = analyses.filter(a => a.name !== name);
                localStorage.setItem(LS_OPPONENT_KEY, JSON.stringify(filteredAnalyses));
                loadOpponentAnalyses(); // Refresh the list in the modal
            } catch (e) {
                showError("Failed to delete analysis.");
            }
        }


        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            updateWorkflowStage('upload');
            resetAnalysisViews();
            renderAnalysisVisuals();
            Object.values(narrativeBuilders).forEach(builder => {
                if (builder?.script) {
                    builder.script.innerHTML = '<p class="text-xs text-slate-500">Run a report to generate a narrative storyboard.</p>';
                }
            });

            // Set default tab to dashboard
            showTab('dashboard');

            if (floatingGenerateBtn) {
                floatingGenerateBtn.classList.remove('hidden');
                floatingGenerateBtn.addEventListener('click', () => {
                    showTab('singlePlayer');
                    analyzeSinglePlayer();
                });
            }

            // Quick links to tabs
            quickActionButtons.forEach(button => {
                button.addEventListener('click', () => {
                    if (button.dataset.openTab) {
                        showTab(button.dataset.openTab);
                    }
                });
            });

            // Tab navigation
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    showTab(button.dataset.tab);
                });
            });

            // API Key management

            // --- Main Controls ---
            if (analyzeBtn) analyzeBtn.addEventListener('click', analyzeSinglePlayer);
            if (clearBtn) clearBtn.addEventListener('click', clearSinglePlayerInputs);
            if (analysisViewControls) {
                getAnalysisViewButtons().forEach(button => {
                    button.addEventListener('click', () => showAnalysisView(button.dataset.view));
                });
            }
            if (reportTheme) {
                applyReportTheme(reportTheme.value);
                reportTheme.addEventListener('change', () => applyReportTheme(reportTheme.value));
            }
            if (saveReportBtn) saveReportBtn.addEventListener('click', saveCurrentReport);
            if (loadReportBtn) loadReportBtn.addEventListener('click', () => {
                renderSavedReports();
                openReportModal();
            });
            if (openLoadReportModalBtn) {
                openLoadReportModalBtn.addEventListener('click', () => {
                    renderSavedReports();
                    openReportModal();
                });
            }
            if (closeLoadReportModalBtn) closeLoadReportModalBtn.addEventListener('click', closeReportModal);
            if (savedReportsList) {
                savedReportsList.addEventListener('click', (event) => {
                    const loadTarget = event.target.closest('[data-load-report]');
                    if (loadTarget) {
                        loadReportById(loadTarget.dataset.loadReport);
                        return;
                    }
                    const deleteTarget = event.target.closest('[data-delete-report]');
                    if (deleteTarget) {
                        deleteReportById(deleteTarget.dataset.deleteReport);
                    }
                });
            }
            if (savedReportsGrid) {
                savedReportsGrid.addEventListener('click', (event) => {
                    const loadTarget = event.target.closest('[data-load-report]');
                    if (loadTarget) {
                        loadReportById(loadTarget.dataset.loadReport);
                        return;
                    }
                    const deleteTarget = event.target.closest('[data-delete-report]');
                    if (deleteTarget) {
                        deleteReportById(deleteTarget.dataset.deleteReport);
                    }
                });
            }

            Object.entries(narrativeBuilders).forEach(([key, builder]) => {
                if (builder?.generateBtn) {
                    builder.generateBtn.addEventListener('click', () => generateNarrativeVideo(key));
                }
                if (builder?.stopBtn) {
                    builder.stopBtn.addEventListener('click', () => stopNarrativePlayback(key));
                }
            });

            if (typeof window.speechSynthesis !== 'undefined') {
                populateNarrativeVoices();
                window.speechSynthesis.onvoiceschanged = populateNarrativeVoices;
            } else {
                populateNarrativeVoices();
            }

            // Comparison
            if (analyzeCompareBtn) analyzeCompareBtn.addEventListener('click', analyzeComparison);
            if (clearCompareBtn) clearCompareBtn.addEventListener('click', clearCompareInputs);
            // Opposition
            if (analyzeOpponentBtn) analyzeOpponentBtn.addEventListener('click', analyzeOpposition);
            if (clearOpponentBtn) clearOpponentBtn.addEventListener('click', clearOpponentInputs);
            if (saveOpponentAnalysisBtn) saveOpponentAnalysisBtn.addEventListener('click', saveOpponentAnalysis);
            if (loadOpponentAnalysisBtn) loadOpponentAnalysisBtn.addEventListener('click', showLoadOpponentModal);

            // Modals
            if (howToUseBtn) howToUseBtn.addEventListener('click', showHowToUse);
            if (closeHowToUseBtn) closeHowToUseBtn.addEventListener('click', closeHowToUse);
            if (closeErrorBtn) closeErrorBtn.addEventListener('click', closeError);
            if (closeLoadOpponentModalBtn) closeLoadOpponentModalBtn.addEventListener('click', closeLoadOpponentModal);
            if (pdfBtn) pdfBtn.addEventListener('click', () => {
                updateWorkflowStage('download');
                generatePDF();
            });
            if (closePdfPreviewBtn) closePdfPreviewBtn.addEventListener('click', closePdfPreview);
            if (downloadPdfBtn) downloadPdfBtn.addEventListener('click', () => {
                if (generatedPdfBlobUrl) {
                    const link = document.createElement('a');
                    link.href = generatedPdfBlobUrl;
                    link.download = `${playerName.value.trim() || 'player'}_scout_report.pdf`;
                    link.click();
                }
            });

            // Export Buttons
            if (copyBtn) copyBtn.addEventListener('click', copyToClipboard);
            if (videoBtn) videoBtn.addEventListener('click', findVideos);

            // Upload listeners
            setupUploadListeners(dropZoneSingle, fileUploadSingle, imagePreviewSingle, singlePlayerImages);
            if (scanStatsBtn) scanStatsBtn.addEventListener('click', scanStatsFromImage);
            if (visualizeStatsBtn) visualizeStatsBtn.addEventListener('click', visualizeStats);
            if (textStatsSingle) textStatsSingle.addEventListener('input', () => {
                visualizeStatsBtn.disabled = textStatsSingle.value.trim().length === 0;
            });

            setupUploadListeners(dropZoneCompare1, fileUploadCompare1, imagePreviewCompare1, compare1Images);
            setupUploadListeners(dropZoneCompare2, fileUploadCompare2, imagePreviewCompare2, compare2Images);
            setupUploadListeners(dropZoneOpponent, fileUploadOpponent, imagePreviewOpponent, opponentImages);

            // Search Tab
            if (searchButton) searchButton.addEventListener('click', handleSearch);
            if (suggestStatsBtn) suggestStatsBtn.addEventListener('click', suggestStats);
            if (searchPosition) searchPosition.addEventListener('input', () => {
                if (suggestStatsBtn) {
                    suggestStatsBtn.disabled = searchPosition.value.trim().length === 0;
                }
            });
            if (downloadCsvBtn) downloadCsvBtn.addEventListener('click', downloadCSV);

            // Chatbot Tab
            if (chatSendBtn) chatSendBtn.addEventListener('click', handleChat);
            if (chatInput) chatInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    handleChat();
                }
            });
            if (newChatBtn) newChatBtn.addEventListener('click', newChat);

            // Global Paste for Single Player Tab
            document.addEventListener('paste', (e) => {
                if (currentTab !== 'singlePlayer') return;
                const target = e.target;
                if (!target) return;
                const targetTag = target.tagName.toUpperCase();
                if (targetTag === 'INPUT' || targetTag === 'TEXTAREA') return;
                if (target.id === 'dropZoneSingle' || target.closest('#dropZoneSingle')) return;
                handlePaste(e, imagePreviewSingle, singlePlayerImages);
            });

            loadSavedReports();

            // Initialize lucide icons
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }

            // Load jspdf-autotable
            const autoTableScript = document.createElement('script');
            autoTableScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js';
            document.head.appendChild(autoTableScript);
        });

    </script>
</body>
</html>

